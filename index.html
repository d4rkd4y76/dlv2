<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Şampiyonlar Düellosu</title>
    <!-- Comfortaa Font -->
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Kodları */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comfortaa', cursive;
        }

        body {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: backgroundPulse 10s infinite alternate;
        }

        @keyframes backgroundPulse {
            from {
                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            }
            to {
                background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            }
        }

        .container, .game-container, .student-selection-container, .single-player-game-container, .duel-selection-container, .duel-game-container {
            background: white;
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1200px;
            text-align: left;
            transform: scale(0.95);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.5s forwards;
        }

.logout-button {
    background-color: #dc3545; /* Kırmızı renk */
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 10px; /* Köşeleri yuvarla */
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
    font-size: 1.1em;
    margin-top: 20px; /* Üstten boşluk */
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.logout-button:hover {
    background-color: #c82333; /* Hover sırasında biraz daha koyu kırmızı */
    transform: scale(1.05);
    box-shadow: 0 7px 20px rgba(0,0,0,0.2);
}


select {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    border: 2px solid #ff8a00;
    border-radius: 12px;
    padding: 12px;
    font-size: 1.1em;
    color: #333;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease-in-out;
}

.friends-button {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: white;
    padding: 18px;
    border: none;
    border-radius: 12px;
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.student-stats-container {
    position: relative;
    margin-top: 10px; /* Azaltıldı: 20px -> 15px */
    padding: 2px; /* Azaltıldı: 5px -> 3px */
    perspective: 1000px;
}

.student-stats {
    display: flex;
    justify-content: center;
    gap: 6px; /* Azaltıldı: 25px -> 15px */
    padding: 5px; /* Azaltıldı: 15px -> 10px */
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px; /* Azaltıldı: 20px -> 15px */
    backdrop-filter: blur(10px);
    box-shadow: 0 6px 24px 0 rgba(31, 38, 135, 0.37); /* Azaltıldı shadow */
    border: 1px solid rgba(255, 255, 255, 0.18);
    transform-style: preserve-3d;
    animation: floatStats 6s ease-in-out infinite;
}

.stats-item {
    position: relative;
    display: flex;
    align-items: center;
    gap: 4px; /* Azaltıldı: 12px -> 8px */
    padding: 4px 8px; /* Azaltıldı: 12px 20px -> 8px 15px */
    border-radius: 8px; /* Azaltıldı: 16px -> 12px */
    background: rgba(255, 255, 255, 0.05);
    overflow: hidden;
    transition: all 0.3s ease;
}



.stats-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 1;
}

.trophy-glow {
    background: radial-gradient(circle at center,
        rgba(255, 215, 0, 0.3) 0%,
        transparent 70%);
    animation: pulseGold 2s ease-in-out infinite;
}

.diamond-glow {
    background: radial-gradient(circle at center,
        rgba(30, 144, 255, 0.3) 0%,
        transparent 70%);
    animation: pulseBlue 2s ease-in-out infinite;
}

.stats-icon {
    position: relative;
    font-size: 1.1em; /* Azaltıldı: 2em -> 1.3em */
    z-index: 2;
}

.trophy-stats .stats-icon {
    animation: shakeRotate 3s ease-in-out infinite;
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
}

.diamond-stats .stats-icon {
    animation: floatShine 3s ease-in-out infinite;
    filter: drop-shadow(0 0 10px rgba(30, 144, 255, 0.5));
}

.stats-value {
    position: relative;
    font-size: 1em; /* Azaltıldı: 1.6em -> 1.2em */
    font-weight: bold;
    z-index: 2;
}

.trophy-stats .stats-value {
    font-size: 1em;
    background: linear-gradient(45deg, #ffd700, #ff8c00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

.diamond-stats .stats-value {
    background: linear-gradient(45deg, #00bfff, #1e90ff, #4169e1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmerBlue 3s linear infinite;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.stats-item:hover {
    transform: translateY(-3px) scale(1.03); /* Azaltıldı: -5px -> -3px, 1.05 -> 1.03 */
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Azaltıldı: 10px 20px -> 8px 16px */
}

@keyframes floatStats {
    0%, 100% { transform: translateY(0) rotateX(0); }
    50% { transform: translateY(-5px) rotateX(3deg); } /* Azaltıldı: -10px -> -5px, 5deg -> 3deg */
}

@keyframes pulseGold {
    0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.1); } /* Azaltıldı: 1.2 -> 1.1 */
}

@keyframes pulseBlue {
    0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.1); } /* Azaltıldı: 1.2 -> 1.1 */
}

@keyframes shakeRotate {
    0%, 100% { transform: rotate(-3deg); } /* Azaltıldı: -5deg -> -3deg */
    25% { transform: rotate(0deg) scale(1.05); } /* Azaltıldı: 1.1 -> 1.05 */
    50% { transform: rotate(3deg); } /* Azaltıldı: 5deg -> 3deg */
    75% { transform: rotate(0deg) scale(1); }
}

@keyframes floatShine {
    0%, 100% { transform: translateY(0) scale(1); filter: brightness(1); }
    50% { transform: translateY(-3px) scale(1.05); filter: brightness(1.2); } /* Azaltıldı: -5px -> -3px, 1.1 -> 1.05, 1.3 -> 1.2 */
}

@keyframes shimmerGold {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}

@keyframes shimmerBlue {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}

.trophy-stats:hover .trophy-glow {
    animation: pulseGold 1s ease-in-out infinite;
}

.diamond-stats:hover .diamond-glow {
    animation: pulseBlue 1s ease-in-out infinite;
}

/* Hover efektleri için ek parıltılar */
.stats-item::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at center,
        rgba(255, 255, 255, 0.2) 0%,
        transparent 50%);
    transform: rotate(45deg);
    transition: 0.5s;
    opacity: 0;
}

.stats-item:hover::before {
    opacity: 1;
    animation: rotateSweep 1s linear infinite;
}

@keyframes rotateSweep {
    0% { transform: rotate(45deg) translateY(0%); }
    100% { transform: rotate(45deg) translateY(100%); }
}

.friends-button:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, #4f46e5, #4338ca);
}

.friends-container {
    display: none;
    flex-direction: column;
    gap: 25px;
    padding: 30px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
}

.search-section {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.search-box {
    display: flex;
    gap: 10px;
}

.search-box input {
    flex: 1;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1em;
}

#search-button {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0 20px;
    cursor: pointer;
    transition: background 0.3s;
}

.search-results, .friends-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.friend-card {
    display: flex;
    align-items: center;
    padding: 15px;
    background: #f3f4f6;
    border-radius: 10px;
    gap: 15px;
}

.player-item {
    display: flex;
    align-items: center;
    gap: 15px;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.player-photo {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ff8a00;
}

.player-name {
    flex: 1;
    font-size: 1em;
    font-weight: bold;
    color: #333;
}

.davet-et-button, .oyunda-button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-size: 0.9em;
}

.davet-et-button {
    background-color: #17a2b8;
    color: white;
}

.davet-et-button:hover {
    background-color: #138496;
}

.oyunda-button {
    background-color: #f59e0b;
    color: white;
    cursor: not-allowed;
    opacity: 0.7;
}

.oyunda-button:hover {
    background-color: #d97706;
    opacity: 0.7;
}


.friend-photo {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}

.friend-info {
    flex: 1;
}

.friend-name {
    font-weight: bold;
    color: #111827;
}

.friend-class {
    color: #6b7280;
    font-size: 0.9em;
}

.add-friend-button {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.add-friend-button:hover {
    background: #059669;
    transform: scale(1.05);
}

.friend-status {
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.9em;
}

.status-offline {
    background: #e5e7eb;
    color: #374151;
}

.status-online {
    background: #dcfce7;
    color: #166534;
}



.status-in-game {
    background: #fee2e2;
    color: #991b1b;
}

/* Hover ve odaklanma efekti */
select:hover, select:focus {
    background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
    border-color: #f7786b;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    outline: none;
}

option {
    background-color: white;
    color: #333;
    padding: 10px;
    font-size: 1em;
    font-family: 'Comfortaa', sans-serif;
}


        @keyframes fadeInUp {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

#main-screen {
    display: flex;
    flex-direction: column; /* İçeriği dikey hizalar */
    align-items: center; /* Yatayda ortalar */
    justify-content: center; /* Dikeyde ortalar */
    gap: 20px; /* Elemanlar arasındaki boşluk */
    position: relative; /* Efektler için gerekli */
    padding: 30px;
    width: 950%; /* Genişlik (ekranın %80'i) */
    max-width: 1400px; /* Maksimum genişlik */
    min-height: 300px; /* Minimum yükseklik */
    background: url('https://i.ibb.co/2FVVr25/Yeni-proje-2.gif') center center;
    background-size: cover;
    background-repeat: no-repeat;
    border: 5px solid transparent;z
    border-radius: 20px; /* Köşe yuvarlama */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* Yumuşak gölge */
    overflow: hidden; /* Taşmaları gizler */
    z-index: 1; /* Diğer elemanlarla çakışmayı önler */
}

/* Hareketli ışık efekti */
#main-screen::before {
    /* Bu bloğu tamamen kaldırabilir veya şu şekilde değiştirebilirsiniz: */
    content: '';
    position: absolute;
    top: -20%;
    left: -150%;
    width: 300%;
    height: 200%;
    background: none; /* linear-gradient yerine none kullanarak efekti kaldırıyoruz */
    animation: none; /* Animasyonu da kaldırıyoruz */
    z-index: 0;
    pointer-events: none;
}

/* Çerçeve parlaması */
@keyframes glowingBorder {
    0% {
        box-shadow: 0 0 5px #ff8a00, 0 0 10px #ff8a00;
    }
    50% {
        box-shadow: 0 0 15px #fbc2eb, 0 0 20px #fbc2eb;
    }
    100% {
        box-shadow: 0 0 5px #a6c1ee, 0 0 10px #a6c1ee;
    }
}

@keyframes lightMove {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(100%);
    }
}

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .student-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40%;
            animation: bounceIn 1s;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .student-photo {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #ff8a00;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }

        .student-photo:hover {
            transform: rotate(360deg);
        }

        .student-name {
            font-size: 1em;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px #ff8a00;
        }

        .student-cup {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
            animation: popIn 0.5s;
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

.game-cup-image {
    width: 40px;
    height: 40px;
    margin-bottom: 5px;
    transform-origin: center;
    animation: trophyBounce 2s infinite;
}

@keyframes trophyGlow {
    from {
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }
    to {
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
    }
}

@keyframes trophyBounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

.trophy-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin: 10px auto;
    padding: 0 15px;
    max-width: 300px;
}

.trophy-inner {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.trophy {
    font-size: 1.5em;
    opacity: 0;
    transform: translateY(20px);
}

@keyframes trophyEntry {
    0% {
        opacity: 0;
        transform: translateY(50px) scale(0.5);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}


        @keyframes rotateCup {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

.game-cup-score {
    font-size: 1.5em;
    font-weight: bold;
    background: linear-gradient(45deg, #ffd700, #ff8c00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
}

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 55%;
            align-items: flex-start;
            animation: slideButtons 0.7s ease forwards;
        }

        @keyframes slideButtons {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

.buttons {
    display: flex; /* Flexbox düzeni */
    flex-direction: column; /* Butonları dikey hizalar */
    align-items: stretch; /* Butonları çerçeveye tam yayar */
    justify-content: center; /* Butonlar arasında eşit hizalama */
    gap: 20px; /* Butonlar arasında dikey boşluk */
    padding: 10px; /* Çerçeve içi boşluk */
    width: 100%; /* Çerçeve genişliği */
    max-width: 900px; /* Maksimum genişlik */
    margin: 0 auto; /* Ortalamak için */
    box-sizing: border-box; /* Padding ve border dahil */
}

.buttons button {
    /* Mevcut özellikleri koru */
    width: 100%;
    padding: 18px;
    border: none;
    border-radius: 12px;
    font-size: 1.1em;
    cursor: pointer;
    transition: transform 0.2s, opacity 0.2s, box-shadow 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;

    /* Yeni metin geliştirmeleri */
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    letter-spacing: 0.5px;
    font-weight: 600;
}

.offline-button {
    background-color: #808080;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: not-allowed;
    opacity: 0.7;
    font-size: 0.9em;
}

.student-diamond {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 10px;
    animation: diamondGlow 3s infinite alternate;
}

.diamond-count {
    font-size: 1.3em;
    font-weight: bold;
    color: #1e90ff;
    text-shadow: 0 0 1px #1e90ff;
    animation: diamondPulse 2.5s infinite alternate;
}

@keyframes diamondGlow {
    from {
        filter: drop-shadow(0 0 2px #1e90ff);
    }
    to {
        filter: drop-shadow(0 0 8px #1e90ff);
    }
}

@keyframes diamondPulse {
    from {
        transform: scale(1);
    }
    to {
        transform: scale(1.1);
    }
}

.buttons button::before {
    content: '';
    position: absolute;
    width: 200%;
    height: 200%;
    background: rgba(255, 255, 255, 0.2);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(45deg);
    transition: all 0.5s;
}

.buttons button:hover::before {
    width: 0%;
    height: 0%;
    opacity: 0;
}

.buttons button:hover {
    transform: scale(1.05);
    opacity: 0.9;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.single-player {
    background: linear-gradient(135deg, #ff6f61, #ff9a9e);
    color: white;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}


.friend-added-button {
    background-color: #808080;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: not-allowed;
    opacity: 0.7;
    font-size: 0.9em;
}

.add-friend-button {
    background-color: #28a745;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-size: 0.9em;
}

.add-friend-button:hover {
    background-color: #218838;
    transform: scale(1.05);
}

.kupa-siralama-button {
    background-color: #f7cac9;
    color: black !important;
    background-image: linear-gradient(135deg, #edf500, #8ff514);
    box-shadow: 0 0 15px rgba(247, 202, 201, 0.7);
    position: relative;
    overflow: hidden;
}

.kupa-siralama-button::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: rgba(247, 202, 201, 0.2);
    transform: rotate(45deg);
    animation: shine 3s infinite;
}


        @keyframes shine {
            0% {
                transform: rotate(45deg) translate(-100%, -100%);
            }
            100% {
                transform: rotate(45deg) translate(100%, 100%);
            }
        }

        .game-container, .student-selection-container, .single-player-game-container, .duel-selection-container, .duel-game-container {
            display: none;
            flex-direction: column;
            gap: 15px;
            animation: fadeIn 0.5s forwards;
        }

        .table-section {
            background-color: #fff3e0;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            text-align: left;
        }

        .table-section h3 {
            margin-bottom: 15px;
            color: #ff8a00;
            font-size: 1.0em;
            border-bottom: 2px solid #ff8a00;
            padding-bottom: 5px;
        }

        .table-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .table-section select, .table-section input {
            width: 100%;
            padding: 14px 20px;
            margin-bottom: 20px;
            border: 2px solid #ff8a00;
            border-radius: 8px;
            font-size: 1.2em;
            color: #333;
            background-color: #fff;
            transition: border-color 0.3s;
        }

        .table-section select:focus, .table-section input:focus {
            border-color: #f7786b;
            outline: none;
        }

        .back-button, .start-game-button, .login-button, .duel-start-button, .ranking-back-button, .close-ranking-button {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            font-size: 1.1em;
            margin-top: 25px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .back-button, .ranking-back-button, .close-ranking-button {
            background-color: #555;
            color: white;
            width: 100%;
            max-width: 220px;
        }

        .back-button:hover, .ranking-back-button:hover, .close-ranking-button:hover {
            background-color: #333;
            transform: scale(1.05);
        }

        .start-game-button, .duel-start-button {
            background-color: #28a745;
            color: white;
            opacity: 0.7;
            cursor: not-allowed;
            width: 100%;
            max-width: 220px;
        }

        .start-game-button.active, .duel-start-button.active {
            opacity: 1;
            cursor: pointer;
        }

        .start-game-button:hover.active, .duel-start-button:hover.active {
            transform: scale(1.05);
        }

        .login-button {
            background-color: #007BFF;
            color: white;
            opacity: 0.7;
            cursor: not-allowed;
            width: 100%;
            max-width: 220px;
            transition: opacity 0.3s;
        }

        .login-button.active {
            opacity: 1;
            cursor: pointer;
        }

        .login-button:hover.active {
            transform: scale(1.05);
        }

        .error {
            color: red;
            margin-top: 15px;
            text-align: center;
            font-size: 1.1em;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

.single-player-game-container, .duel-game-container {
    display: none; /* Bu konteyner başlangıçta görünmez */
    flex-direction: column; /* İçerikleri dikey olarak hizalar */
    gap: 25px; /* İçerikler arasındaki boşluk 25 piksel */
    width: 100%; /* Konteyner genişliği ekranın tamamını kaplar */
    max-width: none; /* Genişlik sınırı yok */
    justify-content: center; /* İçerikleri dikeyde ortalar */
    align-items: center; /* İçerikleri yatayda ortalar */
    padding: 30px; /* Kenar boşlukları (çerçevenin içindeki içeriklerin etrafındaki boşluk) */
    animation: fadeIn 0.5s forwards; /* Görünür hale geldiğinde fadeIn animasyonu oynar */
}


        .question-number {
            margin-bottom: 15px;
            font-size: 1.0em;
            color: #555;
            font-weight: bold;
        }

        .progress-container {
            width: 100%;
            max-width: 900px;
            margin-bottom: 1px;
        }

        .progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            height: 25px;
        }

        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background-color: #28a745;
            transition: width 0.4s ease;
        }

        .timer-container {
            margin-bottom: 1px;
        }

        .timer {
            font-size: 1.0em;
            color: #ff0000;
            font-weight: bold;
            animation: pulseTimer 1.5s infinite;
        }

        @keyframes pulseTimer {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .question-container {
    display: flex;
    flex-direction: column; /* Dikey hizalama */
    align-items: center; /* Yatayda ortalama */
    justify-content: center; /* Dikeyde ortalama */
    width: 100%; /* Çerçevenin genişliği */
    max-width: 700px; /* Maksimum genişlik azaltıldı */
    text-align: center; /* Metni ortala */
    min-height: 300px; /* Çerçeve yüksekliği azaltıldı */
    padding: 15px; /* Daha az boşluk */
    border: 2px solid #ff8a00; /* Çerçeve kalınlığı azaltıldı */
    border-radius: 10px; /* Köşe yuvarlama küçültüldü */
    background-color: #fffbea;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Gölge küçültüldü */
    overflow: hidden; /* Çerçeve dışına taşmaları gizle */
}

        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .question-image {
    max-width: 100%; /* Resmin genişliği çerçeveye sığacak şekilde */
    max-height: 60%; /* Resmin yüksekliğini sınırla */
    object-fit: contain; /* Resmin orantılı şekilde sığmasını sağla */
    margin: 0 auto; /* Resmi yatayda ortala */
    display: block; /* Blok element olarak davranır */
}

        @keyframes fadeInImage {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .question-text {
    font-size: 1.1em; /* Soru metni boyutunu ayarla */
    font-weight: bold;
    margin-bottom: 10px; /* Resim ile metin arasında boşluk */
    word-wrap: break-word; /* Uzun kelimeleri kır */
    text-align: center; /* Metni ortala */
    max-width: 100%; /* Çerçeve sınırları içinde kalmasını sağla */
}

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .options-container {
            display: flex;
            gap: 20px;
            flex-direction: row;
            justify-content: center;
            width: 100%;
            max-width: 900px;
            flex-wrap: wrap; 
            animation: fadeInOptions 0.5s;
        }

        @keyframes fadeInOptions {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .option-button {
            padding: 10px 15px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s, opacity 0.3s;
            flex: 1 1 30%;
            min-width: 160px;
            max-width: 350px;
            font-size: 1.0em;
            margin: 3px 2;
            white-space: normal;
            word-wrap: break-word;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .option-button::after {
            content: '';
            position: absolute;
            width: 300%;
            height: 300%;
            background: rgba(255, 255, 255, 0.2);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            transition: all 0.5s;
        }

        .option-button:hover::after {
            width: 0%;
            height: 0%;
            opacity: 0;
        }

        .option-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
            opacity: 0.95;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .option-button.correct {
            background-color: #28a745 !important;
            animation: pulseCorrect 0.5s;
        }

        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .option-button.wrong {
            background-color: #dc3545 !important;
            animation: shakeWrong 0.5s;
        }

        @keyframes shakeWrong {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .option-chosen {
            border: 4px solid #ff8a00;
            box-shadow: 0 0 15px rgba(255,138,0,0.5);
        }

        .option-faded {
            opacity: 0.5;
        }

        .score-container {
            font-size: 2em;
            color: #333;
            text-align: center;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            animation: fadeInScore 0.5s;
        }

        @keyframes fadeInScore {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

.score-message {
    font-size: 1.1em; /* Yazı boyutunu çerçeveye uygun olacak şekilde ayarlayın */
    font-weight: bold;
    margin-top: 25px;
    animation: glow 1.5s infinite alternate;
    text-align: center; /* Metni ortala */
    max-width: 90%; /* Çerçevenin genişliğine uygun olacak şekilde sınırla */
    white-space: normal; /* Alt satıra geçmesini sağla */
    word-wrap: break-word; /* Uzun kelimeleri kırarak alt satıra geçir */
    overflow: visible; /* Çerçeve dışına taşmayı engelle */
    margin: 0 auto; /* Yatayda ortala */
    line-height: 1.2; /* Satırlar arasındaki mesafeyi ayarla */
}

        .score-message.blue {
            color: #007BFF;
        }

        .score-message.green {
            color: #28a745;
        }

        .score-message.purple {
            color: #6f42c1;
            text-shadow: 0 0 15px #6f42c1, 0 0 25px #6f42c1, 0 0 35px #6f42c1;
            animation: glowMukemmel 1.5s infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
            }
            to {
                text-shadow: 0 0 25px rgba(0, 123, 255, 1);
            }
        }

        @keyframes glowMukemmel {
            from {
                text-shadow: 0 0 15px rgba(111, 66, 193, 0.5);
            }
            to {
                text-shadow: 0 0 25px rgba(111, 66, 193, 1), 0 0 35px rgba(111, 66, 193, 0.7);
            }
        }

        .final-image {
            width: 220px;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeInImage 1s;
        }

        /* Yeni Eklenen Stil: End Game Button (Geri Dön) */
        .end-game-button {
            background-color: #007BFF; /* Mavi renk */
            color: white;
            padding: 8px 17px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 0.8em;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .end-game-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.2);
        }

        /* Yeni +1 Efekti */
        .animated-plus-one {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8em;
            color: #28a745;
            pointer-events: none;
            z-index: 1000;
            opacity: 1;
            animation: plusOneMove 1s forwards;
        }

        @keyframes plusOneMove {
            0% {
                opacity:1;
                transform: translate(-50%, -50%) translate(0px, 0px) scale(1);
            }
            100% {
                opacity:0;
                transform: translate(-50%, -50%) translate(300px, -300px) scale(0.5);
            }
        }

        /* "Oyunda" Butonu İçin Ek Stil */
        .oyunda-button {
            background-color: #f59e0b; /* Turuncu renk */
            border: none;
            border-radius: 6px;
            color: white;
            padding: 8px 14px;
            font-size: 1em;
            cursor: not-allowed;
            opacity: 0.7;
            transition: background-color 0.3s;
        }

        .oyunda-button:hover {
            background-color: #d97706;
            opacity: 0.7; /* Hover etkisini kaldırmak için */
            transform: none;
        }

        /* Alert, Prompt, Invitation Modals */
        .alert-overlay, .prompt-overlay, .invitation-overlay {
            position: fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items:center;
            justify-content:center;
            z-index:1000000;
            animation: fadeInModal 0.3s;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .alert-content, .prompt-content, .invitation-content {
            background:#fff;
            padding:25px;
            border-radius:15px;
            width:90%;
            max-width:350px;
            box-shadow:0 10px 25px rgba(0,0,0,0.3);
            display:flex;
            flex-direction: column;
            gap:20px;
            animation: slideDownModal 0.3s;
        }

        @keyframes slideDownModal {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-message, .prompt-message, .invitation-message {
            font-size:1.2em;
            color:#333;
            text-align: center;
        }

        .alert-ok-button, .prompt-ok-button, .prompt-cancel-button, .invitation-accept-button, .invitation-decline-button {
            background-color: #007BFF;
            color:white;
            border:none;
            border-radius:8px;
            padding:12px 25px;
            cursor:pointer;
            transition: background-color 0.3s;
            font-size:1em;
            font-weight: bold;
        }

        .alert-ok-button:hover, .prompt-ok-button:hover, .prompt-cancel-button:hover, .invitation-accept-button:hover, .invitation-decline-button:hover {
            background-color: #0056b3;
        }

        .prompt-input {
            width:100%;
            padding:12px;
            border:2px solid #ff8a00;
            border-radius:8px;
            font-size:1.1em;
            transition: border-color 0.3s;
        }

        .prompt-input:focus {
            border-color: #f7786b;
            outline: none;
        }

        .prompt-buttons, .invitation-buttons {
            display:flex;
            justify-content: space-between;
            gap: 10px;
        }

        .prompt-cancel-button, .invitation-decline-button {
            background-color:#dc3545;
        }

        .prompt-cancel-button:hover, .invitation-decline-button:hover {
            background-color:#c82333;
        }

        /* Düello Seçim Ekranı */
.duel-selection-container {
    display: none;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    max-width: 1200px;
    background: white;
    padding: 30px 40px;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    margin: auto;
    position: relative;
    z-index: 1000;
}

        /* İki oyuncuyu eşit orantıda yerleştirmek için space-evenly kullandık */
.duel-bottom-info {
    display: flex;
    justify-content: space-evenly; /* Kartlar arasında eşit boşluk */
    align-items: center; /* Kartları yatayda ortala */
    width: 100%; /* Genişlik tüm alanı kaplasın */
    padding: 10px 0; /* Üst ve alt boşluk */
}


.duel-player-info {
    display: flex;
    flex-direction: column; /* Resim ve ismi dikey hizalar */
    align-items: center; /* Yatayda ortalar */
    justify-content: center; /* Dikeyde ortalar */
    text-align: center; /* Yazıyı ortala */
    gap: 10px; /* Resim ile isim arasındaki boşluk */
    width: 100%; /* Kartın genişliği */
}

.duel-player-photo {
    width: 80px; /* Resim genişliği */
    height: 80px; /* Resim yüksekliği */
    border-radius: 50%; /* Yuvarlak resim */
    object-fit: cover; /* Resmi çerçeveye sığdır */
    border: 3px solid #ff8a00; /* Çerçeve rengi */
    margin-bottom: 5px; /* Resim ile isim arasındaki boşluk */
}


.duel-player-photo:hover {
    transform: rotate(360deg);
}

.duel-player-name {
    font-size: 1em; /* Yazı boyutu */
    font-weight: bold; /* Yazı kalınlığı */
    color: #333; /* Yazı rengi */
    text-align: center; /* Yazıyı ortala */
    white-space: normal; /* Yazının satır kaydırmasını etkinleştir */
    word-wrap: break-word; /* Uzun kelimeleri kaydır */
    overflow-wrap: break-word; /* Modern tarayıcı desteği */
    max-width: 100%; /* Çerçeve sınırında kal */
    line-height: 1.2; /* Satırlar arası boşluğu azalt */
}



        .duel-controls {
            display:flex;
            flex-direction: column;
            gap:15px;
            align-items:center;
            justify-content:center;
            margin-top:30px;
        }

        .duel-start-button {
            display:inline-block;
            margin:0 auto;
            background-color: #28a745;
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            cursor: not-allowed;
            opacity: 0.7;
            transition: background-color 0.3s, transform 0.3s, opacity 0.3s;
            font-size:1.1em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .duel-start-button.active {
            cursor: pointer;
            opacity: 1;
        }

        .duel-start-button:hover.active {
            transform: scale(1.05);
            background-color: #218838;
        }

        .duel-game-container {
            display: none;
            flex-direction: column;
            gap: 5px;
            width: 100%;
            max-width: none;
            justify-content: center;
            align-items: center;
            padding: 30px;
            animation: fadeIn 0.5s forwards;
        }

        .players-info-row {
            display: flex;
            width: 100%;
            max-width: 900px;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            animation: slideInPlayers 0.5s forwards;
        }

        @keyframes slideInPlayers {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .duel-player-score {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
            overflow:hidden;
            position: relative;
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .duel-player-score img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #ff8a00;
            object-fit: cover;
            margin-bottom: 10px;
        }

.duel-player-score .duel-player-name {
    font-size: 0.8em; /* Yazı boyutunu biraz küçültebilirsiniz */
    font-weight: bold;
    color: #333;
    white-space: normal; /* Uzun metinlerin satır atlamasına izin verir */
    word-wrap: break-word; /* Uzun kelimelerin uygun yerlerde kırılmasını sağlar */
    text-align: center; /* Metni ortalar */
    overflow: hidden; /* Çerçevenin dışına taşmayı engeller */
    text-shadow: 1px 1px #ff8a00;
    max-width: 150px; /* Çerçevenin genişliğine göre uyarlanır */
    display: -webkit-box; /* Çok satırlı metni sınırlamak için */
    -webkit-line-clamp: 2; /* Maksimum 2 satır göster */
    -webkit-box-orient: vertical;
}

        .duel-player-correct-count {
            font-size: 1.5em;
            margin-top: 8px;
            color: #28a745;
            font-weight: bold;
            transition: transform 0.3s ease;
            animation: bounceCount 0.6s;
        }

        @keyframes bounceCount {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

.winner-message {
    font-size: 1.2em;
    font-weight: 900;
    background: linear-gradient(45deg, #FFD700, #FFA500);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: winnerEntry 1s forwards, winnerGlow 2s infinite alternate;
    text-align: center;
    margin: 15px 0;
    padding: 0 10px;
    max-width: 100%;
    word-wrap: break-word;
}

@keyframes winnerEntry {
    0% {
        opacity: 0;
        transform: scale(0.5) translateY(-20px);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}


@keyframes winnerGlow {
    from { text-shadow: 0 0 5px gold; }
    to { text-shadow: 0 0 10px gold; }
}

@media (max-width: 480px) {
    .winner-message {
        font-size: 1.2em;
    }
    
    .trophy {
        font-size: 1.1em;
    }
    
    .trophy-container {
        gap: 8px;
        max-width: 250px;
    }
}


        .score-flash {
            animation: scoreFlash 0.8s ease;
        }

        @keyframes scoreFlash {
            0% {transform: scale(1) rotate(0deg); color:#28a745;}
            30% {transform: scale(1.5) rotate(10deg); color:#28a745;}
            60% {transform: scale(1.3) rotate(-10deg); color:#28a745;}
            100% {transform: scale(1) rotate(0deg); color:#28a745;}
        }

        /* Oyundakiler Modal */
        .players-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.6);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:1000000;
            animation: fadeInModal 0.3s;
        }

        .players-content {
            background:#fff;
            padding:30px;
            border-radius:15px;
            width:90%;
            max-width:450px;
            box-shadow:0 10px 25px rgba(0,0,0,0.3);
            display:flex;
            flex-direction:column;
            gap:25px;
            animation: slideDownModal 0.3s;
        }

        .players-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .players-header h3 {
            margin:0;
            font-size:1.8em;
            color:#ff8a00;
            text-shadow: 1px 1px #f7786b;
        }

        .players-close {
            background: none;
            border:none;
            font-size:1.5em;
            cursor:pointer;
            color:#ff6f61;
            transition: color 0.3s;
        }

        .players-close:hover {
            color:#e63946;
        }

        .players-list {
            list-style:none;
            padding:0;
            margin:0;
            display:flex;
            flex-direction:column;
            gap:15px;
        }

        .players-list li {
            display:flex;
            align-items:center;
            gap:15px;
            background:#f0f0f0;
            padding:12px;
            border-radius:8px;
            justify-content: space-between;
            transition: background-color 0.3s;
        }

        .players-list li:hover {
            background-color: #e0e0e0;
        }

        .players-list img {
            width:50px;
            height:50px;
            border-radius:50%;
            object-fit:cover;
            border:3px solid #ff8a00;
        }

        .players-list .player-name {
            font-size:1.1em;
            color:#333;
            flex:1;
            text-shadow: 1px 1px #ff8a00;
        }

        /* Yeni Eklenen Stil: Ranking Panel (Yan Panel) */
.ranking-panel {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background: linear-gradient(135deg, #ffffff, #f0f0f0);
   z-index: 9999;
   padding: 20px;
   animation: slideIn 0.3s ease-out;
   display: flex;
   flex-direction: column;
   overflow: hidden;
}

@keyframes slideIn {
   0% {
       transform: translateX(100%);
       opacity: 0;
   }
   100% {
       transform: translateX(0);
       opacity: 1;
   }
}

                /* Açma Butonu */
        .open-ranking-button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            background-color: #4e54c8;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .open-ranking-button:hover {
            background-color: #8f94fb;
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.3);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease;
            z-index: 999;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Ranking Panel */
        .ranking-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 400px;
            height: 100%;
            background: #ffffff;
            box-shadow: -2px 0 15px rgba(0, 0, 0, 0.3);
            transition: right 0.5s ease;
            z-index: 1000;
            border-radius: 0 20px 20px 0;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .ranking-panel.open {
            right: 0;
        }

        /* Ranking Panel Header */
.ranking-panel h2 {
   text-align: center;
   font-size: 2.2rem;
   font-weight: bold;
   margin: 0 0 25px 0;
   background: linear-gradient(45deg, #4338ca, #6366f1, #4338ca);
   background-size: 200% auto;
   color: transparent;
   -webkit-background-clip: text;
   background-clip: text;
   animation: titleGradient 3s ease infinite,
              titlePulse 2s ease infinite;
   padding: 10px;
   position: relative;
   text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.ranking-panel h2::after {
   content: '';
   position: absolute;
   bottom: 0;
   left: 50%;
   transform: translateX(-50%);
   width: 150px;
   height: 3px;
   background: linear-gradient(90deg, transparent, #4338ca, transparent);
   animation: underlineAnim 2s ease infinite;
}


@keyframes titleGradient {
   0% { background-position: 0% 50%; }
   50% { background-position: 100% 50%; }
   100% { background-position: 0% 50%; }
}

@keyframes titlePulse {
   0%, 100% { transform: scale(1); }
   50% { transform: scale(1.02); }
}

@keyframes underlineAnim {
   0%, 100% { width: 150px; opacity: 0.5; }
   50% { width: 200px; opacity: 1; }
}


@media (max-width: 768px) {
   .ranking-panel h2 {
       font-size: 1.8rem;
   }
}

@keyframes fadeIn {
   from { opacity: 0; }
   to { opacity: 1; }
}

@media (max-width: 768px) {
   .ranking-panel {
       padding: 15px;
   }
   
   .ranking-table th,
   .ranking-table td {
       padding: 10px;
       font-size: 0.9rem;
   }
   
   .user-ranking-stats {
       padding: 12px;
       font-size: 0.9rem;
   }
}


        /* Geri Dön Butonu */
        .ranking-back-button {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            background-color: #555;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
            font-size: 1.1em;
            margin-top: auto;
            align-self: center;
            width: 100%;
            max-width: 220px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .ranking-back-button:hover {
            background-color: #333;
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.3);
        }

        /* Ranking Table Container */
.ranking-table-container {
   flex: 1;
   overflow-y: auto;
   margin: 15px 0;
   padding: 10px;
   border-radius: 15px;
   background: rgba(255,255,255,0.9);
   box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

        /* Ranking Table */
.ranking-table {
   width: 100%;
   border-collapse: separate;
   border-spacing: 0 8px;
}

        /* Float Animation */
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Table Header */
        .ranking-table th {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: #000;
            font-weight: bold;
            padding: 15px;
            text-align: center;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            animation: slideIn 0.8s ease forwards;
        }

        /* Slide In Animation */
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .ranking-table th::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255,255,255,0.3), rgba(255,255,255,0));
            animation: shimmer 2s infinite;
        }

        /* Shimmer Animation */
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        /* Table Data */
        .ranking-table td {
            padding: 15px;
            text-align: center;
            color: #333;
            transition: background 0.3s, color 0.3s, transform 0.3s;
            font-weight: 500;
        }

        /* Row Hover Effect */
        .ranking-table tr:hover td {
            background: #ff8a00;
            color: white;
            transform: scale(1.02);
            cursor: pointer;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        /* Player Photo */
        .ranking-player-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #ff8a00;
            transition: transform 0.3s;
        }

        .ranking-player-photo:hover {
            transform: scale(1.1);
        }

        /* Top 3 Rows */
        .ranking-table tr.top-1 td,
        .ranking-table tr.top-2 td,
        .ranking-table tr.top-3 td {
            color: white;
            font-weight: bold;
            animation: glow 2s infinite alternate;
        }

        .ranking-table tr.top-1 td {
            background: linear-gradient(135deg, #FFD700, #FFA500); /* Altın */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }

        .ranking-table tr.top-2 td {
            background: linear-gradient(135deg, #C0C0C0, #A9A9A9); /* Gümüş */
            box-shadow: 0 0 15px rgba(192, 192, 192, 0.6);
        }

        .ranking-table tr.top-3 td {
            background: linear-gradient(135deg, #CD7F32, #8B4513); /* Bronz */
            box-shadow: 0 0 15px rgba(205, 127, 50, 0.6);
        }

        /* Glow Animation */
        @keyframes glow {
            from {
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            }
            to {
                box-shadow: 0 0 20px rgba(255, 255, 255, 1);
            }
        }

        /* Fade In Animasyonları */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .ranking-panel {
                width: 100%;
                border-radius: 0;
            }

.ranking-table th,
.ranking-table td {
    padding: 12px;
    text-align: left;
}


.ranking-table tr {
   background: white;
   border-radius: 10px;
   box-shadow: 0 2px 8px rgba(0,0,0,0.05);
   transition: all 0.2s ease;
}

.ranking-table tr:hover {
   transform: translateY(-2px);
   box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}


            .ranking-player-photo {
                width: 40px;
                height: 40px;
            }

            .open-ranking-button, .ranking-back-button {
                padding: 10px 20px;
                font-size: 1rem;
                max-width: 180px;
            }

            .ranking-table-container {
                padding: 10px;
            }
        }

.find-duel-button {
    background: linear-gradient(45deg, #ff4e50, #f9d423);
    color: white;
    padding: 15px 30px;
    border: none;
    border-radius: 15px;
    font-size: 1.2em;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(255, 78, 80, 0.4);
}

.find-duel-button .button-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    position: relative;
    z-index: 1;
}

.find-duel-button .duel-icon {
    font-size: 1.4em;
    animation: swordsSway 2s infinite;
}

.button-glow {
    display: none; /* Dönen efekti kaldır */
}

@keyframes swordsSway {
    0% { transform: rotate(-15deg); }
    50% { transform: rotate(15deg); }
    100% { transform: rotate(-15deg); }
}

@keyframes glowRotate {
    0% { transform: none; }
    100% { transform: none; }
}

/* Arama ekranı için stil */
.matchmaking-screen {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

.friend-added-text {
    display: inline-block;
    font-size: 0.9em;
    background-color: #e9ecef;
    color: #495057;
    border-radius: 6px;
    padding: 8px 14px;
}

.matchmaking-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 400px;
    width: 90%;
}

.searching-animation {
    width: 100px;
    height: 100px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #ff4e50;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

















/* Eşleştirme Ekranı Ana Stili */
.matchmaking-screen {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-in-out;
}

.matchmaking-content {
    background: linear-gradient(145deg, #ffffff, #f0f0f0);
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: slideIn 0.5s ease-out;
}

/* Başlık Stili */
.matchmaking-content h2 {
    color: #333;
    margin-bottom: 20px;
    font-size: 1.8em;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

/* Arama Animasyonu */
.searching-animation {
    width: 80px;
    height: 80px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #ff4e50;
    border-radius: 50%;
    margin: 20px auto;
    animation: spin 1s linear infinite;
}

/* Oyuncu Listesi */
.available-players {
    margin-top: 30px;
    max-height: 300px;
    overflow-y: auto;
}

.player-item {
    display: flex;
    align-items: center;
    padding: 15px;
    margin: 10px 0;
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
    transition: transform 0.3s ease;
}

.player-item:hover {
    transform: scale(1.02);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}





/* İptal Butonu */
.cancel-search-button {
    margin-top: 20px;
    padding: 12px 25px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.cancel-search-button:hover {
    background: #c82333;
    transform: scale(1.05);
}

/* Animasyonlar */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        transform: translateY(-50px);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
















.duel-request-button {
    background: linear-gradient(45deg, #ff4e50, #f9d423);
    color: white;
    border: none;
    padding: 8px 8px;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    font-size: 16px; /* İsteğe bağlı: Buton metin boyutu */
}

/* Buton Üzerine Gelindiğinde Genel Efektler */
.duel-request-button:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

/* Duel İkonu (İçerik) */
.duel-icon {
    display: inline-block;
    transition: transform 0.3s ease, filter 0.3s ease;
    font-size: 20px; /* İsteğe bağlı: İkon boyutu */
}



/* Hover Durumunda Duel İkonu Efektleri */
.duel-request-button:hover .duel-icon {
    transform: rotate(360deg) scale(1.3);
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
}

/* Hover Durumunda Buton Metni Renk Değişikliği */
.duel-request-button:hover .button-text {
    color: #ffe066;
}

/* Dalgalanan Metin Efekti */
@keyframes wave {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}

/* Animasyonlu Arka Plan Parıltı Efekti */
@keyframes shine {
    0% {
        transform: translateX(-100%) skewX(-20deg);
    }
    50% {
        transform: translateX(100%) skewX(-20deg);
    }
    100% {
        transform: translateX(100%) skewX(-20deg);
    }
}

/* ::before Pseudo-Elementi ile Ek Dalga Efekti */
.duel-request-button::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: rgba(255, 255, 255, 0.1);
    transform: rotate(45deg) scale(0);
    transition: transform 0.5s ease;
    pointer-events: none;
}

/* Hover Durumunda ::before Efekti */
.duel-request-button:hover::before {
    transform: rotate(45deg) scale(1);
}

/* ::after Pseudo-Elementi ile Shine Efekti */
.duel-request-button::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        120deg,
        rgba(255, 255, 255, 0.2) 0%,
        rgba(255, 255, 255, 0.5) 50%,
        rgba(255, 255, 255, 0.2) 100%
    );
    transform: translateX(-100%) skewX(-20deg);
    animation: shine 2s infinite;
    pointer-events: none;
    border-radius: 8px;
}












.countdown-container {
    position: absolute;
    top: 15px; /* Küçültüldü */
    right: 15px; /* Küçültüldü */
    z-index: 100;
}

.countdown {
    font-size: 1.8em; /* Font boyutu küçültüldü */
    font-weight: bold;
    padding: 10px 15px; /* Padding küçültüldü */
    border-radius: 10px; /* Border-radius küçültüldü */
    background: rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15); /* Box-shadow küçültüldü */
    animation: pulse 1s infinite;
    transition: transform 0.3s ease; /* Transition'u sadece transform ile sınırladım */
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.03); } /* Scale miktarı hafifçe azaltıldı */
}

.countdown.green {
    color: #28a745;
    text-shadow: 0 0 8px rgba(40, 167, 69, 0.4); /* Text-shadow boyutu ve opaklığı azaltıldı */
}

.countdown.orange {
    color: #fd7e14;
    text-shadow: 0 0 8px rgba(253, 126, 20, 0.4);
}

.countdown.red {
    color: #dc3545;
    text-shadow: 0 0 8px rgba(220, 53, 69, 0.4);
}









/* Genel Sıfırlamalar (Opsiyonel) */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Profil İkonu Container Stilleri */
.profile-icon-container {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 50px;
    height: 50px;
    z-index: 1000;
    cursor: pointer;
    transition: none; /* Geçiş efektini kaldırıyoruz */
}

/* Profil İkonu Stilleri */
.profile-icon {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ff8a00;
    box-shadow: none; /* Gölgeyi kaldırıyoruz */
    transition: none; /* Geçiş efektini kaldırıyoruz */
}

/* Hover Efekti */
.profile-icon-container:hover .profile-icon {
    transform: none; /* scale efektini kaldırıyoruz */
    box-shadow: none; /* gölge efektini kaldırıyoruz */
}

/* Profil Değiştirme Overlay ve İçerik Stilleri (Mevcut Kodunuzdan) */
.profile-change-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

.profile-change-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    width: 90%;
    max-width: 600px; /* Panel genişliğini sınırla */
    position: relative;
    animation: popIn 0.5s cubic-bezier(0.26, 0.53, 0.74, 1.48);
}

/* Profil Başlık Stili */
.profile-change-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 5px;
    margin-bottom: 5px;
    border-bottom: 2px solid #f0f0f0;
}

.profile-change-header h2 {
    font-size: 1.0em;
    color: #333;
    margin: 0;
}

/* Profil Fotoğrafları Grid Düzeni */
.profile-photos-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    padding: 10px;
    max-height: 500px;
    overflow-y: auto;
}

/* Profil Fotoğraf Kartı Stili */
.profile-photo-item {
    background: linear-gradient(145deg, #ffffff05, #ffffff15);
    backdrop-filter: blur(12px);
    border-radius: 16px;
    padding: 20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.profile-photo-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 200%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
    );
    transition: 0.5s;
}

/* Profil Fotoğrafı */
.profile-photo {
   width: 120px;  
   height: 120px;
   border-radius: 50%;
   object-fit: cover;
   display: block; /* Block görünüme al */
   margin: 0 auto; /* Yatayda otomatik margin ile ortalar */
   border: 3px solid #ff8a00;
   box-shadow: 0 0 15px rgba(255, 138, 0, 0.3);
   transition: transform 0.3s ease;
}

.profile-photo-item:hover .profile-photo {
    transform: scale(1.05);
}

/* Fiyat Etiketi */
.profile-photo-price {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: rgba(0, 0, 0, 0.7);
    padding: 8px;
    border-radius: 8px;
    margin: 10px auto;
    width: fit-content;
    font-size: 1em;
    font-weight: bold;
    color: white;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Buton Stilleri */
.profile-photo-button {
    width: 70%;
    padding: 8px;
    border: none;
    border-radius: 12px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.buy-button {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
}

.use-button {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

.profile-photo-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.category-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    font-size: 0.8em;
    font-weight: bold;
    z-index: 1;
}

@keyframes shine {
    0% { transform: translateX(-100%) rotate(-25deg); }
    100% { transform: translateX(100%) rotate(-25deg); }
}

/* Kapatma Butonu */
.profile-close-button {
    background: none;
    border: none;
    color: #666;
    font-size: 1.5em;
    cursor: pointer;
    padding: 5px;
}

/* Animasyonlar */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes popIn {
    from { 
        opacity: 0; 
        transform: scale(0.9);
    }
    to { 
        opacity: 1;
        transform: scale(1);
    }
}

/* Hover Efektleri */
.profile-photo-item:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}


.profile-photo-item:hover::before {
    animation: shine 1.5s infinite;
}

.profile-close-button:hover {
    color: #ff4444;
}

.buy-button:hover {
    background: #218838;
}

.use-button:hover {
    background: #0056b3;
}

.profile-categories {
   display: flex;
   overflow-x: auto;
   padding: 15px;
   gap: 15px;
   background: linear-gradient(145deg, #f6f7f9, #ffffff);
   border-radius: 15px;
   -webkit-overflow-scrolling: touch;
   scrollbar-width: none;
   white-space: nowrap;
   margin-bottom: 20px;
}

.profile-categories::-webkit-scrollbar {
    display: none;
}

.category-button {
   min-width: 200px;
   height: 50px;
   padding: 0 20px;
   border: none;
   border-radius: 12px;
   font-size: 1rem;
   font-weight: 600;
   cursor: pointer;
   transition: all 0.3s ease;
   background: linear-gradient(45deg, #4e54c8, #8f94fb);
   color: white;
   box-shadow: 0 4px 15px rgba(78, 84, 200, 0.2);
   flex-shrink: 0;
   position: relative;
   overflow: hidden;
   opacity: 0.7; /* Default biraz soluk */
}

.category-button::before {
   content: '';
   position: absolute;
   top: 0;
   left: -100%;
   width: 100%;
   height: 100%;
   background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
   transition: 0.5s;
}

.category-button:hover::before {
   left: 100%;
}

.category-button:hover {
   transform: translateY(-2px);
   box-shadow: 0 8px 20px rgba(78, 84, 200, 0.3);
}

.category-button.active {
   opacity: 1;
   transform: scale(1.05);
   border: 2px solid #000; 
   box-shadow: 0 4px 20px rgba(45, 50, 184, 0.4);
   animation: activeButtonPulse 2s infinite;
}

[data-category="duel"] {
   background: linear-gradient(45deg, #f12711, #f5af19);
}

[data-category="duel"].active {
   background: linear-gradient(45deg, #f12711, #f5af19);
}

[data-category="lider"] {
   background: linear-gradient(45deg, #11998e, #38ef7d);
}

[data-category="lider"].active {
   background: linear-gradient(45deg, #11998e, #38ef7d);
}

[data-category="sampiyon"] {
   background: linear-gradient(45deg, #FFD700, #FFA500);
}

[data-category="sampiyon"].active {
   background: linear-gradient(45deg, #FFD700, #FFA500);
}

/* Aktif buton animasyonu */
@keyframes activeButtonPulse {
   0% { transform: scale(1.05); }
   50% { transform: scale(1.08); }
   100% { transform: scale(1.05); }
}

.category-button:hover {
   opacity: 0.9;
   transform: translateY(-2px);
}

.category-button.active:hover {
   opacity: 1;
}

@media (max-width: 768px) {
   .profile-categories {
       gap: 10px;
       padding: 10px;
   }

   .category-button {
       min-width: 160px;
       height: 45px;
       font-size: 0.9rem;
   }
}


.category-button.active {
   opacity: 1;
   transform: scale(1.05);
   background: linear-gradient(45deg, #2d32b8, #5c61f9);
   box-shadow: 0 4px 20px rgba(45, 50, 184, 0.4);
   animation: activeButtonPulse 2s infinite;
   border: 2px solid #000; /* Siyah çerçeve */
}

.category-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
animation: floatButton 1s ease infinite;
}

@keyframes floatButton {
    0% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
    100% { transform: translateY(0); }
}

@media (max-width: 768px) {
    .category-button {
        min-width: 160px;
        font-size: 0.9rem;
        padding: 0 15px;
    }
}


.profile-categories::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 30px;
    background: linear-gradient(to right, transparent, rgba(255,255,255,0.9));
    pointer-events: none;
}

.profile-photo-item {
   text-align: center; /* İçerikleri ortalar */
   padding: 15px;
}

.profile-photo-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.12);
}

@keyframes fadeInUp {
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes glowRotate {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}





.question-container {
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 700px;
    padding: 15px;
    border: 2px solid #ff8a00;
    border-radius: 10px;
    background-color: #fffbea;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    gap: 15px; /* İçerikler arası boşluk */
}

/* Metin Bölümü */
.question-text-container {
    display: flex;
    flex-direction: column;
    width: 100%;
    gap: 15px;
}

/* Üst metin (bilgi metni) */
.question-info-text {
    font-size: 1.1em;
    color: #333;
    padding: 10px;
    text-align: center;
}

/* Ayırıcı çizgi */
.question-divider {
    width: 90%;
    height: 1px;
    background: #ff8a00;
    margin: 0 auto;
    opacity: 0.5;
}

/* Alt metin (soru metni) */
.question-actual-text {
    font-size: 1.2em;
    font-weight: bold;
    color: #000;
    padding: 10px;
    text-align: center;
}












.current-diamonds {
    position: relative; /* Pseudo-element için gerekli */
    background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
    color: white;
    padding: 10px 20px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    overflow: hidden; /* Pseudo-element taşmasını önlemek için */
    transition: transform 0.3s ease; /* Hover animasyonu için */
}

.current-diamonds::before {
    display: none; /* Efekti tamamen kaldır */
}

.current-diamonds::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
    opacity: 0;
    transition: opacity 0.3s ease;
    animation: backgroundGlow 4s ease-in-out infinite; /* Arka plan parlaklık animasyonu */
}

.current-diamonds:hover::after {
    opacity: 1;
}

.current-diamonds:hover {
    transform: scale(1.05); /* Hover durumunda hafif büyüme */
}

.diamond-icon {
    font-size: 1.2em;
    position: relative;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}

@keyframes waveMove {
    0% {
        transform: rotate(0deg) translate(0, 0);
    }
    50% {
        transform: rotate(180deg) translate(10px, 10px);
    }
    100% {
        transform: rotate(360deg) translate(0, 0);
    }
}

/* Yeni Eklenen Arka Plan Parlaklık Animasyonu */
@keyframes backgroundGlow {
    0% {
        box-shadow: 0 0 10px rgba(79, 195, 247, 0.3), 0 0 20px rgba(79, 195, 247, 0.2);
    }
    50% {
        box-shadow: 0 0 20px rgba(79, 195, 247, 0.6), 0 0 30px rgba(79, 195, 247, 0.4);
    }
    100% {
        box-shadow: 0 0 10px rgba(79, 195, 247, 0.3), 0 0 20px rgba(79, 195, 247, 0.2);
    }
}

/* Metindeki Parlaklık Efektini Kaldırdım */
.diamond-amount {
    font-weight: bold;
    font-size: 1.1em;
    color: #4fc3f7;
    /* Metindeki glowText animasyonunu kaldırdık */
    /* transition: color 0.3s ease; */
}


















.register-button {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.1em;
    margin-left: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.register-button:hover {
    transform: scale(1.05);
    box-shadow: 0 7px 20px rgba(0,0,0,0.2);
}

.registration-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000000;
    animation: fadeIn 0.3s ease-in-out;
}

.registration-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
}

.registration-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.registration-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1em;
    transition: border-color 0.3s;
}

.registration-input:focus {
    border-color: #4CAF50;
    outline: none;
    box-shadow: 0 0 5px rgba(74, 175, 80, 0.2);
}

.registration-submit {
    width: 100%;
    padding: 12px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.3s;
}

.registration-submit:disabled {
    background: #cccccc;
    cursor: not-allowed;
}

.registration-submit:not(:disabled):hover {
    background: #45a049;
    transform: scale(1.02);
}

.registration-error {
    color: #dc3545;
    font-size: 0.9em;
    text-align: center;
    margin-top: 10px;
    min-height: 20px;
}

.verification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000000;
}

.verification-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 400px;
    animation: fadeIn 0.3s ease-in-out;
}

.verification-content h3 {
    color: #4CAF50;
    margin-bottom: 15px;
}

.verification-content p {
    color: #666;
    line-height: 1.5;
    margin-bottom: 10px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        transform: translateY(-20px);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}






.user-ranking-stats {
   margin-top: auto;
   padding: 15px;
   background: linear-gradient(135deg, #4338ca, #6366f1);
   border-radius: 15px;
   color: white;
   animation: slideUp 0.3s ease-out 0.2s backwards;
}

@keyframes slideUp {
   0% {
       transform: translateY(30px);
       opacity: 0;
   }
   100% {
       transform: translateY(0);
       opacity: 1;
   }
}

.user-ranking-stats:hover {
   transform: translateY(-2px);
   box-shadow: 0 12px 25px rgba(79, 70, 229, 0.3);
}

.stats-header {
   font-size: 1.3em;
   font-weight: bold;
   text-align: center;
   margin-bottom: 12px;
   text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

.stats-content {
   display: flex;
   justify-content: space-between;
   align-items: center;
   padding: 12px 15px;
   background: rgba(255, 255, 255, 0.12);
   border-radius: 12px;
   backdrop-filter: blur(4px);
   border: 1px solid rgba(255, 255, 255, 0.1);
}

.rank-info {
   display: flex;
   align-items: center;
   gap: 25px;
}

.rank-number, .total-players {
   display: flex;
   flex-direction: column;
   align-items: center;
   gap: 4px;
}

.rank-label, .total-label {
   font-size: 0.85em;
   opacity: 0.95;
   letter-spacing: 0.3px;
}

.rank-value, .total-value {
   font-size: 1.5em;
   font-weight: bold;
   text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

.user-trophy {
   display: flex;
   align-items: center;
   gap: 8px;
   background: rgba(255, 215, 0, 0.15);
   padding: 8px 15px;
   border-radius: 10px;
   border: 1px solid rgba(255, 215, 0, 0.2);
   margin-left: 10px;
}

.trophy-icon {
   font-size: 1.4em;
   animation: trophyBounce 2.5s infinite ease-in-out;
   filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.2));
}

.trophy-value {
   font-size: 1.4em;
   font-weight: bold;
   color: #ffd700;
   text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

@keyframes trophyBounce {
   0%, 100% { transform: translateY(0) rotate(0deg); }
   50% { transform: translateY(-3px) rotate(3deg); }
}

@media (max-width: 480px) {
   .user-ranking-stats {
       margin: 10px auto;
       padding: 12px 15px;
   }
   
   .stats-content {
       padding: 10px 12px;
   }
   
   .rank-info {
       gap: 20px;
   }
   
   .rank-value, .total-value, .trophy-value {
       font-size: 1.3em;
   }
   
   .trophy-icon {
       font-size: 1.2em;
   }
}





.credits-stats {
    background: linear-gradient(145deg, #ff9900, #db6204);
    position: relative;
}

.credits-glow {
    background: radial-gradient(circle at center,
        rgba(99, 102, 241, 0.3) 0%,
        transparent 70%);
    animation: pulseCredits 2s ease-in-out infinite;
}

.credits-stats .stats-icon {
    animation: floatGame 3s ease-in-out infinite;
    filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
}

.credits-stats .stats-value {
    background: linear-gradient(45deg, #ffffff, #ffffff, #ffffff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmerCredits 3s linear infinite;
}

.tip-title {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    white-space: nowrap;
    pointer-events: none;
    z-index: 10;
}

@keyframes pulseCredits {
    0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.1); }
}

@keyframes floatGame {
    0%, 100% { transform: translateY(0) scale(1); filter: brightness(1); }
    50% { transform: translateY(-3px) scale(1.05); filter: brightness(1.2); }
}

@keyframes shimmerCredits {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}






/* Ana mağaza kabı */
.duel-credits-store {
  background: linear-gradient(135deg, #1a1c2b, #2d324d);
  padding: 25px;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  max-width: 1200px; /* Daha geniş ekranlarda ortalamak için */
  margin: 0 auto;    /* Ortalamak için */
  max-height: 450px;      /* Sabit yükseklikten kaçın */
  overflow-y: auto;  /* İçerik uzadığında dikeyde kaydırma yapabilmek için */
}

/* Paketlerin bulunduğu konteyner - grid yapısı */
.credits-packages-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  padding: 15px;
  height: auto;      /* Sabit yükseklikten kaçın */
}

/* Paket Kartları */
.credit-package {
  background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 15px;
  padding: 20px;
  backdrop-filter: blur(10px);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.credit-package:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
}

/* Paket İçerikleri */
.package-header {
  text-align: center;
  margin-bottom: 15px;
}

.package-amount {
  font-size: 1.4em;
  font-weight: bold;
  background: linear-gradient(45deg, #f5d020, #ff9933);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 5px;
}

.package-subtitle {
  color: #a0aec0;
  font-size: 0.9em;
}

.package-price {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 15px 0;
  font-size: 1.2em;
  color: #4fd1c5;
}

/* Satın Al Butonu */
.buy-button {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #4c1d95, #6d28d9);
  color: #ffffff;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.buy-button:hover {
  background: linear-gradient(135deg, #6d28d9, #4c1d95);
  transform: scale(1.05);
}

/* Unlimited Paketi Özel Görünüm */
.credit-package.unlimited {
  background: linear-gradient(145deg, #4f46e5, #4338ca);
  color: #ffffff;
  position: relative;
  overflow: hidden; /* Parlama efektini göstermek için parent'ta kalabilir */
}

.credit-package.unlimited::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    45deg,
    transparent,
    rgba(255, 255, 255, 0.1),
    transparent
  );
  animation: shine 3s infinite linear;
}

/* Parlaklık Animasyonu */
@keyframes shine {
  0% {
    transform: translateX(-100%) rotate(45deg);
  }
  100% {
    transform: translateX(100%) rotate(45deg);
  }
}

/* Mobil uyumlu tasarım için medya sorgusu */
@media (max-width: 768px) {
  .credits-packages-container {
    grid-template-columns: 1fr;
    gap: 15px;
  }

  .duel-credits-store {
    padding: 20px;
    /* Yine height: auto ve overflow-y: auto burada da geçerli kalmalı */
  }

  .credit-package {
    padding: 15px;
  }

  .package-amount {
    font-size: 1.2em;
  }

  .package-price {
    font-size: 1.1em;
  }
}







.credits-stats.unlimited {
    background: linear-gradient(145deg, #6ddb0d, #11f0d6);
    color: white;
    position: relative;
    overflow: hidden;
}

.credits-stats.unlimited::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 200%;
    height: 100%;
    background: linear-gradient(
        90deg, 
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
    );
    animation: shimmerEffect 2s infinite;
}

.credits-stats.unlimited .stats-value {
    font-weight: bold;
    text-shadow: 0 0 10px rgba(255,255,255,0.5);
    animation: pulseText 2s infinite;
}

@keyframes shimmerEffect {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

@keyframes pulseText {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}






/* Seçim animasyonu: Slide-in efekti */
.animate-slideIn {
  opacity: 0;
  transform: translateY(20px);
  animation: slideIn 0.5s forwards;
}

@keyframes slideIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* İsteğe bağlı: Seçim alanı (duel-selection-banner) için ekstra stil */
.duel-selection-banner {
  text-align: center;
  margin-bottom: 20px;
}

.selection-item {
  font-size: 1.2em;
  margin: 5px 0;
}



/* === Düello Seçim Ekranı için Yenilenmiş Stil === */
#duel-selection-screen {
  /* Dinamik ve derin bir arka plan */
  background: linear-gradient(135deg, #1f1c2c, #928dab);
  animation: duelBgAnimation 8s ease-in-out infinite alternate;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
  max-width: 900px;
  margin: 40px auto;
  transform: translateY(20px);
  opacity: 0;
  animation: fadeInUp 0.8s forwards, duelBgAnimation 8s ease-in-out infinite alternate;
  position: relative;
  overflow: hidden;
}

/* Arka plan animasyonu */
@keyframes duelBgAnimation {
  0% {
    background: linear-gradient(135deg, #1f1c2c, #928dab);
  }
  100% {
    background: linear-gradient(135deg, #232526, #414345);
  }
}

/* Fade in yukarı animasyonu */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Başlık animasyonu ve stil düzenlemesi */
#duel-selection-screen h2 {
  font-size: 2.2em;
  color: #fff;
  text-align: center;
  text-shadow: 0 0 10px rgba(0,0,0,0.7);
  margin-bottom: 20px;
  animation: headerPulse 2s ease-in-out infinite alternate;
}

@keyframes headerPulse {
  0% {
    transform: scale(1);
    text-shadow: 0 0 10px rgba(0,0,0,0.7);
  }
  100% {
    transform: scale(1.05);
    text-shadow: 0 0 20px rgba(0,0,0,0.9);
  }
}

.selecting-student-banner {
  font-size: 1.2em;
  font-weight: bold;
  color: #ffeb3b;
  text-align: center;
  /* Örneğin, üst, sağ, alt, sol için sırasıyla 20px, 15px, 10px, 15px boşluk */
  margin: 20px 15px 10px 15px;
  padding: 10px;
  border-radius: 20px;
  background: rgba(0,0,0,0.3);
  box-shadow: 0 0 10px rgba(255,235,59,0.7);
  animation: glowBanner 1.5s infinite alternate;
}


@keyframes glowBanner {
  from {
    box-shadow: 0 0 10px rgba(255,235,59,0.5);
  }
  to {
    box-shadow: 0 0 20px rgba(255,235,59,1);
  }
}

/* Table-section (konu belirleme) kutusu: hafif transparan, yuvarlatılmış */
#duel-selection-screen .table-section {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.2);
  padding: 7px;
  border-radius: 15px;
  margin-bottom: 20px;
  animation: slideInFromLeft 0.6s ease-out;
}

@keyframes slideInFromLeft {
  from {
    transform: translateX(-50px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Label ve select elementleri */
#duel-selection-screen label {
  display: block;
  margin: 10px 0 5px;
  color: #fff;
  font-weight: 600;
}
#duel-selection-screen select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  background: rgba(255,255,255,0.2);
  color: #fff;
  font-size: 1em;
  outline: none;
  transition: background 0.3s, border-color 0.3s;
}
#duel-selection-screen select:focus {
  background: rgba(255,255,255,0.3);
  border-color: #ffeb3b;
}

/* Duel start butonu */
.duel-start-button {
  background: linear-gradient(45deg, #ff5722, #e91e63);
  color: #fff;
  padding: 14px 30px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 1.1em;
  font-weight: bold;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  transition: transform 0.2s, box-shadow 0.3s;
  opacity: 0.8;
}
.duel-start-button.active,
.duel-start-button:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  opacity: 1;
}

/* Duel bottom info (oyuncu bilgileri) – dinamik hover ve animasyon */
.duel-bottom-info {
  display: flex;
  justify-content: space-evenly;
  margin-top: 5px;
  animation: fadeInUp 0.8s ease;
}
.duel-player-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}
.duel-player-photo {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #ffeb3b;
  transition: transform 0.4s ease;
}
.duel-player-photo:hover {
  transform: rotate(360deg);
}
.duel-player-name {
  margin-top: 10px;
  color: #fff;
  font-size: 1em;
  font-weight: 600;
  text-shadow: 0 0 5px rgba(0,0,0,0.6);
}

/* Countdown container – modern ve net görünüm */
.countdown-container {
  position: absolute;
  margin-bottom: 10px;
  top: 15px;
  right: 15px;
  z-index: 10;
}
.countdown {
  font-size: 1em;
  color: #ff5722;
  margin-bottom: 10px;
  font-weight: bold;
  background: rgba(0, 0, 0, 0.4);
  padding: 8px 12px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  animation: pulseCountdown 1.5s infinite;
}

@keyframes pulseCountdown {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* Option butonları (soru seçiminde kullanılanlar) – isteğe bağlı */
#duel-selection-screen .option-button {
  transition: transform 0.2s, background-color 0.2s;
}
#duel-selection-screen .option-button:hover {
  transform: scale(1.05);
}

/* Genel responsive ayarlamaları (isteğe bağlı) */
@media (max-width: 480px) {
  #duel-selection-screen {
    padding: 20px;
    margin: 20px;
  }
  #duel-selection-screen h2 {
    font-size: 1.8em;
  }
  .duel-player-photo {
    width: 60px;
    height: 60px;
  }
}








/* ========== Gelişmiş Alert Modal Tasarımı ========== */
.alert-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000000;
  animation: fadeInModal 0.3s ease;
}

@keyframes fadeInModal {
  from { opacity: 0; }
  to { opacity: 1; }
}

.alert-content {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(8px);
  padding: 30px;
  border-radius: 15px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  text-align: center;
  position: relative;
  animation: slideDownModal 0.4s ease;
}

@keyframes slideDownModal {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.alert-message {
  font-size: 1.2em;
  color: #333;
  margin-bottom: 20px;
  /* Hafif parıltı efekti */
  animation: textGlow 1.5s infinite alternate;
}

@keyframes textGlow {
  from { text-shadow: 0 0 5px rgba(0,123,255,0.5); }
  to { text-shadow: 0 0 10px rgba(0,123,255,1); }
}

.alert-ok-button {
  background: linear-gradient(45deg, #007BFF, #00BFFF);
  color: #fff;
  padding: 12px 25px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  font-weight: bold;
  transition: background 0.3s, transform 0.2s;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.alert-ok-button:hover {
  background: linear-gradient(45deg, #0056b3, #009acd);
  transform: scale(1.05);
}










</style>
</head>
<body>
    <!-- Oyundakiler Modal -->
    <div class="players-overlay" id="playersOverlay">
        <div class="players-content">
            <div class="players-header">
                <h3>Oyundakiler</h3>
                <button class="players-close" id="playersCloseButton">✖</button>
            </div>
            <ul class="players-list" id="playersList"></ul>
        </div>
    </div>

    <!-- Öğrenci Seçimi Ekranı -->
    <div class="container student-selection-container" id="student-selection-screen">
        <h2>🏆 Düellomatik 🏆</h2>
        <div class="table-section">
            <h3>Öğrenci Seçme</h3>
            <label for="selection-class-select">Sınıfı Seç:</label>
            <select id="selection-class-select">
                <option value="">Seçiniz</option>
            </select>

<!-- Eski select yerine eklenecek input -->
<label for="selection-name-input">Kullanıcı Adı:</label>
<input type="text" id="selection-name-input" placeholder="Kullanıcı adınızı giriniz" disabled>


            <label for="student-password-input">Şifre Giriniz:</label>
            <input type="password" id="student-password-input" placeholder="Şifre" disabled>
        </div>
        <button class="login-button" id="login-button" disabled>Giriş</button>
        <button class="register-button" id="register-button">Kayıt Ol</button> 
            </button>
        <div class="error" id="student-selection-error"></div>
    </div>

    <!-- Ana Ekran -->
    <div class="container" id="main-screen" style="display: none;">
<div class="profile-icon-container">
    <img 
        src="https://i.pinimg.com/originals/66/22/ab/6622ab37c6db6ac166dfec760a2f2939.gif" 
        alt="Profile" 
        id="profile-icon" 
        class="profile-icon">
</div>
     <div class="student-info">
    <img src="" alt="Öğrenci Fotoğrafı" class="student-photo" id="student-photo" style="display: none;">
    <div class="student-name" id="student-name"></div>
    <div class="student-stats-container">
        <div class="student-stats">
            <div class="stats-item trophy-stats">
                <div class="stats-glow trophy-glow"></div>
                <span class="stats-icon">🏆</span>
                <span class="stats-value trophy-value" id="game-cup-score">0</span>
            </div>
            <div class="stats-item diamond-stats">
                <div class="stats-glow diamond-glow"></div>
                <span class="stats-icon">💎</span>
                <span class="stats-value diamond-value" id="diamond-value">0</span>
</div>
<div class="stats-item credits-stats" id="credits-stats">
        <div class="stats-glow credits-glow"></div>
        <span class="stats-icon">⚔️</span>
        <span class="stats-value credits-value" id="duel-credits-value">0</span>
        <div class="tip-title" style="display: none;">Düello Hakkı</div>
            </div>
        </div>
    </div>
</div>

        <div class="buttons">
            <button class="single-player">Tek Kişilik Oyun</button>
    <button class="find-duel-button" id="findDuelButton">
        <span class="button-content">
            <i class="duel-icon">⚔️</i>
            <span>Düello Ara</span>
        </span>
        <div class="button-glow"></div>
    </button>
<button class="friends-button" id="friends-button" style="display: none;">
   👥 Arkadaşlar
</button>
            <!-- Yeni Eklenen "Kupa Sıralaması" Butonu -->
            <button class="kupa-siralama-button" id="kupa-siralama-button">
                🏆 Sezon Sıralaması
            </button>
	    <button class="logout-button" id="logout-button">Çıkış Yap</button>

        </div>
    </div>

<!-- Arkadaşlar Ekranı -->
<div class="friends-container" id="friends-screen" style="display: none;">
    <h2>Arkadaşlar</h2>
    
    <!-- Arama Bölümü -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" id="friend-search" placeholder="Arkadaş Ara...">
            <button id="search-button">🔍 Ara</button>
        </div>
        <div class="search-results" id="search-results">
            <!-- Arama sonuçları buraya gelecek -->
        </div>
    </div>

    <!-- Arkadaş Listesi -->
    <div class="friends-list-section">
        <h3>Arkadaş Listem</h3>
        <ul class="players-list" id="friends-list">
            <!-- Arkadaş listesi buraya gelecek -->
        </ul>
    </div>

    <button class="back-button">Geri Dön</button>
</div>


    <!-- Ranking Panel (Yan Panel - Yeni Eklendi) -->
    <div class="ranking-panel" id="rankingPanel" style="display: none;">
        <h2>Sezon Sıralaması</h2>
        <div class="ranking-table-container">
            <table class="ranking-table" id="ranking-table">
                <thead>
                    <tr>
                        <th>Sıra</th>
                        <th>Foto</th>
                        <th>İsim</th>
                        <th>Sınıf</th>
                        <th>KupaSayısı</th>
                    </tr>
                </thead>
                <tbody id="ranking-table-body">
                    <!-- Sıralama verileri buraya eklenecek -->
                </tbody>
            </table>
        </div>

<div class="user-ranking-stats">
        <div class="stats-header">Genel Sıralama Durumunuz</div>
        <div class="stats-content">
            <div class="rank-info">
                <div class="rank-number" id="userRankNumber">
                    <span class="rank-label">Sıralama</span>
                    <span class="rank-value">-</span>
                </div>
                <div class="total-players" id="totalPlayers">
                    <span class="total-label">Toplam Oyuncu</span>
                    <span class="total-value">-</span>
                </div>
            </div>
            <div class="user-trophy">
                <span class="trophy-icon">🏆</span>
                <span class="trophy-value" id="userTrophyCount">-</span>
            </div>
        </div>
    </div>
        <button class="ranking-back-button" id="rankingBackButton">Geri Dön</button>
    </div>

    <!-- Tek Kişilik Oyun Ekranı -->
    <div class="game-container" id="single-player-screen">
        <h2>Tek Kişilik Oyun</h2>
        <div class="table-section">
            <h3>Konu Belirleme</h3>
            <label for="class-select">Sınıf Seç:</label>
            <select id="class-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="subject-select">Ders Seç:</label>
            <select id="subject-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="topic-select">Konu Seç:</label>
            <select id="topic-select">
                <option value="">Seçiniz</option>
            </select>
        </div>
        <button class="start-game-button" id="start-game-button" disabled>Oyuna Başla</button>
        <button class="back-button">Geri Dön</button>
    </div>

    <!-- Tek Kişilik Oyun Sorular Ekranı -->
    <div class="single-player-game-container" id="single-player-game-screen">
        <div class="progress-container">
            <div class="question-number" id="question-number">Soru 1/10</div>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progress-bar-inner"></div>
            </div>
        </div>
        <div class="timer-container">
            <div class="timer" id="timer">45</div>
        </div>
        <div class="question-container">
            <img src="" alt="Soru Resmi" class="question-image" id="question-image" style="display: none;">
            <div class="question-text" id="question-text">Soru metni burada olacak.</div>
        </div>
        <div class="options-container" id="options-container"></div>
        <div class="score-container" id="score-container">
            <span id="score"></span>
            <div class="score-message" id="score-message"></div>
            <img id="score-image" class="final-image" style="display:none;" alt="Sonuç Resmi">
            <!-- "Geri Dön" butonu -->
            <button class="end-game-button" id="final-back-button">Geri Dön</button>
        </div>
    </div>

    <!-- Düello Seçim Ekranı -->
    <div class="duel-selection-container" id="duel-selection-screen">
<div class="countdown-container">
    <div class="countdown" id="duelCountdown">10</div>
</div>
<div id="selecting-student-banner" class="selecting-student-banner"></div>
        <div class="table-section">
            <h3>Konu Belirlendi.</h3>
            <label for="duel-class-select">Sınıfınız:</label>
            <select id="duel-class-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="duel-subject-select">Düello Dersi:</label>
            <select id="duel-subject-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="duel-topic-select">Düello Konusu:</label>
            <select id="duel-topic-select">
                <option value="">Seçiniz</option>
            </select>
        </div>

        <div class="duel-bottom-info">
            <div class="duel-player-info" id="duel-inviter-info">
                <img src="" class="duel-player-photo" id="duel-inviter-photo">
                <div class="duel-player-name" id="duel-inviter-name"></div>
            </div>
            <div class="duel-player-info" id="duel-invited-info">
                <img src="" class="duel-player-photo" id="duel-invited-photo">
                <div class="duel-player-name" id="duel-invited-name"></div>
            </div>
        <div class="duel-controls">
            <button class="duel-start-button" id="duel-start-button" style="display:none;" disabled>Düelloya Başla</button>

        </div>
        </div>
    </div>












<!-- Yeni modal ekranları - body etiketinin sonuna, diğer modallardan önce eklenecek -->
<div class="registration-overlay" id="registrationOverlay" style="display: none;">
    <div class="registration-content">
        <div class="registration-header">
            <h2>Yeni Hesap Oluştur</h2>
            <button class="close-button" id="closeRegistration">✖</button>
        </div>
        <div class="registration-form">
            <select id="registerClassSelect" class="registration-input">
                <option value="">Sınıf Seçin</option>
            </select>
            
            <input type="text" id="registerUsername" 
                   class="registration-input" 
                   placeholder="Kullanıcı Adı (max 11 karakter)" 
                   maxlength="11">
            
            <input type="password" id="registerPassword" 
                   class="registration-input" 
                   placeholder="Şifre (en az 6 karakter, harf ve rakam içermeli)">
            
            <input type="email" id="registerEmail" 
                   class="registration-input" 
                   placeholder="E-posta Adresi">
            
            <button id="submitRegistration" class="registration-submit" disabled>
                Kayıt Ol
            </button>
        </div>
        <div id="registrationError" class="registration-error"></div>
    </div>
</div>

<div class="verification-overlay" id="verificationOverlay" style="display: none;">
    <div class="verification-content">
        <h3>Şahane Kayıt Başarılı 🎉</h3>
        <p>Şimdi Giriş Yaparak Mücadeleye Başlayabilirsin 🤩</p>
    </div>
</div>





















<div class="matchmaking-screen" id="matchmakingScreen">
    <div class="matchmaking-content">
        <h2>Düello Rakibi Aranıyor</h2>
        
        <!-- Arama Animasyonu -->
        <div class="searching-animation"></div>
        
        <!-- Mevcut Oyuncular Listesi -->
        <div class="available-players">
            <h3>Müsait Oyuncular</h3>
            <div class="players-list" id="availablePlayersList">
                <!-- Oyuncular dinamik olarak buraya eklenecek -->
            </div>
        </div>
        
        <!-- İptal Butonu -->
        <button class="cancel-search-button" id="cancelSearchButton">
            Aramayı İptal Et
        </button>
    </div>
</div>



























    <!-- Düello Oyun Ekranı -->
    <div class="duel-game-container" id="duel-game-screen">
        <div class="progress-container">
            <div class="question-number" id="duel-question-number">Soru 1/10</div>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="duel-progress-bar-inner"></div>
            </div>
        </div>
        <div class="timer-container">
            <div class="timer" id="duel-timer">45</div>
        </div>
        <div class="question-container">
            <img src="" alt="Soru Resmi" class="question-image" id="duel-question-image" style="display: none;">
            <div class="question-text" id="duel-question-text">Soru metni burada olacak.</div>
        </div>
        <div class="options-container" id="duel-options-container"></div>

        <div class="players-info-row">
            <div class="duel-player-score" id="duel-player-inviter-score">
                <img id="duel-player-inviter-photo" src="">
                <div class="duel-player-name" id="duel-player-inviter-name"></div>
                <div class="duel-player-correct-count" id="inviter-correct-count">0</div>
            </div>
            <div class="duel-player-score" id="duel-player-invited-score">
                <img id="duel-player-invited-photo" src="">
                <div class="duel-player-name" id="duel-player-invited-name"></div>
                <div class="duel-player-correct-count" id="invited-correct-count">0</div>
            </div>
        </div>

        <div class="score-container" id="duel-final-container">
            <div class="winner-message" id="winner-message"></div>
            <button class="end-game-button" id="duel-final-back-button">Oyunu Sonlandır</button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-content">
            <div class="alert-message" id="alertMessage"></div>
            <button class="alert-ok-button" id="alertOkButton">Tamam</button>
        </div>
    </div>

    <!-- Prompt Modal -->
    <div class="prompt-overlay" id="promptOverlay">
        <div class="prompt-content">
            <div class="prompt-message" id="promptMessage"></div>
            <input type="text" class="prompt-input" id="promptInput">
            <div class="prompt-buttons">
                <button class="prompt-cancel-button" id="promptCancelButton">İptal</button>
                <button class="prompt-ok-button" id="promptOkButton">Tamam</button>
            </div>
        </div>
    </div>

    <!-- Davet Modalı -->
    <div class="invitation-overlay" id="invitationOverlay">
        <div class="invitation-content">
            <div class="invitation-message" id="invitationMessage"></div>
            <div class="invitation-buttons">
                <button class="invitation-decline-button" id="invitationDeclineButton">Reddet</button>
                <button class="invitation-accept-button" id="invitationAcceptButton">Kabul Et</button>
            </div>
        </div>
    </div>









<div class="profile-change-overlay" id="profileChangeOverlay">
    <div class="profile-change-content">
        <div class="profile-change-header">
            <div class="current-diamonds">
                <span class="diamond-icon">💎</span>
                <span class="diamond-amount" id="currentDiamonds">0</span>
            </div>
            <h2>Mağaza 🛒</h2>
            <button class="profile-close-button" id="profileCloseButton">✖</button>
        </div>
        
        <div class="profile-categories">
            <button class="category-button" data-category="duel">⚔️ Düello Bileti Satın Al</button>
            <button class="category-button active" data-category="acemi">Klasik Nişanlar</button>
            <button class="category-button" data-category="cesur">⭐Koleksiyoner Nişanlar⭐</button>         
            <button class="category-button" data-category="sampiyon">👑Şampiyon👑</button>
     
        </div>

        <!-- Düello Hakları Mağazası -->
        <div class="duel-credits-store" id="duelCreditsStore" style="display: none;">
            <div class="credits-packages-container">
                <!-- 100 Hak Paketi -->
                <div class="credit-package">
                    <div class="package-header">
                        <span class="package-amount">🎫 100 Düello Bileti</span>
                    </div>
                    <div class="package-price">
                        <span class="diamond-amount">100</span>
                        <span class="diamond-icon">💎</span>
                    </div>
                    <button class="buy-button" onclick="purchaseCredits(100, 100)">
                        Satın Al
                    </button>
                </div>

                <!-- 300 Hak Paketi -->
                <div class="credit-package">
                    <div class="package-header">
                        <span class="package-amount">🎫 300 Düello Bileti</span>
                    </div>
                    <div class="package-price">
                        <span class="diamond-amount">250</span>
                        <span class="diamond-icon">💎</span>
                    </div>
                    <button class="buy-button" onclick="purchaseCredits(300, 250)">
                        Satın Al
                    </button>
                </div>

                <!-- 750 Hak Paketi -->
                <div class="credit-package">
                    <div class="package-header">
                        <span class="package-amount">🎫 750 Düello Bileti</span>
                    </div>
                    <div class="package-price">
                        <span class="diamond-amount">500</span>
                        <span class="diamond-icon">💎</span>
                    </div>
                    <button class="buy-button" onclick="purchaseCredits(750, 500)">
                        Satın Al
                    </button>
                </div>

                <!-- Sınırsız Paket -->
                <div class="credit-package unlimited">
                    <div class="package-header">
                        <span class="package-amount">1 Aylık Sınırsız Bilet</span>
                        <span class="package-subtitle">"30 Gün Boyunca Sınırsız Düello!"</span>
                    </div>
                    <div class="package-price">
                        <span class="diamond-amount">1000</span>
                        <span class="diamond-icon">💎</span>
                    </div>
                    <button class="buy-button" onclick="purchaseUnlimited(1000)">
                        Satın Al
                    </button>
                </div>
            </div>
        </div>

        <!-- Profil Fotoğrafları Konteyneri -->
        <div class="profile-photos-container" id="profilePhotosContainer"></div>
    </div>
</div>















    <!-- Arka Plan Müziği için Audio Elementi -->
    <audio id="duelBackgroundMusic" src="https://github.com/d4rkd4y76/OYUN-MZK/raw/refs/heads/main/dllo%20mz.mp3" preload="auto"></audio>
    <!-- Kazanan Ekranı için Yeni Audio Elementi -->
    <audio id="winnerMusic" src="https://github.com/d4rkd4y76/OYUN-MZK/raw/refs/heads/main/win%20mz.mp3" preload="auto"></audio>
    <!-- Tek Kişilik Oyun Müziği için Yeni Audio Elementi -->
    <audio id="singlePlayerQuestionMusic" src="https://github.com/d4rkd4y76/OYUN-MZK/raw/refs/heads/main/oyun%20tek%20mz.mp3" preload="auto"></audio>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        // JavaScript Kodları

        // Audio Elementlerini Seçme
        const duelMusic = document.getElementById('duelBackgroundMusic');
        const winnerMusic = document.getElementById('winnerMusic');
        const singlePlayerQuestionMusic = document.getElementById('singlePlayerQuestionMusic');

        // "Oyunu Sonlandır" butonuna eklenen event listener
document.getElementById('duel-final-back-button').addEventListener('click', async () => {
    await showAlert('🏆 Kupa verileriniz güncellendi.');
    if (currentDuelRef) {
        try {
            await currentDuelRef.remove();
            currentDuelRef = null;
            isInviter = false;
            duelGameStarted = false;
            window.location.reload();
        } catch (error) {
            console.error("Düello referansı kaldırılırken hata:", error);
            await showAlert('Düello referansı kaldırılırken hata oluştu.');
        }
    } else {
        window.location.reload();
    }
});


        window.addEventListener('beforeunload', () => {
            if (selectedStudent && selectedStudent.studentId) {
                database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).set(false)
                .then(() => console.log("inDuel set to false"))
                .catch(err => console.error("Failed to update inDuel status:", err));

                // Eğer bir düello referansı varsa, düelloyu kaldır ve diğer oyuncunun inDuel durumunu false yap
                if (currentDuelRef) {
                    currentDuelRef.once('value').then(async (snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            const inviterRef = database.ref(`classes/${data.inviter.classId}/students/${data.inviter.studentId}/inDuel`);
                            const invitedRef = database.ref(`classes/${data.invited.classId}/students/${data.invited.studentId}/inDuel`);
                            try {
                                await inviterRef.set(false);
                                await invitedRef.set(false);
                                await currentDuelRef.remove();
                            } catch (error) {
                                console.error("Düello referansı kaldırılırken hata:", error);
                            }
                        }
                    });
                }
            }
        });

        // Lütfen kendi firebaseConfig değerlerinizi girin
        const firebaseConfig = {
  apiKey: "AIzaSyAV8LLng3Cx6-116U6WcEFVn7XqOq2l3Sc",
  authDomain: "duellomatik.firebaseapp.com",
  databaseURL: "https://duellomatik-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "duellomatik",
  storageBucket: "duellomatik.firebasestorage.app",
  messagingSenderId: "274662566652",
  appId: "1:274662566652:web:c097e7052aba00a6b04579",
  measurementId: "G-4HXFJJ0WLR"
};
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();


        // Diğer değişkenler
        let classNameMap = {};
        let duelEnded = false; // Eklendi

        const playersOverlay = document.getElementById('playersOverlay');
        const playersCloseButton = document.getElementById('playersCloseButton');
        const playersList = document.getElementById('playersList');
        const invitationOverlay = document.getElementById('invitationOverlay');
        const invitationMessage = document.getElementById('invitationMessage');

        playersCloseButton.addEventListener('click', () => {
            playersOverlay.style.display = 'none';
        });

        let loggedinPlayerRef = null;
        let selectedStudent = {
            classId: '',
            studentId: '',
            studentName: ''
        };

        const studentPhoto = document.getElementById('student-photo');
        const studentName = document.getElementById('student-name');

        async function addLoggedInPlayer(student) {
            const newRef = database.ref('loggedinPlayers').push();
            await newRef.set({
                name: student.studentName,
                photo: (studentPhoto.src && studentPhoto.src !== "") ? studentPhoto.src : "",
                classId: student.classId,
                studentId: student.studentId
            });
            newRef.onDisconnect().remove();
            loggedinPlayerRef = newRef;
        }

 async function showLoggedInPlayers() {
    playersList.innerHTML = '';
    const snapshot = await database.ref('loggedinPlayers').once('value');
    let playersArr = [];

    if (snapshot.exists()) {
        snapshot.forEach(child => {
            const player = child.val();
            playersArr.push({ ...player, key: child.key });
        });

        // Sınıf adına göre sırala (aynı sınıftakiler önce)
        const sameClassPlayers = playersArr.filter(p => p.classId === selectedStudent.classId && p.studentId !== selectedStudent.studentId);
        const otherClassPlayers = playersArr.filter(p => p.classId !== selectedStudent.classId);
        playersArr = [...sameClassPlayers, ...otherClassPlayers];

        for (const player of playersArr) {
            let photoURL = "https://via.placeholder.com/50";
            try {
                const photoSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/photo`).once('value');
                if (photoSnapshot.exists()) {
                    photoURL = photoSnapshot.val();
                }
            } catch (e) {
                console.error('Fotoğraf alınamadı:', e);
            }

            // "inDuel" durumu
            let inDuel = false;
            try {
                const inDuelSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/inDuel`).once('value');
                if (inDuelSnapshot.exists()) {
                    inDuel = inDuelSnapshot.val();
                }
            } catch (e) {
                console.error('inDuel durumu alınamadı:', e);
            }

            const playerData = {
                name: player.name,
                classId: player.classId,
                className: classNameMap[player.classId] ? classNameMap[player.classId] : player.classId,
                photo: photoURL,
                inDuel: inDuel,
                studentId: player.studentId
            };

            const li = createFriendCard(playerData);
            playersList.appendChild(li);
        }
    } else {
        const li = document.createElement('li');
        li.textContent = "Şu an oyunda kimse yok.";
        playersList.appendChild(li);
    }
    playersOverlay.style.display = 'flex';
}


        const studentSelectionScreen = document.getElementById('student-selection-screen');
        const mainScreen = document.getElementById('main-screen');
        const singlePlayerScreen = document.getElementById('single-player-screen');
        const singlePlayerGameScreen = document.getElementById('single-player-game-screen');
        const duelSelectionScreen = document.getElementById('duel-selection-screen');
        const duelGameScreen = document.getElementById('duel-game-screen');
        const rankingPanel = document.getElementById('rankingPanel'); // Ranking Panel ID

        const loginButton = document.getElementById('login-button');
        const singlePlayerButton = document.querySelector('.single-player');
        const backButtons = document.querySelectorAll('.back-button');
        const startGameButton = document.getElementById('start-game-button');
        const finalBackButton = document.getElementById('final-back-button');

        const selectionClassSelect = document.getElementById('selection-class-select');
        const selectionNameSelect = document.getElementById('selection-name-select');

        const classSelect = document.getElementById('class-select');
        const subjectSelect = document.getElementById('subject-select');
        const topicSelect = document.getElementById('topic-select');

        const studentPasswordInput = document.getElementById('student-password-input');
        const studentSelectionError = document.getElementById('student-selection-error');

        let gameQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        const questionNumber = document.getElementById('question-number');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const questionImage = document.getElementById('question-image');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const scoreContainer = document.getElementById('score-container');
        const scoreDisplay = document.getElementById('score');
        const scoreMessage = document.getElementById('score-message');
        const scoreImage = document.getElementById('score-image');
        const timerElement = document.getElementById('timer');

        const duelClassSelect = document.getElementById('duel-class-select');
        const duelSubjectSelect = document.getElementById('duel-subject-select');
        const duelTopicSelect = document.getElementById('duel-topic-select');
        const duelStartButton = document.getElementById('duel-start-button');

        const duelInviterPhoto = document.getElementById('duel-inviter-photo');
        const duelInviterName = document.getElementById('duel-inviter-name');
        const duelInvitedPhoto = document.getElementById('duel-invited-photo');
        const duelInvitedName = document.getElementById('duel-invited-name');

        const duelQuestionNumber = document.getElementById('duel-question-number');
        const duelProgressBarInner = document.getElementById('duel-progress-bar-inner');
        const duelTimerElement = document.getElementById('duel-timer');
        const duelQuestionImage = document.getElementById('duel-question-image');
        const duelQuestionText = document.getElementById('duel-question-text');
        const duelOptionsContainer = document.getElementById('duel-options-container');

        const inviterCorrectCountEl = document.getElementById('inviter-correct-count');
        const invitedCorrectCountEl = document.getElementById('invited-correct-count');

        const duelFinalContainer = document.getElementById('duel-final-container');
        const winnerMessage = document.getElementById('winner-message');

        // Ranking Panel Elements
        const kupaSiralamaButton = document.getElementById('kupa-siralama-button');
        const rankingTableBody = document.getElementById('ranking-table-body');
        const rankingBackButton = document.getElementById('rankingBackButton');

        let timer;
        let timeLeft = 45;

        let duelTimer;
        let duelTimeLeft = 45;

        let currentDuelRef = null;
        let isInviter = false;
        let currentInvitation = null;

        let duelQuestions = [];
        let duelCurrentQuestionIndex = 0;
        let duelInviterScore = 0;
        let duelInvitedScore = 0;
        let duelClassId = "";
        let duelSubjectId = "";
        let duelTopicId = "";
        let duelQuestionLocked = false;
        let duelGameStarted = false;

window.onload = async () => {
    try {
        // Cleanup işlemini başlat
        startRejectedInvitesCleanup();

        // Sınıf ve öğrenci seçimi için event listener'lar
        selectionClassSelect.addEventListener('change', () => {
            if (selectionClassSelect.value === "") {
                selectionNameInput.disabled = true;
                selectionNameInput.value = "";
            } else {
                selectionNameInput.disabled = false;
            }
            checkLoginButtonState();
        });

        // Yeni input event listener'ı
        selectionNameInput.addEventListener('input', checkLoginButtonState);

        const storedStudent = localStorage.getItem('selectedStudent');
        if (storedStudent) {
            selectedStudent = JSON.parse(storedStudent);
            
            // Ana ekranı göster
            mainScreen.style.display = 'flex';
            studentSelectionScreen.style.display = 'none';
            studentSelectionError.textContent = '';
            studentPasswordInput.value = '';

            // Fotoğraf yükleme
            try {
                const photoSnapshot = await database.ref(
                    `classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/photo`
                ).once('value');

                if (photoSnapshot.exists()) {
                    const photoURL = photoSnapshot.val();
                    studentPhoto.src = photoURL;
                    studentPhoto.style.display = 'block';
                } else {
                    studentPhoto.style.display = 'none';
                }
            } catch (error) {
                console.error("Fotoğraf çekilirken hata:", error);
                studentPhoto.style.display = 'none';
            }

            // Öğrenci bilgilerini ayarla
            studentName.textContent = selectedStudent.studentName;

            // Sırasıyla sistemleri başlat
            await addLoggedInPlayer(selectedStudent);
            startInvitationListener(selectedStudent.studentId);
            await fetchAndDisplayGameCup();
            onMainScreenLoad(); // Elmas sistemini başlat

            // 30 saniye aralıklarla reddedilen davetleri kontrol et ve temizle
            setInterval(async () => {
                try {
                    const rejectedInvitesRef = database.ref('rejectedInvites')
                        .orderByChild('timestamp')
                        .endAt(Date.now() - 30000);
                    
                    const snapshot = await rejectedInvitesRef.once('value');
                    if (snapshot.exists()) {
                        const updates = {};
                        snapshot.forEach(child => {
                            updates[child.key] = null;
                        });
                        await database.ref('rejectedInvites').update(updates);
                    }
                } catch (error) {
                    console.error("Reddedilen davetleri temizlerken hata:", error);
                }
            }, 30000); // Her 30 saniyede bir kontrol et

        } else {
            studentSelectionScreen.style.display = 'flex';
        }

        // Gerekli verileri yükle
        await Promise.all([
            fetchClassesForSelection(),
            fetchChampionData()
        ]);

    } catch (error) {
        console.error("Uygulama başlatma hatası:", error);
        showAlert('Bir hata oluştu. Lütfen sayfayı yenileyin.');
    }
};

        async function fetchAllClasses() {
            const snapshot = await database.ref('classes').once('value');
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const classId = childSnapshot.key;
                    const className = childSnapshot.val().name;
                    classNameMap[classId] = className;
                });
            }
        }
        fetchAllClasses();

        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("Kullanıcı oturum açtı:", user);
            } else {
                console.log("Kullanıcı oturum açmadı.");
            }
        });

loginButton.addEventListener('click', async () => {
    const selectedClass = selectionClassSelect.value;
    const enteredUsername = selectionNameInput.value.trim(); // Yeni input değerini al
    const enteredPassword = studentPasswordInput.value.trim();

    if (!selectedClass || !enteredUsername) {
        studentSelectionError.textContent = 'Lütfen tüm alanları doldurunuz.';
        return;
    }

    // Kullanıcı ID'sini ve bilgilerini veritabanından al
    try {
        const studentsRef = database.ref(`classes/${selectedClass}/students`);
        const snapshot = await studentsRef.orderByChild('name').equalTo(enteredUsername).once('value');

        if (!snapshot.exists()) {
            studentSelectionError.textContent = 'Kullanıcı bulunamadı.';
            return;
        }

        // Snapshot'tan ilk (ve muhtemelen tek) kullanıcıyı al
        const studentData = Object.entries(snapshot.val())[0];
        const studentId = studentData[0]; // Firebase tarafından oluşturulan ID
        const studentInfo = studentData[1]; // Kullanıcı bilgileri

        // selectedStudent nesnesini güncelle
        selectedStudent.classId = selectedClass;
        selectedStudent.studentId = studentId;
        selectedStudent.studentName = studentInfo.name;

        if (enteredPassword === "") {
            studentSelectionError.textContent = 'Lütfen şifrenizi giriniz.';
            return;
        }

        // Buradan sonrası mevcut şifre kontrolü ve giriş işlemleri aynen devam edebilir
        database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/password`).once('value').then(async snapshot => {
            if (snapshot.exists()) {
                const correctPassword = snapshot.val();
                if (enteredPassword === correctPassword) {
                    // Mevcut giriş başarılı işlemleri...
                    studentSelectionScreen.style.display = 'none';
                    mainScreen.style.display = 'flex';
                    studentSelectionError.textContent = '';
                    studentPasswordInput.value = '';

                    // Fotoğraf yükleme işlemi...
                    database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/photo`).once('value').then(photoSnapshot => {
                        if (photoSnapshot.exists()) {
                            const photoURL = photoSnapshot.val();
                            studentPhoto.src = photoURL;
                            studentPhoto.style.display = 'block';
                        } else {
                            studentPhoto.style.display = 'none';
                        }
                    }).catch(error => {
                        console.error("Fotoğraf çekilirken hata:", error);
                        studentPhoto.style.display = 'none';
                    });

                    studentName.textContent = selectedStudent.studentName;
                    await addLoggedInPlayer(selectedStudent);
                    startInvitationListener(selectedStudent.studentId);
                    fetchAndDisplayGameCup();
                    onMainScreenLoad();

                    localStorage.setItem('selectedStudent', JSON.stringify(selectedStudent));
                } else {
                    studentSelectionError.textContent = 'Yanlış şifre. Lütfen tekrar deneyiniz.';
                }
            } else {
                studentSelectionError.textContent = 'Bu öğrenci için şifre tanımlanmamış.';
            }
        }).catch(error => {
            console.error("Şifre kontrol hata:", error);
            studentSelectionError.textContent = 'Şifre kontrol edilirken hata oluştu.';
        });

    } catch (error) {
        console.error("Kullanıcı arama hatası:", error);
        studentSelectionError.textContent = 'Bir hata oluştu. Lütfen tekrar deneyin.';
    }
});

// Elmas sayısını güncelleme fonksiyonu
// Elmas sayısını güncelleme fonksiyonu
async function updateDiamondCount() {
    if (!selectedStudent?.studentId) return;
    
    try {
        const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
        const snapshot = await studentRef.once('value');
        const userData = snapshot.val();
        
        const currentTime = Date.now();
        const lastUpdate = userData.lastDiamondUpdate || currentTime;
        const hoursPassed = Math.floor((currentTime - lastUpdate) / (1000 * 60 * 60));
        
        if (hoursPassed > 0) {
            // Mevcut elmas sayısı
            let currentDiamonds = userData.diamond || 0;
            
            // Eğer mevcut elmas sayısı 30'dan küçükse saatlik artış uygula
            if (currentDiamonds < 30) {
                // Eklenecek elmas sayısı (saatte 1)
                let diamondsToAdd = hoursPassed * 10;
                // Yeni toplam elmas sayısı (maksimum 30)
                let newDiamonds = Math.min(currentDiamonds + diamondsToAdd, 30);
                
                await studentRef.update({
                    diamond: newDiamonds,
                    lastDiamondUpdate: currentTime
                });
                
                document.getElementById('diamond-value').textContent = newDiamonds;
            } else {
                // Elmas sayısı zaten 30 veya üzerindeyse mevcut değeri koru
                document.getElementById('diamond-value').textContent = currentDiamonds;
                await studentRef.update({
                    lastDiamondUpdate: currentTime
                });
            }
        } else {
            document.getElementById('diamond-value').textContent = userData.diamond || 0;
        }
    } catch (error) {
        console.error("Elmas güncelleme hatası:", error);
    }
}

// Ana ekrana gelindiğinde elmas sayısını güncelle
function onMainScreenLoad() {
    updateDiamondCount();
    
    const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
    studentRef.once('value').then(snapshot => {
        const userData = snapshot.val();
        const creditsStats = document.getElementById('credits-stats');
        const creditsValue = document.getElementById('duel-credits-value');
        
        // Sınırsız hak kontrolü
        if (userData.unlimitedCreditsUntil && userData.unlimitedCreditsUntil > Date.now()) {
            creditsStats.classList.add('unlimited');
            // Kalan süreyi hesapla
            const daysLeft = Math.ceil((userData.unlimitedCreditsUntil - Date.now()) / (1000 * 60 * 60 * 24));
            creditsValue.innerHTML = `<span class="unlimited-badge">${daysLeft}Gün</span>`;
        } else {
            creditsStats.classList.remove('unlimited');
            creditsValue.textContent = userData.duelCredits || 0;
        }
    });
    
    setInterval(updateDiamondCount, 1000 * 60 * 60);
}


// Yeni input elementi için referans
const selectionNameInput = document.getElementById('selection-name-input');

// Login butonuna yeni kontrol fonksiyonu
async function handleLogin() {
    const enteredUsername = selectionNameInput.value.trim();
    const selectedClass = selectionClassSelect.value;
    const enteredPassword = studentPasswordInput.value.trim();

    if (!enteredUsername || !selectedClass || !enteredPassword) {
        studentSelectionError.textContent = 'Lütfen tüm alanları doldurunuz.';
        return;
    }

    try {
        // Kullanıcı adını veritabanında ara
        const studentsRef = database.ref(`classes/${selectedClass}/students`);
        const snapshot = await studentsRef.orderByChild('name').equalTo(enteredUsername).once('value');

        if (!snapshot.exists()) {
            studentSelectionError.textContent = 'Kullanıcı bulunamadı.';
            return;
        }

        // Kullanıcı bilgilerini al
        const studentData = Object.entries(snapshot.val())[0];
        const studentId = studentData[0];
        const studentInfo = studentData[1];

        // Şifre kontrolü
        if (enteredPassword !== studentInfo.password) {
            studentSelectionError.textContent = 'Yanlış şifre.';
            return;
        }

        // Login işlemleri
        selectedStudent = {
            classId: selectedClass,
            studentId: studentId,
            studentName: studentInfo.name
        };

        // Ana ekrana geçiş ve diğer işlemler
        mainScreen.style.display = 'flex';
        studentSelectionScreen.style.display = 'none';
        studentSelectionError.textContent = '';
        studentPasswordInput.value = '';

        // Fotoğraf ve diğer bilgileri yükle
        if (studentInfo.photo) {
            studentPhoto.src = studentInfo.photo;
            studentPhoto.style.display = 'block';
        } else {
            studentPhoto.style.display = 'none';
        }

        studentName.textContent = studentInfo.name;
        await addLoggedInPlayer(selectedStudent);
        startInvitationListener(selectedStudent.studentId);
        fetchAndDisplayGameCup();
        onMainScreenLoad();

        localStorage.setItem('selectedStudent', JSON.stringify(selectedStudent));

    } catch (error) {
        console.error("Login hatası:", error);
        studentSelectionError.textContent = 'Bir hata oluştu. Lütfen tekrar deneyin.';
    }
}

// Ana değişkenler
const friendsButton = document.querySelector('.friends-button');
const friendsScreen = document.getElementById('friends-screen');
const friendSearchInput = document.getElementById('friend-search');
const searchButton = document.getElementById('search-button');
const searchResults = document.getElementById('search-results');
const friendsList = document.getElementById('friends-list');

// Arkadaşlar butonuna tıklama olayı
friendsButton.addEventListener('click', () => {
    mainScreen.style.display = 'none';
    friendsScreen.style.display = 'flex';
    loadFriendsList(); // Arkadaş listesini yükle
});

// Geri dön butonu için olay dinleyici
friendsScreen.querySelector('.back-button').addEventListener('click', () => {
    friendsScreen.style.display = 'none';
    mainScreen.style.display = 'flex';
});

// Arkadaş arama işlevi
searchButton.addEventListener('click', searchFriends);
friendSearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchFriends();
    }
});

async function searchFriends() {
    const searchTerm = friendSearchInput.value.toLowerCase().trim();
    if (!searchTerm) return;
    
    searchResults.innerHTML = '<div class="loading">Aranıyor...</div>';
    
    try {
        // Sadece öğrencinin kendi sınıfını referans al
        const classRef = database.ref(`classes/${selectedStudent.classId}`);
        const snapshot = await classRef.once('value');
        const results = [];
        
        const classData = snapshot.val();
        const students = classData.students;
        
        if (students) {
            Object.entries(students).forEach(([studentId, studentData]) => {
                if (studentData.name?.toLowerCase().includes(searchTerm) && 
                    studentId !== selectedStudent.studentId) {
                    results.push({
                        studentId,
                        classId: selectedStudent.classId,
                        className: classData.name || selectedStudent.classId,
                        ...studentData
                    });
                }
            });
        }
        
        displaySearchResults(results);
    } catch (error) {
        console.error("Arama hatası:", error);
        searchResults.innerHTML = '<div class="error">Arama hatası oluştu</div>';
    }
}








// Merkezi puanlama fonksiyonu
async function updateDuelScore(type, data) {
    const {inviterId, inviterClassId, invitedId, invitedClassId} = data;
    
    try {
        switch(type) {
            case 'TIME_OUT':
                // Süre dolduğunda davet eden -3, misafir +6
                await Promise.all([
                    database.ref(`classes/${inviterClassId}/students/${inviterId}/gameCup`)
                        .transaction(current => Math.max((current || 0) - 3, 0)),
                    database.ref(`classes/${invitedClassId}/students/${invitedId}/gameCup`)
                        .transaction(current => (current || 0) + 6)
                ]);
                await showAlert('⏰ Süre doldu! Misafir oyuncu kazandı. (-3/+6 🏆)');
                break;

            case 'DISCONNECTED':
                // Ayrılan oyuncu -3, kalan oyuncu +6
                const disconnectedId = data.disconnectedId;
                const disconnectedClassId = data.disconnectedClassId;
                const remainingId = disconnectedId === inviterId ? invitedId : inviterId;
                const remainingClassId = disconnectedId === inviterId ? invitedClassId : inviterClassId;
                
                await Promise.all([
                    database.ref(`classes/${disconnectedClassId}/students/${disconnectedId}/gameCup`)
                        .transaction(current => Math.max((current || 0) - 3, 0)),
                    database.ref(`classes/${remainingClassId}/students/${remainingId}/gameCup`)
                        .transaction(current => (current || 0) + 6)
                ]);
                await showAlert('👋 Rakip ayrıldı! (+6 🏆)');
                break;

            case 'GAME_END':
                // Normal oyun sonu: Kazanan +6, Kaybeden -3
                const {winnerId, winnerClassId, loserId, loserClassId} = data;
                await Promise.all([
                    database.ref(`classes/${winnerClassId}/students/${winnerId}/gameCup`)
                        .transaction(current => (current || 0) + 3),
                    database.ref(`classes/${loserClassId}/students/${loserId}/gameCup`)
                        .transaction(current => Math.max((current || 0) - 1.5, 0))
                ]);
                const message = winnerId === selectedStudent.studentId ? 
                    '🎉 Tebrikler! Düelloyu kazandınız! (+6 🏆)' :
                    '😔 Maalesef kaybettiniz. (-3 🏆)';
                await showAlert(message);
                break;
        }
        return true;
    } catch (error) {
        console.error('Puan güncelleme hatası:', error);
        await showAlert('❌ Puan güncellenirken bir hata oluştu!');
        return false;
    }
}
















async function displaySearchResults(results) {
    searchResults.innerHTML = '';
    if (!results.length) {
        searchResults.innerHTML = '<div class="no-results">Sonuç bulunamadı</div>';
        return;
    }

    for (const student of results) {
        const friendshipRef = database.ref(`friendships/${selectedStudent.studentId}/${student.studentId}`);
        const isFriend = (await friendshipRef.once('value')).exists();
        
        const inDuelRef = database.ref(`classes/${student.classId}/students/${student.studentId}/inDuel`);
        const inDuel = (await inDuelRef.once('value')).val();

        const li = document.createElement('li');
        li.className = 'player-item';

        const photo = student.photo || 'https://via.placeholder.com/50';
        const className = classNameMap[student.classId] || student.classId;

        // Arkadaşlık durumuna göre buton veya metin gösterme
        let actionHtml = '';
        if (inDuel) {
            actionHtml = '<button class="oyunda-button" disabled>Oyunda</button>';
        } else if (isFriend) {
            actionHtml = '<span class="friend-added-text" style="padding: 8px 14px; background-color: #e9ecef; color: #495057; border-radius: 6px;">Arkadaşsınız</span>';
        } else {
            actionHtml = '<button class="add-friend-button">+ Arkadaş Ekle</button>';
        }

        li.innerHTML = `
            <img src="${photo}" alt="${student.name}" class="player-photo">
            <span class="player-name">${student.name} / (${className})</span>
            ${actionHtml}
        `;

        // Sadece arkadaş değilse ve oyunda değilse buton işlevselliği ekle
        if (!isFriend && !inDuel) {
            const button = li.querySelector('.add-friend-button');
            if (button) {
                button.onclick = () => addFriend({
                    id: student.studentId,
                    name: student.name,
                    classId: student.classId,
                    className,
                    photo: student.photo
                });
            }
        }

        searchResults.appendChild(li);
    }
}


async function addFriend(student) {
    try {
        const currentFriendsRef = database.ref(`friendships/${selectedStudent.studentId}`);
        const snapshot = await currentFriendsRef.once('value');
        if (snapshot.numChildren() >= 10) {
            showAlert('En fazla 10 arkadaş ekleyebilirsiniz!');
            return;
        }

        const friendshipData = {
            friendId: student.id,
            friendName: student.name,
            friendClassId: student.classId,
            friendClassName: student.className,
            friendPhoto: student.photo || null,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        await Promise.all([
            database.ref(`friendships/${selectedStudent.studentId}/${student.id}`).set(friendshipData),
            database.ref(`friendships/${student.id}/${selectedStudent.studentId}`).set({
                friendId: selectedStudent.studentId,
                friendName: selectedStudent.studentName,
                friendClassId: selectedStudent.classId,
                friendClassName: classNameMap[selectedStudent.classId],
                friendPhoto: studentPhoto.src || null,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            })
        ]);

        showAlert('Arkadaş başarıyla eklendi!');
        loadFriendsList();
        searchFriends();
    } catch (error) {
        showAlert('Arkadaş eklenirken hata oluştu');
    }
}

async function checkIfFriend(friendId) {
    const snapshot = await database.ref(`friendships/${selectedStudent.studentId}/${friendId}`).once('value');
    return snapshot.exists();
}

async function addFriend(student) {
    try {
        // Önce mevcut arkadaş sayısını kontrol et
        const currentFriendsRef = database.ref(`friendships/${selectedStudent.studentId}`);
        const snapshot = await currentFriendsRef.once('value');
        const currentFriendsCount = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;

        if (currentFriendsCount >= 10) {
            showAlert('En fazla 10 arkadaş ekleyebilirsiniz!');
            return;
        }

        // Arkadaş zaten ekli mi kontrol et
        const existingFriendRef = database.ref(`friendships/${selectedStudent.studentId}/${student.id}`);
        const existingFriend = await existingFriendRef.once('value');
        
        if (existingFriend.exists()) {
            showAlert('Bu kişi zaten arkadaş listenizde!');
            return;
        }

        const friendshipRef = database.ref(`friendships/${selectedStudent.studentId}/${student.id}`);
        await friendshipRef.set({
            friendId: student.id,
            friendName: student.name,
            friendClassId: student.classId,
            friendClassName: classNameMap[student.classId] || student.classId,
            friendPhoto: student.photo || null,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        showAlert('Arkadaş başarıyla eklendi!');
        loadFriendsList(); // Listeyi yenile

    } catch (error) {
        console.error('Arkadaş ekleme hatası:', error);
        showAlert('Arkadaş eklenirken bir hata oluştu. Lütfen tekrar deneyin.');
    }
}

// Arkadaş listesini yükleme fonksiyonunu güncelle
async function loadFriendsList() {
    try {
        // Cache key oluştur
        const CACHE_KEY = `friendsList_${selectedStudent.studentId}`;
        const CACHE_DURATION = 30000; // 30 saniye

        friendsList.innerHTML = '<div class="loading">Yükleniyor...</div>';

        // Cache kontrolü
        const cachedData = localStorage.getItem(CACHE_KEY);
        const cachedTime = localStorage.getItem(`${CACHE_KEY}_time`);
        
        if (cachedData && cachedTime && (Date.now() - parseInt(cachedTime)) < CACHE_DURATION) {
            friendsList.innerHTML = '';
            const friends = JSON.parse(cachedData);
            await displayCachedFriends(friends);
            return;
        }

        const friendshipsRef = database.ref(`friendships/${selectedStudent.studentId}`);
        const snapshot = await friendshipsRef.once('value');

        if (!snapshot.exists()) {
            friendsList.innerHTML = '<div class="no-friends">Henüz arkadaşınız yok</div>';
            return;
        }

        friendsList.innerHTML = '';
        const friends = [];

        // Arkadaşları topla
        for (const [friendId, friendData] of Object.entries(snapshot.val())) {
            // Batch sorgu için referansları hazırla
            const photoRef = database.ref(`classes/${friendData.friendClassId}/students/${friendId}/photo`);
            const inDuelRef = database.ref(`classes/${friendData.friendClassId}/students/${friendId}/inDuel`);
            
            // Paralel sorgu yap
            const [photoSnap, inDuelSnap] = await Promise.all([
                photoRef.once('value'),
                inDuelRef.once('value')
            ]);

            const currentPhoto = photoSnap.exists() ? photoSnap.val() : (friendData.friendPhoto || 'https://via.placeholder.com/50');
            const inDuel = inDuelSnap.val() || false;

            friends.push({
                studentId: friendId,
                name: friendData.friendName,
                classId: friendData.friendClassId,
                className: friendData.friendClassName,
                photo: currentPhoto,
                inDuel: inDuel,
                isOnline: false
            });
        }

        // Tüm online durumları tek sorguda al
        const loggedInRef = database.ref('loggedinPlayers');
        const loggedInSnapshot = await loggedInRef.once('value');
        const onlinePlayers = loggedInSnapshot.val() || {};

        // Online durumlarını güncelle
        friends.forEach(friend => {
            friend.isOnline = Object.values(onlinePlayers).some(
                player => player.studentId === friend.studentId
            );
        });

        // Stil tanımlaması
        const style = document.createElement('style');
        style.textContent = `
            .remove-friend-button {
                background-color: #dc3545;
                color: white;
                border: none;
                border-radius: 50%;
                width: 25px;
                height: 25px;
                line-height: 25px;
                text-align: center;
                cursor: pointer;
                margin-left: 10px;
                font-size: 14px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
            
            .remove-friend-button:hover {
                background-color: #c82333;
                transform: scale(1.1);
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
        `;
        document.head.appendChild(style);

        // Cache'e kaydet
        localStorage.setItem(CACHE_KEY, JSON.stringify(friends));
        localStorage.setItem(`${CACHE_KEY}_time`, Date.now().toString());

        // Arkadaş listesini göster
        friends.forEach(friend => {
            const li = document.createElement('li');
            li.className = 'player-item';

            let buttonClass = 'davet-et-button';
            let buttonText = 'Davet Et';
            let isDisabled = false;

            if (friend.inDuel) {
                buttonClass = 'oyunda-button';
                buttonText = 'Oyunda';
                isDisabled = true;
            } else if (!friend.isOnline) {
                buttonClass = 'offline-button';
                buttonText = 'Çevrimdışı';
                isDisabled = true;
            }

            li.innerHTML = `
                <img src="${friend.photo}" alt="${friend.name}" class="player-photo">
                <span class="player-name">${friend.name} / (${friend.className})</span>
                <div style="display: flex; align-items: center;">
                    <button class="${buttonClass}" ${isDisabled ? 'disabled' : ''}>${buttonText}</button>
                    <button class="remove-friend-button" title="Arkadaşı Sil">✖</button>
                </div>
            `;

            if (!isDisabled) {
                const davetButton = li.querySelector(`.${buttonClass}`);
                davetButton.onclick = () => sendInvitation(friend);
            }

            const removeButton = li.querySelector('.remove-friend-button');
            removeButton.onclick = async (e) => {
                e.stopPropagation();
                if (await showConfirmation(`${friend.name} arkadaşlıktan çıkarılacak. Emin misiniz?`)) {
                    await removeFriend(friend.studentId);
                    await loadFriendsList();
                }
            };

            friendsList.appendChild(li);
        });

    } catch (error) {
        console.error('Arkadaş listesi yükleme hatası:', error);
        friendsList.innerHTML = '<div class="error">Liste yüklenirken bir hata oluştu</div>';
    }
}

// Cache'den arkadaş listesini gösterme fonksiyonu
async function displayCachedFriends(friends) {
    for (const friend of friends) {
        const li = document.createElement('li');
        li.className = 'player-item';

        let buttonClass = 'davet-et-button';
        let buttonText = 'Davet Et';
        let isDisabled = false;

        if (friend.inDuel) {
            buttonClass = 'oyunda-button';
            buttonText = 'Oyunda';
            isDisabled = true;
        } else if (!friend.isOnline) {
            buttonClass = 'offline-button';
            buttonText = 'Çevrimdışı';
            isDisabled = true;
        }

        li.innerHTML = `
            <img src="${friend.photo}" alt="${friend.name}" class="player-photo">
            <span class="player-name">${friend.name} / (${friend.className})</span>
            <div style="display: flex; align-items: center;">
                <button class="${buttonClass}" ${isDisabled ? 'disabled' : ''}>${buttonText}</button>
                <button class="remove-friend-button" title="Arkadaşı Sil">✖</button>
            </div>
        `;

        if (!isDisabled) {
            const davetButton = li.querySelector(`.${buttonClass}`);
            davetButton.onclick = () => sendInvitation(friend);
        }

        const removeButton = li.querySelector('.remove-friend-button');
        removeButton.onclick = async (e) => {
            e.stopPropagation();
            if (await showConfirmation(`${friend.name} arkadaşlıktan çıkarılacak. Emin misiniz?`)) {
                await removeFriend(friend.studentId);
                await loadFriendsList();
            }
        };

        friendsList.appendChild(li);
    }
}

// Arkadaş silme fonksiyonu
async function removeFriend(friendId) {
    try {
        // Her iki taraftan da arkadaşlığı kaldır
        await database.ref(`friendships/${selectedStudent.studentId}/${friendId}`).remove();
        await database.ref(`friendships/${friendId}/${selectedStudent.studentId}`).remove();
        await showAlert('Arkadaş başarıyla silindi!');
    } catch (error) {
        console.error('Arkadaş silme hatası:', error);
        await showAlert('Arkadaş silinirken bir hata oluştu!');
    }
}

function showConfirmation(message) {
    return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        `;

        const dialog = document.createElement('div');
        dialog.style.cssText = `
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        `;

        dialog.innerHTML = `
            <p style="margin-bottom: 20px;">${message}</p>
            <button id="confirmYes" style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 8px 20px;
                border-radius: 5px;
                margin-right: 10px;
                cursor: pointer;
            ">Evet</button>
            <button id="confirmNo" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 8px 20px;
                border-radius: 5px;
                cursor: pointer;
            ">Hayır</button>
        `;

        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        const handleClick = (result) => {
            document.body.removeChild(overlay);
            resolve(result);
        };

        dialog.querySelector('#confirmYes').onclick = () => handleClick(true);
        dialog.querySelector('#confirmNo').onclick = () => handleClick(false);
    });
}




        backButtons.forEach(backButton => {
            backButton.addEventListener('click', () => {
                const currentScreen = backButton.parentElement;
                if(currentScreen.id === 'duel-selection-screen' && currentDuelRef) {
                    // Düello referansını kaldır ve sayfayı yenile
                    currentDuelRef.remove().then(() => {
                        // Her iki oyuncunun inDuel durumunu false yap
                        currentDuelRef.once('value').then(async (snapshot) => {
                            if (snapshot.exists()) {
                                const data = snapshot.val();
                                const inviterRef = database.ref(`classes/${data.inviter.classId}/students/${data.inviter.studentId}/inDuel`);
                                const invitedRef = database.ref(`classes/${data.invited.classId}/students/${data.invited.studentId}/inDuel`);
                                try {
                                    await inviterRef.set(false);
                                    await invitedRef.set(false);
                                } catch (error) {
                                    console.error("inDuel güncellenirken hata:", error);
                                }
                            }
                        });
                        currentDuelRef = null;
                        isInviter = false;
                        duelGameStarted = false;
                        window.location.reload();
                    }).catch(error => {
                        console.error("Düello referansı kaldırılırken hata:", error);
                        showAlert('Düello referansı kaldırılırken hata oluştu.');
                    });
                } else {
                    currentScreen.style.display = 'none';
                    mainScreen.style.display = 'flex';
                    resetGameScreens();
                }
            });
        });

        singlePlayerButton.addEventListener('click', () => {
            mainScreen.style.display = 'none';
            singlePlayerScreen.style.display = 'flex';
        });

        startGameButton.addEventListener('click', () => {
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            const selectedTopic = topicSelect.value;

            if (selectedClass && selectedSubject && selectedTopic) {
                fetchQuestions(selectedClass, selectedSubject, selectedTopic);
            } else {
                showAlert('Lütfen tüm alanları doldurunuz.');
            }
        });


        async function handlePasswordUpdate(classId, studentId) {
            const newPassword = await showPrompt('Yeni şifreyi giriniz:');
            if (newPassword !== null) {
                if (newPassword.trim() !== "") {
                    database.ref(`classes/${classId}/students/${studentId}/password`).set(newPassword.trim()).then(() => {
                        showAlert('Şifre oluşturuldu/güncellendi.');
                    }).catch(error => {
                        console.error("Şifre güncellenirken hata:", error);
                        showAlert('Şifre güncellerken hata oluştu.');
                    });
                } else {
                    showAlert('Şifre boş olamaz.');
                }
            }
        }



       // GÜNCELLENMİŞ HAL
function fetchChampionData() {
    const CACHE_KEY = 'cachedChampionData';
    const CACHE_TIMESTAMP_KEY = 'cachedChampionDataTimestamp';
    const CACHE_DURATION = 15 * 60 * 1000; // 15 dakika

    const cachedChampionData = localStorage.getItem(CACHE_KEY);
    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
    const now = Date.now();

    if (cachedChampionData && cachedTimestamp) {
        const age = now - parseInt(cachedTimestamp, 10);
        if (age < CACHE_DURATION) {
            // Cache süresi dolmamış, veriyi kullan
            const parsedData = JSON.parse(cachedChampionData);
            populateChampionSelect(parsedData);
            return;
        } else {
            // Cache süresi dolmuş, temizle
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIMESTAMP_KEY);
        }
    }

    // Cache yok veya süresi dolmuş, Firebase'den çek
    database.ref('championData/headings').once('value')
        .then(snapshot => {
            if (!snapshot.exists()) {
                console.warn("championData/headings boş.");
                return;
            }
            const result = [];
            snapshot.forEach(childSnapshot => {
                result.push({
                    id: childSnapshot.key,
                    name: childSnapshot.val().name || "No name"
                });
            });

            // localStorage’a kaydet
            localStorage.setItem(CACHE_KEY, JSON.stringify(result));
            localStorage.setItem(CACHE_TIMESTAMP_KEY, now.toString());

            // Seçime aktar
            populateChampionSelect(result);
        })
        .catch(error => {
            console.error("Sınıf bilgileri hata:", error);
        });
}

function populateChampionSelect(data) {
    // Önce mevcut seçenekleri temizleyin
    classSelect.innerHTML = '<option value="">Seçiniz</option>';

    data.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        classSelect.appendChild(option);
    });
}



async function fetchLessons(classId, subjectSelectElement) {
    const CACHE_KEY = `cachedLessons_${classId}`;
    const CACHE_TIMESTAMP_KEY = `cachedLessonsTimestamp_${classId}`;
    const CACHE_DURATION = 15 * 60 * 1000;

    // Select elementini temizle
    subjectSelectElement.innerHTML = '<option value="">Seçiniz</option>';
    if (!classId) return false;

    try {
        // Önce seçimleri Firebase'den kontrol et (davet edilen için)
        if (!isInviter && currentDuelRef) {
            const selectionsSnapshot = await currentDuelRef.child('selections').once('value');
            if (selectionsSnapshot.exists()) {
                const selections = selectionsSnapshot.val();
                if (selections.subject) {
                    // Cache'i kontrol et
                    const cachedLessons = localStorage.getItem(CACHE_KEY);
                    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                    const now = Date.now();

                    if (cachedLessons && cachedTimestamp && (now - parseInt(cachedTimestamp, 10)) < CACHE_DURATION) {
                        const parsedLessons = JSON.parse(cachedLessons);
                        populateLessonsSelect(parsedLessons, subjectSelectElement);
                        subjectSelectElement.value = selections.subject;
                        return true;
                    }
                }
            }
        }

        // Firebase'den dersleri çek
        const snapshot = await database.ref(`championData/headings/${classId}/lessons`).once('value');
        if (snapshot.exists()) {
            const lessonsData = [];
            snapshot.forEach(childSnapshot => {
                const lessonId = childSnapshot.key;
                const lessonName = childSnapshot.val().name || 'No name';
                lessonsData.push({ id: lessonId, name: lessonName });
            });

            // Cache'e kaydet
            localStorage.setItem(CACHE_KEY, JSON.stringify(lessonsData));
            localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());

            // Select'i doldur
            populateLessonsSelect(lessonsData, subjectSelectElement);

            // Davet edilen için seçili dersi ayarla
            if (!isInviter && currentDuelRef) {
                const selections = (await currentDuelRef.child('selections').once('value')).val();
                if (selections && selections.subject) {
                    subjectSelectElement.value = selections.subject;
                }
            }

            return true;
        }
        return false;
    } catch (error) {
        console.error("Dersler yüklenirken hata:", error);
        return false;
    }
}

async function fetchTopics(classId, lessonId, topicSelectElement) {
    const CACHE_KEY = `cachedTopics_${classId}_${lessonId}`;
    const CACHE_TIMESTAMP_KEY = `cachedTopicsTimestamp_${classId}_${lessonId}`;
    const CACHE_DURATION = 15 * 60 * 1000;

    topicSelectElement.innerHTML = '<option value="">Seçiniz</option>';
    if (!classId || !lessonId) return false;

    try {
        // Önce seçimleri Firebase'den kontrol et (davet edilen için)
        if (!isInviter && currentDuelRef) {
            const selectionsSnapshot = await currentDuelRef.child('selections').once('value');
            if (selectionsSnapshot.exists()) {
                const selections = selectionsSnapshot.val();
                if (selections.topic) {
                    // Cache'i kontrol et
                    const cachedTopics = localStorage.getItem(CACHE_KEY);
                    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                    const now = Date.now();

                    if (cachedTopics && cachedTimestamp && (now - parseInt(cachedTimestamp, 10)) < CACHE_DURATION) {
                        const parsedTopics = JSON.parse(cachedTopics);
                        populateTopicsSelect(parsedTopics, topicSelectElement);
                        topicSelectElement.value = selections.topic;
                        return true;
                    }
                }
            }
        }

        // Firebase'den konuları çek
        const snapshot = await database.ref(`championData/headings/${classId}/lessons/${lessonId}/topics`).once('value');
        if (snapshot.exists()) {
            const topicsData = [];
            snapshot.forEach(childSnapshot => {
                const topicId = childSnapshot.key;
                const topicName = childSnapshot.val().name || 'No name';
                topicsData.push({ id: topicId, name: topicName });
            });

            // Cache'e kaydet
            localStorage.setItem(CACHE_KEY, JSON.stringify(topicsData));
            localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());

            // Select'i doldur
            populateTopicsSelect(topicsData, topicSelectElement);

            // Davet edilen için seçili konuyu ayarla
            if (!isInviter && currentDuelRef) {
                const selections = (await currentDuelRef.child('selections').once('value')).val();
                if (selections && selections.topic) {
                    topicSelectElement.value = selections.topic;
                }
            }

            return true;
        }
        return false;
    } catch (error) {
        console.error("Konular yüklenirken hata:", error);
        return false;
    }
}

// populateSelect fonksiyonları aynı kalabilir
function populateLessonsSelect(lessonsData, subjectSelectElement) {
    lessonsData.forEach(lesson => {
        const option = document.createElement('option');
        option.value = lesson.id;
        option.textContent = lesson.name;
        subjectSelectElement.appendChild(option);
    });
}

function populateTopicsSelect(topicsData, topicSelectElement) {
    topicsData.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.id;
        option.textContent = topic.name;
        topicSelectElement.appendChild(option);
    });
}



        const singlePlayerSelects = singlePlayerScreen.querySelectorAll('select');
        singlePlayerSelects.forEach(select => {
            select.addEventListener('change', checkSinglePlayerSelections);
        });

        function checkSinglePlayerSelections() {
            let allSelected = true;
            singlePlayerSelects.forEach(select => {
                if (select.value === "") {
                    allSelected = false;
                }
            });

            if (allSelected) {
                startGameButton.classList.add('active');
                startGameButton.disabled = false;
            } else {
                startGameButton.classList.remove('active');
                startGameButton.disabled = true;
            }
        }

selectionClassSelect.addEventListener('change', () => {
    if (selectionClassSelect.value === "") {
        selectionNameInput.disabled = true;
        selectionNameInput.value = "";
    } else {
        selectionNameInput.disabled = false;
    }
    checkLoginButtonState();
});



function checkLoginButtonState() {
    if (selectionClassSelect.value !== "" && selectionNameInput.value.trim() !== "") {
        loginButton.classList.add('active');
        loginButton.disabled = false;
        studentPasswordInput.disabled = false;
    } else {
        loginButton.classList.remove('active');
        loginButton.disabled = true;
        studentPasswordInput.disabled = true;
        studentPasswordInput.value = '';
    }
}

        classSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            fetchLessons(selectedClass, subjectSelect);
        });

        subjectSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            const selectedLesson = subjectSelect.value;
            fetchTopics(selectedClass, selectedLesson, topicSelect);
        });

        function resetGameScreens() {
            // Tek Kişilik Oyun Ekranı
            singlePlayerSelects.forEach(select => {
                select.value = "";
            });
            startGameButton.classList.remove('active');
            startGameButton.disabled = true;

            scoreContainer.style.display = 'none';
            scoreDisplay.textContent = '';
            scoreMessage.textContent = '';
            scoreMessage.className = 'score-message';
            scoreImage.style.display = 'none';

            // Düello Oyun Ekranı
            duelQuestionNumber.textContent = 'Soru 1/10';
            duelProgressBarInner.style.width = '0%';
            duelTimerElement.textContent = '45';
            duelTimerElement.style.color = '#ff0000';

            // Yeni eklenen sıfırlamalar
            gameQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            clearInterval(timer);

            // Tek Kişilik Oyun Müziğini Durdur
            singlePlayerQuestionMusic.pause();
            singlePlayerQuestionMusic.currentTime = 0;

            // Düello Oyun Müziğini Durdur
            duelMusic.pause();
            duelMusic.currentTime = 0;
        }

// "Çıkış Yap" Butonunu Seçme
const logoutButton = document.getElementById('logout-button');

// "Çıkış Yap" Butonuna Event Listener Ekleme
logoutButton.addEventListener('click', async () => {
   try {
       // Önce seçili öğrencinin inDuel durumunu false yap
       if (selectedStudent && selectedStudent.classId && selectedStudent.studentId) {
           await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).set(false);
       }

       // Düello referansını temizle
       if (currentDuelRef) {
           await currentDuelRef.remove();
           currentDuelRef = null;
       }

       // Kullanıcıya özel tüm cache'leri temizle
       if (selectedStudent?.studentId) {
           Object.values(CACHE_KEYS).forEach(key => {
               const userKey = getUserSpecificCacheKey(key);
               localStorage.removeItem(userKey);
           });
       }

       // localStorage'ı temizle
       localStorage.removeItem('selectedStudent');

       // Loggedin player'ı kaldır
       if (loggedinPlayerRef) {
           await loggedinPlayerRef.remove();
           console.log("Kullanıcı Firebase'den başarıyla kaldırıldı.");
       }

       // Sayfayı yenile
       window.location.reload();

   } catch (error) {
       console.error("Çıkış yaparken hata oluştu:", error);
       showAlert('Çıkış yaparken bir hata oluştu. Lütfen tekrar deneyin.');
   }
});


        function fetchQuestions(classId, subjectId, topicId) {
    const questionsRef = database.ref(`championData/headings/${classId}/lessons/${subjectId}/topics/${topicId}/questions`);
    questionsRef.once('value').then(snapshot => {
        if (snapshot.exists()) {
            const allQuestions = [];
            snapshot.forEach(childSnapshot => {
                const questionData = childSnapshot.val();
                // Soru yapısını uyumlu hale getiriyoruz
const formattedQuestion = {
    info: questionData.question.info || '',
    actualQuestion: questionData.question.text || questionData.question,
    question: questionData.question.text || questionData.question, // Düzeltilmiş
    correct: questionData.correct,
    wrong1: questionData.wrong1,
    wrong2: questionData.wrong2
};
                allQuestions.push(formattedQuestion);
            });

            if (allQuestions.length < 10) {
                showAlert('Bu konuya ait yeterli soru yok.');
                return;
            }

            gameQuestions = shuffleArray(allQuestions).slice(0, 10);
            currentQuestionIndex = 0;
            score = 0;

            singlePlayerScreen.style.display = 'none';
            singlePlayerGameScreen.style.display = 'flex';
            scoreContainer.style.display = 'none';
            displayCurrentQuestion();

            // Tek Kişilik Oyun Müziğini Başlat
            singlePlayerQuestionMusic.currentTime = 0;
            singlePlayerQuestionMusic.play().catch(error => {
                console.error("Tek Kişilik Oyun Müziği Çalınamadı:", error);
            });
        } else {
            showAlert('Bu konuya ait soru bulunamadı.');
        }
    }).catch(error => {
        console.error("Sorular çekme hata:", error);
        showAlert('Sorular çekilirken hata oluştu.');
    });
}

        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

       function displayCurrentQuestion() {
    if (currentQuestionIndex >= gameQuestions.length) {
        endGame();
        return;
    }

    const currentQuestion = gameQuestions[currentQuestionIndex];
    questionNumber.textContent = `Soru ${currentQuestionIndex + 1}/10`;
    const progressPercentage = ((currentQuestionIndex) / 10) * 100;
    progressBarInner.style.width = `${progressPercentage}%`;

// Soru konteynerini temizle
const questionContainer = document.querySelector('.question-container');
questionContainer.innerHTML = '';

if (currentQuestion.question.startsWith('http')) {
  // Eğer soru resim URL'siyse
  const questionImage = document.createElement('img');
  questionImage.src = currentQuestion.question;
  questionImage.className = 'question-image';
  questionImage.style.display = 'block';
  questionImage.alt = "Soru resmi";
  questionContainer.appendChild(questionImage);

  if (currentQuestion.actualQuestion) {
    const questionTextDiv = document.createElement('div');
    questionTextDiv.className = 'question-text';
    questionTextDiv.textContent = currentQuestion.actualQuestion;
    questionContainer.appendChild(questionTextDiv);
  }
} else {
  // Metin şeklindeki soru için
  const textContainer = document.createElement('div');
textContainer.className = 'question-text-container';

// Eğer "info" alanı bir resim URL'si içeriyorsa (örneğin http://...png)
if (
  currentQuestion.info &&
  /^https?:\/\/.*\.(png|jpg|jpeg|gif)$/i.test(currentQuestion.info)
) {
  const infoImage = document.createElement('img');
  infoImage.src = currentQuestion.info;
  infoImage.alt = 'Bilgi resmi';
  infoImage.className = 'question-info-image'; // CSS ile boyutlandırma yapabilirsiniz
  textContainer.appendChild(infoImage);
} else {
  // Aksi halde, metin olarak göster
  const infoText = document.createElement('div');
  infoText.className = 'question-info-text';
  infoText.textContent = currentQuestion.info || '';
  textContainer.appendChild(infoText);
}

const divider = document.createElement('div');
divider.className = 'question-divider';
textContainer.appendChild(divider);

const questionText = document.createElement('div');
questionText.className = 'question-actual-text';
questionText.textContent = currentQuestion.question;
textContainer.appendChild(questionText);

questionContainer.appendChild(textContainer);

}

    // Seçenekleri oluştur
    const options = [
        { text: currentQuestion.correct, correct: true },
        { text: currentQuestion.wrong1, correct: false },
        { text: currentQuestion.wrong2, correct: false }
    ];
    
    const shuffledOptions = shuffleArray(options);
    optionsContainer.innerHTML = '';
    
    shuffledOptions.forEach(option => {
        const button = document.createElement('button');
        button.classList.add('option-button');
        button.textContent = option.text;
        button.dataset.correct = option.correct;
        button.addEventListener('click', selectOption);
        optionsContainer.appendChild(button);
    });

            // Görünürlük ayarları
            questionNumber.style.display = 'block';
            document.querySelector('.progress-container').style.display = 'block';
            document.querySelector('.timer-container').style.display = 'block';
            document.querySelector('.question-container').style.display = 'flex';
            optionsContainer.style.display = 'flex';

            // Timer'ı sıfırla ve başlat
            resetTimer();
            startTimer();
        }

        function selectOption(e) {
            const selectedButton = e.target;
            const isCorrect = selectedButton.dataset.correct === 'true';

            document.querySelectorAll('.option-button').forEach(button => {
                button.disabled = true;
                if (button !== selectedButton) {
                    button.classList.add('option-faded');
                } else {
                    button.classList.add('option-chosen');
                }
            });

            if (isCorrect) {
                selectedButton.classList.add('correct');
                score++;
            } else {
                selectedButton.classList.add('wrong');
                document.querySelectorAll('.option-button').forEach(button => {
                    if (button.dataset.correct === 'true') {
                        button.classList.add('correct');
                    }
                });
            }

            clearInterval(timer);

            setTimeout(() => {
                proceedToNextQuestion();
            }, 1000);
        }

        function proceedToNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < 10) {
                displayCurrentQuestion();
            } else {
                endGame();
            }
        }

        function endGame() {
            questionNumber.style.display = 'none';
            document.querySelector('.progress-container').style.display = 'none';
            document.querySelector('.timer-container').style.display = 'none';
            document.querySelector('.question-container').style.display = 'none';
            optionsContainer.style.display = 'none';

            scoreContainer.style.display = 'flex';
            scoreDisplay.textContent = `Doğru Sayısı: ${score}/10`;

            let message = '';
            let messageClass = '';
            let imageUrl = '';
            scoreMessage.style.display = 'block';

            if (score === 10) {
                message = 'ŞAHANE';
                messageClass = 'purple';
                imageUrl = 'https://i.giphy.com/YX8IKLsJJXagt5rZMV.webp';
            } else if (score >= 8 && score <= 9) {
                message = 'Gayet İyi';
                messageClass = 'green';
                imageUrl = 'https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHAxM2E0cGY1bmJxcXdvbDYxYXBrZjRncXV0dzJwMXZ4bzJ1bWxzNSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/AFmZwgpOXOqWwtcVve/giphy.webp';
            } else if (score >= 6 && score <= 7) {
                message = 'Daha iyisi olabilir.';
                messageClass = 'green';
                imageUrl = 'https://cdn.pixabay.com/photo/2019/10/28/14/35/emoticon-4584554_960_720.png';
            } else if (score >= 3 && score <= 5) {
                message = 'Kendini Geliştirmen Gerek.';
                messageClass = 'blue';
                imageUrl = 'https://cdn.pixabay.com/photo/2019/10/28/14/35/emoticon-4584554_960_720.png';
            } else {
                message = 'Başarısız Sonuç';
                messageClass = 'red';
                imageUrl = 'https://media.tenor.com/rPTWl04F5igAAAAM/byuntear-emoji.gif';
            }

            scoreMessage.textContent = message;
            if (messageClass !== '') {
                scoreMessage.classList.add(messageClass);
            } else {
                scoreMessage.textContent = '';
            }

            scoreImage.src = imageUrl;
            scoreImage.style.display = 'block';

            // Müzik çalma işlemi burada
            if (score > 9) { // Örneğin, belirli bir başarı düzeyinde müzik çalınır
                winnerMusic.currentTime = 0;
                winnerMusic.play().catch(error => {
                    console.error("Kazanan müziği çalınamadı:", error);
                });
            }
        }

        // "Geri Dön" butonu için event listener
        finalBackButton.addEventListener('click', () => {
            // Müzikleri durdur
            stopAllMusic();

            // Ekranları sıfırla ve ana ekrana dön
            singlePlayerGameScreen.style.display = 'none';
            mainScreen.style.display = 'flex';
            resetGameScreens();
        });

        // Tüm müzikleri durdurma fonksiyonu
        function stopAllMusic() {
            if (!duelMusic.paused) {
                duelMusic.pause();
                duelMusic.currentTime = 0;
            }
            if (!winnerMusic.paused) {
                winnerMusic.pause();
                winnerMusic.currentTime = 0;
            }
            if (!singlePlayerQuestionMusic.paused) {
                singlePlayerQuestionMusic.pause();
                singlePlayerQuestionMusic.currentTime = 0;
            }
        }

        // Kupa Sıralaması Butonuna Event Listener (Yan Panel Açma)
        kupaSiralamaButton.addEventListener('click', () => {
            rankingPanel.classList.add('open');
            loadRanking(); // Sıralamayı yükle
        });

        // Ranking Back Button Event Listener (Yan Panel Kapatma)
        rankingBackButton.addEventListener('click', () => {
            rankingPanel.classList.remove('open');
        });

        // Bu event listener, düello oyununun sonunda "Oyunu Sonlandır" butonunu özel işlevle değiştirir.
        // "Oyunu Sonlandır" butonunun işlevi, önce uyarıyı gösterir, ardından eski işlevini sürdürür.
        // Ayrıca, kazanan ekranında müziğin çalmasını sağlar.
        // (Bu kısım artık düello bitişte kazanan ekranında müzik çaldığı için kaldırıldı)

        function resetTimer() {
            clearInterval(timer);
            timeLeft = 45;
            timerElement.textContent = timeLeft;
            timerElement.style.color = '#ff0000';
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    markQuestionAsWrong();
                    setTimeout(() => {
                        proceedToNextQuestion();
                    }, 1000);
                }
            }, 1000);
        }

        function markQuestionAsWrong() {
            document.querySelectorAll('.option-button').forEach(button => {
                if (button.dataset.correct === 'true') {
                    button.classList.add('correct');
                } else {
                    button.classList.add('wrong');
                }
                button.disabled = true;
            });
        }

        // GÜNCELLENMİŞ HAL
function fetchClassesForSelection() {
    const CACHE_KEY = 'cachedClasses';
    const CACHE_TIMESTAMP_KEY = 'cachedClassesTimestamp';
    const CACHE_DURATION = 15 * 60 * 1000; // 15 dakika

    const cachedClasses = localStorage.getItem(CACHE_KEY);
    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
    const now = Date.now();

    if (cachedClasses && cachedTimestamp) {
        const age = now - parseInt(cachedTimestamp, 10);
        if (age < CACHE_DURATION) {
            // Cache süresi dolmamış, veriyi kullan
            const parsedClasses = JSON.parse(cachedClasses);
            populateClassSelect(parsedClasses);
            return;
        } else {
            // Cache süresi dolmuş, temizle
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIMESTAMP_KEY);
        }
    }

    // Cache yok veya süresi dolmuş, Firebase'den çek
    database.ref('classes').once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const classesData = [];
                snapshot.forEach(childSnapshot => {
                    const classId = childSnapshot.key;
                    const className = childSnapshot.val().name || classId;
                    classesData.push({ id: classId, name: className });
                });

                // LocalStorage'a kaydet
                localStorage.setItem(CACHE_KEY, JSON.stringify(classesData));
                localStorage.setItem(CACHE_TIMESTAMP_KEY, now.toString());

                // Seçime aktar
                populateClassSelect(classesData);
            } else {
                console.warn("Seçim için sınıf yok.");
            }
        })
        .catch(error => {
            console.error("Seçim için sınıf çekme hata:", error);
        });
}

// Doldurma fonksiyonu
function populateClassSelect(classesData) {
    // Önce mevcut seçenekleri temizleyin
    selectionClassSelect.innerHTML = '<option value="">Seçiniz</option>';
    
    classesData.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls.id;
        option.textContent = cls.name;
        selectionClassSelect.appendChild(option);
    });
}



        // Alert fonksiyonu
        const alertOverlay = document.getElementById('alertOverlay');
        const alertMessage = document.getElementById('alertMessage');
        const alertOkButton = document.getElementById('alertOkButton');

        function showAlert(message, showButton = true) {
    alertMessage.textContent = message;
    alertOverlay.style.display = 'flex';
    alertOkButton.style.display = showButton ? 'block' : 'none';
    return new Promise(resolve => {
        if (showButton) {
            alertOkButton.onclick = () => {
                alertOverlay.style.display = 'none';
                resolve();
            };
        } else {
            resolve();
        }
    });
}

        // Prompt fonksiyonu
        const promptOverlay = document.getElementById('promptOverlay');
        const promptMessage = document.getElementById('promptMessage');
        const promptInput = document.getElementById('promptInput');
        const promptCancelButton = document.getElementById('promptCancelButton');
        const promptOkButton = document.getElementById('promptOkButton');

        function showPrompt(message) {
            promptMessage.textContent = message;
            promptInput.value = '';
            promptOverlay.style.display = 'flex';

            return new Promise(resolve => {
                promptOkButton.onclick = () => {
                    const val = promptInput.value;
                    promptOverlay.style.display = 'none';
                    resolve(val);
                };

                promptCancelButton.onclick = () => {
                    promptOverlay.style.display = 'none';
                    resolve(null);
                };
            });
        }

        // Davet Etme ve Dinleme
async function sendInvitation(player) {
    try {
        console.log("Davet gönderilmeye çalışılıyor, oyuncu:", player);

        // --- 1. Kredi Kontrolleri ---
        // Davet edenin kredi kontrolü
        const inviterCreditsSnap = await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/duelCredits`).once('value');
        const inviterCredits = inviterCreditsSnap.exists() ? inviterCreditsSnap.val() : 0;
        if (inviterCredits < 3) {
            await showAlert('Düello başlatmak için en az 3 düello kredisine sahip olmalısınız.');
            return;
        }

        // Davet edilecek oyuncunun kredi kontrolü
        const invitedCreditsSnap = await database.ref(`classes/${player.classId}/students/${player.studentId}/duelCredits`).once('value');
        const invitedCredits = invitedCreditsSnap.exists() ? invitedCreditsSnap.val() : 0;
        if (invitedCredits < 3) {
            await showAlert(`${player.name} yeterli düello kredisine sahip değil.`);
            return;
        }
        // --- Kredi Kontrolleri Bitiş ---

        const inviterSnapshot = await database.ref('loggedinPlayers')
            .orderByChild('studentId')
            .equalTo(selectedStudent.studentId)
            .once('value');
            
        if (!inviterSnapshot.exists()) {
            showAlert('Bağlantı hatası! Lütfen tekrar giriş yapın.');
            return;
        }

        console.log("Davet gönderilecek oyuncu ID:", player.studentId);
        const invitationPath = `invitations/${player.studentId}`;
        console.log("Davet path:", invitationPath);
        
        const invitationRef = database.ref(invitationPath);
        const activeInviteSnapshot = await invitationRef.once('value');
        
        if (activeInviteSnapshot.exists()) {
            showAlert('Bu oyuncu şu anda başka bir davet değerlendiriyor.');
            return;
        }

        // --- 2. Reddedilen Davet Kontrolü ---
        const rejectedInviteRef = database.ref('rejectedInvites')
            .orderByChild('inviterId')
            .equalTo(selectedStudent.studentId);
            
        const snapshot = await rejectedInviteRef.once('value');
        let canSendInvite = true;
        let remainingTime = 0;
        const updates = {};
        let needsUpdate = false;

        if (snapshot.exists()) {
            snapshot.forEach(child => {
                const invite = child.val();
                if (invite.invitedId === player.studentId) {
                    const timeDiff = Date.now() - invite.timestamp;
                    if (timeDiff < 30000) {
                        canSendInvite = false;
                        remainingTime = Math.ceil((30000 - timeDiff) / 1000);
                    } else {
                        // 30 saniyeyi geçen kayıtları silmek için işaretle
                        updates[child.key] = null;
                        needsUpdate = true;
                    }
                }
            });

            if (needsUpdate) {
                await database.ref('rejectedInvites').update(updates);
                // Kayıtlar silindiyse, daveti göndermeye izin ver
                canSendInvite = true;
            }
        }

        if (!canSendInvite) {
            showAlert(`Bu kişi davetinizi reddetti. ${remainingTime} sn sonra tekrar deneyiniz.`);
            return;
        }
        // --- Reddedilen Davet Kontrolü Bitiş ---

        const inDuelSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/inDuel`).once('value');
        const isInDuel = inDuelSnapshot.exists() ? inDuelSnapshot.val() : false;
        
        if (isInDuel) {
            showAlert(`${player.name} zaten bir düelloda!`);
            return;
        }

        const inviteData = {
            invitedByName: selectedStudent.studentName,
            invitedByClassId: selectedStudent.classId,
            invitedByStudentId: selectedStudent.studentId,
            invitedByPhoto: studentPhoto.src ? studentPhoto.src : "",
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        console.log("Gönderilecek davet verisi:", inviteData);
        await invitationRef.set(inviteData);
        console.log("Davet veritabanına yazıldı");

        // --- 3. Davet Gönderildikten Sonra Geri Sayım ---
        let timeLeft = 10;
        const alertOverlay = document.getElementById('alertOverlay');
        const countdownInterval = setInterval(() => {
            if (timeLeft > 0) {
                // İsteğe bağlı: İkinci parametre false verildiğinde showAlert buton olmadan sadece mesaj gösterir
                showAlert(`Davet gönderildi! ${timeLeft} saniye sonra kapanacak...`, false);
                timeLeft--;
            } else {
                clearInterval(countdownInterval);
                alertOverlay.style.display = 'none';
                invitationRef.remove().then(() => {
                    console.log("Davet zaman aşımı nedeniyle silindi");
                });
            }
        }, 1000);

        const unsubscribe = invitationRef.on('value', (snapshot) => {
            if (!snapshot.exists()) {
                clearInterval(countdownInterval);
                alertOverlay.style.display = 'none';
                invitationRef.off('value', unsubscribe);
            }
        });
        // --- Geri Sayım Bitiş ---
    } catch (error) {
        console.error("Davet gönderme hatası:", error);
        showAlert('Davet gönderilirken bir hata oluştu.');
    }
}

// Periyodik temizleme fonksiyonu - Bu fonksiyonu window.onload içinde çağırın
function startRejectedInvitesCleanup() {
    setInterval(async () => {
        try {
            const rejectedInvitesRef = database.ref('rejectedInvites');
            const snapshot = await rejectedInvitesRef.once('value');

            if (snapshot.exists()) {
                const updates = {};
                let hasExpired = false;

                snapshot.forEach(child => {
                    const invite = child.val();
                    if (Date.now() - invite.timestamp > 30000) {
                        updates[child.key] = null;
                        hasExpired = true;
                    }
                });

                if (hasExpired) {
                    await rejectedInvitesRef.update(updates);
                }
            }
        } catch (error) {
            console.error("Temizleme hatası:", error);
        }
    }, 5000); // Her 5 saniyede bir kontrol
}

        function startInvitationListener(studentId) {
   const invitationRef = database.ref(`invitations/${studentId}`);
   
   // Mevcut dinleyiciyi temizle
   invitationRef.off();

   // Eski reddedilen davetleri temizle
   cleanupOldRejectedInvites(studentId);
   
   // Davetleri dinle
   invitationRef.on('value', async snapshot => {
       try {
           if (snapshot.exists()) {
               const data = snapshot.val();
               
               // Davet zaten değerlendirilmiş veya timeout olmuşsa çık
               if (!data || (data.timestamp && (Date.now() - data.timestamp) > 10000)) {
                   await invitationRef.remove();
                   invitationOverlay.style.display = 'none';
                   return;
               }

               // Reddedilen davet kontrolü
               const rejectedInviteRef = database.ref('rejectedInvites')
                   .orderByChild('inviterId')
                   .equalTo(data.invitedByStudentId);

               const rejectedSnapshot = await rejectedInviteRef.once('value');
               let isRejected = false;

               if (rejectedSnapshot.exists()) {
                   rejectedSnapshot.forEach(child => {
                       const invite = child.val();
                       if (invite.invitedId === studentId) {
                           const timeDiff = Date.now() - invite.timestamp;
                           if (timeDiff >= 30000) {
                               database.ref(`rejectedInvites/${child.key}`).remove();
                           } else {
                               isRejected = true;
                           }
                       }
                   });
               }

               if (isRejected) {
                   await invitationRef.remove();
                   invitationOverlay.style.display = 'none';
                   return;
               }
               
               // Davet gönderenin online durumunu kontrol et
               const inviterOnlineSnapshot = await database.ref('loggedinPlayers')
                   .orderByChild('studentId')
                   .equalTo(data.invitedByStudentId)
                   .once('value');
                   
               if (!inviterOnlineSnapshot.exists()) {
                   await invitationRef.remove();
                   invitationOverlay.style.display = 'none';
                   return;
               }
               
               // Davet gönderen düelloda mı kontrol et
               const inDuelSnapshot = await database.ref(`classes/${data.invitedByClassId}/students/${data.invitedByStudentId}/inDuel`).once('value');
               if (inDuelSnapshot.val()) {
                   await invitationRef.remove();
                   invitationOverlay.style.display = 'none';
                   return;
               }
               
               // Eğer geçerli bir davetse göster
               currentInvitation = { ...data };
               showInvitationModal(data);
               
               // 10 saniyelik geri sayım
               let timeLeft = 10;
               const countdownInterval = setInterval(() => {
                   // Eğer overlay kapalıysa interval'i temizle
                   if (invitationOverlay.style.display !== 'flex') {
                       clearInterval(countdownInterval);
                       return;
                   }
                   
                   // Eski countdown elementini bul ve kaldır
                   const oldCountdown = document.querySelector('.countdown-text');
                   if (oldCountdown) {
                       oldCountdown.remove();
                   }
                   
                   if (timeLeft > 0) {
                       const countdownElement = document.createElement('div');
                       countdownElement.textContent = `${timeLeft} saniye kaldı`;
                       countdownElement.className = 'countdown-text';
                       countdownElement.style.marginTop = '10px';
                       countdownElement.style.color = timeLeft <= 5 ? '#ff0000' : '#000000';
                       invitationMessage.parentElement.appendChild(countdownElement);
                       timeLeft--;
                   } else {
                       clearInterval(countdownInterval);
                       invitationRef.remove();
                       invitationOverlay.style.display = 'none';
                   }
               }, 1000);
           } else {
               // Davet yoksa veya silindiyse overlay'i kapat
               if (invitationOverlay.style.display === 'flex') {
                   invitationOverlay.style.display = 'none';
               }
               currentInvitation = null;
           }
       } catch (error) {
           console.error("Davet işleme hatası:", error);
           invitationOverlay.style.display = 'none';
           currentInvitation = null;
       }
   });

   // Düello dinleyicileri
   const duelInviterRef = database.ref('duels').orderByChild('inviter/studentId').equalTo(studentId);
   const duelInvitedRef = database.ref('duels').orderByChild('invited/studentId').equalTo(studentId);
   
   // Mevcut dinleyicileri temizle
   duelInviterRef.off();
   duelInvitedRef.off();
   
   // Yeni dinleyicileri ekle
   duelInviterRef.on('child_added', snapshot => {
       if (!currentDuelRef) {
           currentDuelRef = snapshot.ref;
           isInviter = true;
           switchToDuelScreen(snapshot.key);
       }
   });

   duelInvitedRef.on('child_added', snapshot => {
       if (!currentDuelRef) {
           currentDuelRef = snapshot.ref;
           isInviter = false;
           switchToDuelScreen(snapshot.key);
       }
   });

   // Düello silinme dinleyicisi
   database.ref('duels').on('child_removed', snapshot => {
       if (currentDuelRef && snapshot.key === currentDuelRef.key && !duelEnded) {
           showAlert('...').then(() => window.location.reload());
       }
   });
}

function showInvitationModal(data) {
   invitationMessage.textContent = `${data.invitedByName} (${classNameMap[data.invitedByClassId] ? classNameMap[data.invitedByClassId] : data.invitedByClassId}) seni düelloya davet ediyor.`;
   invitationOverlay.style.display = 'flex';
}

const invitationDeclineButton = document.getElementById('invitationDeclineButton');
const invitationAcceptButton = document.getElementById('invitationAcceptButton');

invitationDeclineButton.addEventListener('click', async () => {
   if (!currentInvitation) {
       console.error("Geçerli davet bulunamadı");
       return;
   }

   try {
       // Önce reddedilen daveti kaydet
       await database.ref('rejectedInvites').push().set({
           inviterId: currentInvitation.invitedByStudentId,
           invitedId: selectedStudent.studentId,
           timestamp: Date.now()
       });

       // Davet referansını oluştur ve kaldır
       const invitationRef = database.ref(`invitations/${selectedStudent.studentId}`);
       await invitationRef.remove();

       // Overlay'i kapat
       invitationOverlay.style.display = 'none';
       
       // currentInvitation'ı temizle
       currentInvitation = null;

       await showAlert('Davet reddedildi');

   } catch (error) {
       console.error("Davet reddetme hatası:", error);
       await showAlert('Davet reddedilirken hata oluştu: ' + error.message);
   }
});

async function cleanupRejectedInvites() {
   const thirtySecondsAgo = Date.now() - 30000;
   const rejectedInvitesRef = database.ref('rejectedInvites');
   const oldInvitesSnapshot = await rejectedInvitesRef
       .orderByChild('timestamp')
       .endAt(thirtySecondsAgo)
       .once('value');

   if (oldInvitesSnapshot.exists()) {
       const updates = {};
       oldInvitesSnapshot.forEach(child => {
           updates[child.key] = null;
       });
       await rejectedInvitesRef.update(updates);
   }
}

// Eski reddedilen davetleri temizleme helper fonksiyonu
async function cleanupOldRejectedInvites(studentId) {
   try {
       const rejectedInvitesRef = database.ref('rejectedInvites');
       const snapshot = await rejectedInvitesRef
           .orderByChild('invitedId')
           .equalTo(studentId)
           .once('value');

       if (snapshot.exists()) {
           const updates = {};
           snapshot.forEach(child => {
               const invite = child.val();
               if (Date.now() - invite.timestamp >= 30000) {
                   updates[child.key] = null;
               }
           });
           
           if (Object.keys(updates).length > 0) {
               await rejectedInvitesRef.update(updates);
           }
       }
   } catch (error) {
       console.error("Eski reddedilen davetleri temizlerken hata:", error);
   }
}

// Her 30 saniyede bir temizlik yap
setInterval(cleanupRejectedInvites, 30000);

invitationAcceptButton.addEventListener('click', async () => {
   if (currentInvitation && selectedStudent.studentId) {
       try {
           // Önce davet gönderen kişinin hala online olup olmadığını kontrol et
           const inviterOnlineSnapshot = await database.ref('loggedinPlayers')
               .orderByChild('studentId')
               .equalTo(currentInvitation.invitedByStudentId)
               .once('value');
               
           if (!inviterOnlineSnapshot.exists()) {
               await database.ref(`invitations/${selectedStudent.studentId}`).remove();
               invitationOverlay.style.display = 'none';
               currentInvitation = null;
               showAlert('Davet gönderen oyuncu artık çevrimiçi değil!');
               return;
           }

           const inDuelSnap = await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).once('value');
           const isInDuel = inDuelSnap.exists() ? inDuelSnap.val() : false;

           if (isInDuel) {
               showAlert(`Zaten bir düellodasın!`);
               invitationOverlay.style.display = 'none';
               currentInvitation = null;
               return;
           }

           playersOverlay.style.display = 'none';
           invitationOverlay.style.display = 'none';
           
           await createDuelSession(
               currentInvitation.invitedByStudentId, 
               currentInvitation.invitedByClassId, 
               currentInvitation.invitedByName, 
               currentInvitation.invitedByPhoto
           );
           await database.ref(`invitations/${selectedStudent.studentId}`).remove();
       } catch (error) {
           console.error("Düello başlatılırken hata:", error);
           showAlert('Düello başlatılırken bir hata oluştu.');
       }
   }
});


const cupStyle = document.createElement('style');
cupStyle.textContent = `
    .duel-player-cup {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        margin-top: 8px;
        padding: 5px 10px;
        background: linear-gradient(135deg, #ffd700, #ffa500);
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        animation: cupGlow 2s infinite alternate;
    }

    .duel-player-cup .cup-icon {
        font-size: 1.2em;
        animation: cupBounce 2s infinite ease-in-out;
    }

    .duel-player-cup .cup-value {
        font-weight: bold;
        color: #fff;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    @keyframes cupGlow {
        from {
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }
        to {
            box-shadow: 0 2px 12px rgba(255, 215, 0, 0.6);
        }
    }

    @keyframes cupBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-3px); }
    }
`;
document.head.appendChild(cupStyle);

// Düello başlatma fonksiyonunu güncelle
async function createDuelSession(inviterId, inviterClassId, inviterName, inviterPhoto) {
    const duelRef = database.ref('duels').push();
    
    // Her iki oyuncunun inDuel durumunu izleyen referansları oluştur
    const inviterInDuelRef = database.ref(`classes/${inviterClassId}/students/${inviterId}/inDuel`);
    const invitedInDuelRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`);
    
    // Bağlantı kesildiğinde inDuel durumlarını false yap
    inviterInDuelRef.onDisconnect().set(false);
    invitedInDuelRef.onDisconnect().set(false);

    // Kupa değerlerini al
    const inviterCupRef = database.ref(`classes/${inviterClassId}/students/${inviterId}/gameCup`);
    const invitedCupRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`);
    
    const [inviterCupSnap, invitedCupSnap] = await Promise.all([
        inviterCupRef.once('value'),
        invitedCupRef.once('value')
    ]);

    await duelRef.set({
        inviter: {
            classId: inviterClassId,
            studentId: inviterId,
            name: inviterName,
            photo: inviterPhoto,
            gameCup: inviterCupSnap.val() || 0
        },
        invited: {
            classId: selectedStudent.classId,
            studentId: selectedStudent.studentId,
            name: selectedStudent.studentName,
            photo: (studentPhoto.src && studentPhoto.src !== "") ? studentPhoto.src : "",
            gameCup: invitedCupSnap.val() || 0
        },
        selections: {
            class: "",
            subject: "",
            topic: ""
        },
        gameStarted: false,
        questions: []
    });

    // İki oyuncunun da inDuel durumunu true yap
    await inviterInDuelRef.set(true);
    await invitedInDuelRef.set(true);

    // Bağlantı kesildiğinde düelloyu sil
    duelRef.onDisconnect().remove();

    currentDuelRef = duelRef;
    isInviter = false;
    switchToDuelScreen(duelRef.key);
}






// ----- 1. Otomatik seçim fonksiyonu -----
function autoSelectDuelSelections() {
  // Öncelikle mevcut sınıf değerini alıyoruz
  const classId = duelClassSelect.value;
  if (!classId) {
    console.error("duelClassSelect değeri boş!");
    return;
  }
  
  // Dersleri çekmek için fetchLessons fonksiyonunu kullanın
  // fetchLessons(classId, subjectSelectElement) mevcut kodunuzda dersleri dolduruyor.
  fetchLessons(classId, duelSubjectSelect).then(() => {
    // "Seçiniz" hariç, ders seçeneklerini alalım
    const lessonOptions = Array.from(duelSubjectSelect.options).filter(opt => opt.value !== "");
    if (lessonOptions.length === 0) {
      console.error("Hiç ders bulunamadı!");
      return;
    }
    // Rastgele bir ders seçelim
    const randomLesson = lessonOptions[Math.floor(Math.random() * lessonOptions.length)];
    duelSubjectSelect.value = randomLesson.value;
    
    // Eğer davet eden taraf iseniz, seçimi veritabanına yansıtın
    if (isInviter) {
      updateDuelSelection('subject', randomLesson.value);
    }
    const selectedLessonName = randomLesson.textContent;
    
    // Şimdi, seçilen derse ait konuları çekelim
    fetchTopics(classId, randomLesson.value, duelTopicSelect).then(() => {
      const topicOptions = Array.from(duelTopicSelect.options).filter(opt => opt.value !== "");
      if (topicOptions.length === 0) {
        console.error("Hiç konu bulunamadı!");
        return;
      }
      // Rastgele bir konu seçelim
      const randomTopic = topicOptions[Math.floor(Math.random() * topicOptions.length)];
      duelTopicSelect.value = randomTopic.value;
      
      if (isInviter) {
        updateDuelSelection('topic', randomTopic.value);
      }
      const selectedTopicName = randomTopic.textContent;
      
      // Seçilen ders ve konuyu animasyonlu şekilde göster
      animateDuelSelection(selectedLessonName, selectedTopicName);
      
      // 10 saniyelik geri sayım başlat
      startDuelAutoCountdown();
    });
  });
}

// ----- 2. Seçimi animasyonlu gösterme fonksiyonu -----
function animateDuelSelection(lessonName, topicName) {

}

// ----- 3. 10 Saniyelik geri sayım ve otomatik düello başlatma fonksiyonu -----
function startDuelAutoCountdown() {
  const countdownEl = document.getElementById('duelCountdown');
  let timeLeft = 10; // Geri sayım süresi: 10 saniye
  countdownEl.textContent = timeLeft;
  
  const autoTimer = setInterval(() => {
    timeLeft--;
    countdownEl.textContent = timeLeft;
    
    // (İsteğe bağlı: Geri sayım sırasında renk veya başka efektler ekleyebilirsiniz)
    if (timeLeft <= 0) {
      clearInterval(autoTimer);
      // Geri sayım bittiğinde, otomatik olarak düello başlatmak için:
      duelStartButton.click();
    }
  }, 1000);
}










function switchToDuelScreen(duelKey) {
    // Diğer ekranları gizle
    mainScreen.style.display = 'none';
    singlePlayerScreen.style.display = 'none';
    singlePlayerGameScreen.style.display = 'none';
    friendsScreen.style.display = 'none';
    rankingPanel.classList.remove('open');
    playersOverlay.style.display = 'none';
    
    // Body genel ayarları
    document.body.style.display = 'flex';
    document.body.style.justifyContent = 'center';
    document.body.style.alignItems = 'center';
    document.body.style.minHeight = '100vh';
    
    // Duel seçim ekranı stil ayarları
    duelSelectionScreen.style.display = 'flex';
    duelSelectionScreen.style.flexDirection = 'column';
    duelSelectionScreen.style.width = '100%';
    duelSelectionScreen.style.maxWidth = '900px';
    duelSelectionScreen.style.background = 'white';
    duelSelectionScreen.style.padding = '30px 40px';
    duelSelectionScreen.style.borderRadius = '20px';
    duelSelectionScreen.style.boxShadow = '0 15px 35px rgba(0, 0, 0, 0.2)';
    duelSelectionScreen.classList.add('container');

    const duelRef = database.ref(`duels/${duelKey}`);
    let inviterId, inviterClassId, invitedId, invitedClassId;
    let countdownInterval;
    
    duelRef.once('value').then(initialSnap => {
        if (initialSnap.exists()) {
            const initialData = initialSnap.val();
            inviterId = initialData.inviter.studentId;
            inviterClassId = initialData.inviter.classId;
            invitedId = initialData.invited.studentId;
            invitedClassId = initialData.invited.classId;
            
            // --- Kredilerin Düşürülmesi İşlemi ---
            // Eğer henüz kredi düşülmemişse (creditsDeducted yoksa)
            if (!initialData.creditsDeducted) {
                Promise.all([
                    database.ref(`classes/${inviterClassId}/students/${inviterId}/duelCredits`).once('value'),
                    database.ref(`classes/${invitedClassId}/students/${invitedId}/duelCredits`).once('value')
                ]).then(([inviterCreditsSnap, invitedCreditsSnap]) => {
                    const inviterCredits = inviterCreditsSnap.exists() ? inviterCreditsSnap.val() : 0;
                    const invitedCredits = invitedCreditsSnap.exists() ? invitedCreditsSnap.val() : 0;
                    
                    if (inviterCredits < 3 || invitedCredits < 3) {
                        showAlert('Düello başlatmak için her iki tarafın da en az 3 düello kredisine sahip olması gerekmektedir.')
                            .then(() => {
                                // Yetersiz kredi varsa duel oturumunu kaldırıp sayfayı yenile
                                duelRef.remove();
                                window.location.reload();
                            });
                        return;
                    } else {
                        // Kredileri 3 eksiltelim
                        database.ref(`classes/${inviterClassId}/students/${inviterId}/duelCredits`)
                            .set(inviterCredits - 3);
                        database.ref(`classes/${invitedClassId}/students/${invitedId}/duelCredits`)
                            .set(invitedCredits - 3);
                        // Tekrar kredi düşülmesini engellemek için bayrak ekleyelim
                        duelRef.child('creditsDeducted').set(true);
                    }
                });
            }
            // --- Kredilerin Düşürülmesi Bitti ---
            
            // Sonrasında diğer seçim ekranı ayarlarını yapıyoruz
            database.ref(`classes/${selectedStudent.classId}`).once('value').then(classSnapshot => {
                if (classSnapshot.exists()) {
                    const studentClassName = classSnapshot.val().name;

                    // championData'dan sınıf verilerini çek ve eşleştir
                    database.ref('championData/headings').once('value').then(async snapshot => {
                        duelClassSelect.innerHTML = '<option value="">Seçiniz</option>';
                        if (snapshot.exists()) {
                            snapshot.forEach(childSnapshot => {
                                const classId = childSnapshot.key;
                                const championClassName = childSnapshot.val().name;
                                
                                // Eğer kullanıcının sınıf adı ile championData eşleşiyorsa
                                if (championClassName === studentClassName) {
                                    const option = document.createElement('option');
                                    option.value = classId;
                                    option.textContent = championClassName;
                                    duelClassSelect.appendChild(option);
                                    duelClassSelect.value = classId; // Otomatik seç

                                    if (isInviter) {
                                        // Davet eden için: dersleri yükle ve otomatik seçim yap
                                        fetchLessons(classId, duelSubjectSelect);
                                        autoSelectDuelSelections();
                                    } else {
                                        // Davet edilen için: selections verisini sürekli dinle
                                        currentDuelRef.child('selections').on('value', async selectionsSnapshot => {
                                            console.log("Selections changed:", selectionsSnapshot.val());
                                            if (selectionsSnapshot.exists() && selectionsSnapshot.val().subject) {
                                                setTimeout(async () => {
                                                    await fetchLessons(classId, duelSubjectSelect);
                                                    duelSubjectSelect.value = selectionsSnapshot.val().subject;
                                                    
                                                    if (selectionsSnapshot.val().topic) {
                                                        await fetchTopics(classId, selectionsSnapshot.val().subject, duelTopicSelect);
                                                        duelTopicSelect.value = selectionsSnapshot.val().topic;
                                                    } else {
                                                        duelTopicSelect.value = "";
                                                    }
                                                }, 300);
                                            } else {
                                                duelSubjectSelect.value = "";
                                                duelTopicSelect.value = "";
                                            }
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            });



// Ana countdown kodunu güncelleyelim
const countdownEl = document.getElementById('duelCountdown');
let timeLeft = 10; // 10 saniyeye düşürüldü

countdownInterval = setInterval(() => {
    timeLeft--;
    countdownEl.textContent = timeLeft;
    
    // Renk değişimleri güncellendi
    if (timeLeft > 7) {
        countdownEl.className = 'countdown green';
    } else if (timeLeft > 3) {
        countdownEl.className = 'countdown orange';
    } else {
        countdownEl.className = 'countdown red';
    }
    
    // Süre bittiğinde sadece interval'i temizle
    if (timeLeft <= 0) {
        clearInterval(countdownInterval);
        countdownEl.textContent = '0';
    }
}, 1000);


duelRef.child('gameStarted').on('value', snapshot => {
    if (snapshot.val() === true && countdownInterval) {
        clearInterval(countdownInterval);
        const countdownEl = document.getElementById('duelCountdown');
        if (countdownEl) countdownEl.style.display = 'none';
    }
});



        
        // Sadece davet eden kişinin ismini göster
        const selectingStudentBanner = document.getElementById('selecting-student-banner');
        selectingStudentBanner.textContent = `Düello Başlıyor`;
        selectingStudentBanner.style.display = 'block';
    }
});

    duelRef.onDisconnect().remove();

    database.ref('championData/headings').once('value').then(snapshot => {
        duelClassSelect.innerHTML = '<option value="">Seçiniz</option>';
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const classId = childSnapshot.key;
                const className = childSnapshot.val().name || 'No name';
                const option = document.createElement('option');
                option.value = classId;
                option.textContent = className;
                duelClassSelect.appendChild(option);
            });
        }
    }).catch(error => {
        console.error("Sınıf verileri yüklenirken hata:", error);
        showAlert('Sınıf verileri yüklenirken bir hata oluştu.');
    });












async function syncDuelSelections(data) {
    if (!data.selections) return;
    
    try {
        // Sınıf seçimini güncelle
        if (data.selections.class) {
            duelClassSelect.value = data.selections.class;
            
            // Dersleri yükle
            await fetchLessons(data.selections.class, duelSubjectSelect);
            
            // Ders seçimini güncelle
            if (data.selections.subject) {
                duelSubjectSelect.value = data.selections.subject;
                
                // Konuları yükle
                await fetchTopics(data.selections.class, data.selections.subject, duelTopicSelect);
                
                // Konu seçimini güncelle
                if (data.selections.topic) {
                    duelTopicSelect.value = data.selections.topic;
                }
            }
        }
    } catch (error) {
        console.error("Seçimler senkronize edilirken hata:", error);
    }
}














duelRef.on('value', async (snap) => {
    if (snap.exists()) {
        const data = snap.val();
        
        // Oyuncu bilgilerini güncelle
        duelInviterPhoto.src = data.inviter.photo || "https://via.placeholder.com/80";
        duelInviterName.textContent = data.inviter.name;
        duelInvitedPhoto.src = data.invited.photo || "https://via.placeholder.com/80";
        duelInvitedName.textContent = data.invited.name;

        // Kupa değerlerini güncelle
        const inviterInfo = document.getElementById('duel-inviter-info');
        const invitedInfo = document.getElementById('duel-invited-info');

        // Mevcut kupaları temizle
        const existingCups = document.querySelectorAll('.duel-player-cup');
        existingCups.forEach(cup => cup.remove());

        // Yeni kupa elementlerini ekle
        const inviterCup = document.createElement('div');
        inviterCup.className = 'duel-player-cup';
        inviterCup.innerHTML = `
            <span class="cup-icon">🏆</span>
            <span class="cup-value">${data.inviter.gameCup}</span>
        `;
        inviterInfo.appendChild(inviterCup);

        const invitedCup = document.createElement('div');
        invitedCup.className = 'duel-player-cup';
        invitedCup.innerHTML = `
            <span class="cup-icon">🏆</span>
            <span class="cup-value">${data.invited.gameCup}</span>
        `;
        invitedInfo.appendChild(invitedCup);

        // Select elementlerini devre dışı bırak
        [duelClassSelect, duelSubjectSelect, duelTopicSelect].forEach(select => {
            select.disabled = true;
            select.style.pointerEvents = 'none';
            select.style.cursor = 'not-allowed';
            select.style.opacity = '0.7';
        });

        // Seçimleri senkronize et
        if (data.selections) {
            try {
                // Sınıf seçimini güncelle
                if (data.selections.class) {
                    duelClassSelect.value = data.selections.class;
                    
                    // Dersleri yükle ve senkronize et
                    const lessonsLoaded = await fetchLessons(data.selections.class, duelSubjectSelect);
                    if (lessonsLoaded && data.selections.subject) {
                        duelSubjectSelect.value = data.selections.subject;
                        
                        // Konuları yükle ve senkronize et
                        const topicsLoaded = await fetchTopics(data.selections.class, data.selections.subject, duelTopicSelect);
                        if (topicsLoaded && data.selections.topic) {
                            duelTopicSelect.value = data.selections.topic;
                        }
                    }
                }

                // Davet edilen oyuncu için seçenekleri doldur
                if (!isInviter) {
                    const [classOptions, subjectOptions, topicOptions] = await Promise.all([
                        data.selections.class ? getClassOptions() : null,
                        data.selections.subject ? getLessonOptions(data.selections.class) : null,
                        data.selections.topic ? getTopicOptions(data.selections.class, data.selections.subject) : null
                    ]);

                    if (classOptions) {
                        duelClassSelect.innerHTML = classOptions;
                        duelClassSelect.value = data.selections.class;
                    }
                    if (subjectOptions) {
                        duelSubjectSelect.innerHTML = subjectOptions;
                        duelSubjectSelect.value = data.selections.subject;
                    }
                    if (topicOptions) {
                        duelTopicSelect.innerHTML = topicOptions;
                        duelTopicSelect.value = data.selections.topic;
                    }
                }

            } catch (error) {
                console.error("Seçimler senkronize edilirken hata:", error);
            }
        }

        // Oyun durumu kontrolü
        if (data.gameStarted && !duelGameStarted) {
            duelGameStarted = true;
            duelEnded = false;
            startDuelGame(data);
        }

        // Düello başlatma butonu kontrolü
        if (!isInviter) {
            duelStartButton.disabled = true;
        } else {
            checkDuelSelections();
        }

    } else {
        if (!duelEnded) {
            try {
                const currentPlayerId = selectedStudent.studentId;
                
                await updateDuelScore('DISCONNECTED', {
                    inviterId,
                    inviterClassId,
                    invitedId,
                    invitedClassId,
                    disconnectedId: currentPlayerId === inviterId ? invitedId : inviterId,
                    disconnectedClassId: currentPlayerId === inviterId ? invitedClassId : inviterClassId
                });

                // inDuel durumlarını güncelle
                await Promise.all([
                    database.ref(`classes/${inviterClassId}/students/${inviterId}/inDuel`).set(false),
                    database.ref(`classes/${invitedClassId}/students/${invitedId}/inDuel`).set(false)
                ]);

                window.location.reload();

            } catch (error) {
                console.error("Oyun sonlandırma hatası:", error);
                await showAlert('Oyun sonlandırılırken bir hata oluştu');
                window.location.reload();
            }
        }
    }
});


// Select elementleri için yardımcı fonksiyonlar
async function getClassOptions() {
   const snapshot = await database.ref('championData/headings').once('value');
   let options = '<option value="">Seçiniz</option>';
   if (snapshot.exists()) {
       snapshot.forEach(childSnapshot => {
           const className = childSnapshot.val().name;
           options += `<option value="${childSnapshot.key}">${className}</option>`;
       });
   }
   return options;
}

async function getLessonOptions(classId) {
   const snapshot = await database.ref(`championData/headings/${classId}/lessons`).once('value');
   let options = '<option value="">Seçiniz</option>';
   if (snapshot.exists()) {
       snapshot.forEach(childSnapshot => {
           const lessonName = childSnapshot.val().name;
           options += `<option value="${childSnapshot.key}">${lessonName}</option>`;
       });
   }
   return options;
}

async function getTopicOptions(classId, lessonId) {
   const snapshot = await database.ref(`championData/headings/${classId}/lessons/${lessonId}/topics`).once('value');
   let options = '<option value="">Seçiniz</option>';
   if (snapshot.exists()) {
       snapshot.forEach(childSnapshot => {
           const topicName = childSnapshot.val().name;
           options += `<option value="${childSnapshot.key}">${topicName}</option>`;
       });
   }
   return options;
}


    const hiddenPlayButton = document.createElement('button');
    hiddenPlayButton.style.display = 'none';
    hiddenPlayButton.id = 'hiddenPlayButton';
    duelSelectionScreen.appendChild(hiddenPlayButton);

    hiddenPlayButton.addEventListener('click', () => {
        duelMusic.play().then(() => {
            duelMusic.loop = true;
        }).catch(error => {
            console.error("Müzik çalınamadı:", error);
        });
    });

    setTimeout(() => {
        hiddenPlayButton.click();
    }, 1000);
}

      function resetDuelGameState() {
            duelQuestionNumber.textContent = 'Soru 1/10';
            duelProgressBarInner.style.width = '0%';
            duelTimerElement.textContent = '45';
            duelTimerElement.style.color = '#ff0000';
            inviterCorrectCountEl.textContent = "0";
            invitedCorrectCountEl.textContent = "0";

            duelQuestions = [];
            duelCurrentQuestionIndex = 0;
            duelInviterScore = 0;
            duelInvitedScore = 0;
            clearInterval(duelTimer);
            duelQuestionLocked = false;
            duelGameStarted = false;
            duelEnded = true; // Duel bittiğinde bayrağı ayarla

            // Düello Oyun Müziğini Durdur
            duelMusic.pause();
            duelMusic.currentTime = 0;
        }

duelClassSelect.addEventListener('change', (e) => {
    e.preventDefault(); // Değişikliği engelle
    return false;
});

        duelSubjectSelect.addEventListener('change', () => {
            if (isInviter) {
                fetchTopics(duelClassSelect.value, duelSubjectSelect.value, duelTopicSelect);
                updateDuelSelection('subject', duelSubjectSelect.value);
            }
        });

        duelTopicSelect.addEventListener('change', () => {
            if (isInviter) {
                updateDuelSelection('topic', duelTopicSelect.value);
            }
        });

async function updateDuelSelection(field, value) {
    // Eğer referans yoksa çık
    if (!currentDuelRef) return;

    // Sınıf seçimini değiştirmeye çalışıyorsa engelle
    if (field === 'class' && value !== duelClassSelect.value) {
        return;
    }
    
    try {
        // Seçimi veritabanında güncelle
        await currentDuelRef.child('selections').child(field).set(value);

        // Seçime göre bağımlı alanları güncelle
        if (field === 'subject') {
            // Konu seçildiğinde alt konuları yükle
            const topicsLoaded = await fetchTopics(duelClassSelect.value, value, duelTopicSelect);
            if (!topicsLoaded) {
                console.warn('Konular yüklenemedi');
            }
        }

        // Her iki oyuncunun select elementlerini senkronize et
        if (field === 'subject' || field === 'topic') {
            const selections = (await currentDuelRef.child('selections').once('value')).val() || {};
            
            // Davet eden oyuncu için seçimleri güncelle
            if (isInviter) {
                duelSubjectSelect.value = selections.subject || '';
                duelTopicSelect.value = selections.topic || '';
            }
        }

        // Seçimlerin durumunu kontrol et
        checkDuelSelections();

    } catch (error) {
        console.error('Seçim güncellenirken hata:', error);
        showAlert('Seçim güncellenirken bir hata oluştu').catch(console.error);
    }
}

        function checkDuelSelections() {
            if (isInviter) {
                const c = duelClassSelect.value;
                const s = duelSubjectSelect.value;
                const t = duelTopicSelect.value;
                if (c !== "" && s !== "" && t !== "") {
                    duelStartButton.classList.add('active');
                    duelStartButton.disabled = false;
                } else {
                    duelStartButton.classList.remove('active');
                    duelStartButton.disabled = true;
                }
            }
        }

        duelStartButton.addEventListener('click', async () => {
            duelClassId = duelClassSelect.value;
            duelSubjectId = duelSubjectSelect.value;
            duelTopicId = duelTopicSelect.value;

    const classSnapshot = await database.ref(`classes/${selectedStudent.classId}`).once('value');
    const championDataSnapshot = await database.ref(`championData/headings/${duelClassSelect.value}`).once('value');
    
    if (!classSnapshot.exists() || !championDataSnapshot.exists()) {
        showAlert('Sınıf seçimi ile ilgili bir hata oluştu.');
        return;
    }

    const studentClassName = classSnapshot.val().name;
    const championClassName = championDataSnapshot.val().name;

    if (studentClassName !== championClassName) {
        showAlert('Sınıf seçimi uyuşmazlığı tespit edildi.');
        return;
    }

            const questionsRef = database.ref(`championData/headings/${duelClassId}/lessons/${duelSubjectId}/topics/${duelTopicId}/questions`);
            const snapshot = await questionsRef.once('value');
            if (snapshot.exists()) {
                const allQuestions = [];
                snapshot.forEach(cs => {
                    allQuestions.push(cs.val());
                });
                if (allQuestions.length < 10) {
                    showAlert('Bu konuya ait yeterli soru yok.');
                    return;
                }
                // Firebase'den çekilen tüm sorulardan 10 tanesini rastgele seçelim:
let chosen = shuffleArray(allQuestions).slice(0, 10);

// Soru formatını doğru şekilde eşleyelim:
chosen = chosen.map(q => {
    let infoText = "";
    let questionText = "";
    // Eğer soru nesne formatındaysa:
    if (typeof q.question === 'object' && q.question !== null) {
        infoText = q.question.info || "";
        questionText = q.question.text || "";
    } else {
        // Eğer soru doğrudan metin olarak saklanmışsa:
        questionText = q.question;
    }
    return {
        info: infoText,
        actualQuestion: questionText,
        question: questionText,
        correct: q.correct,
        wrong1: q.wrong1,
        wrong2: q.wrong2,
        options: shuffleArray([
            { text: q.correct, correct: true },
            { text: q.wrong1, correct: false },
            { text: q.wrong2, correct: false }
        ])
    };
});

await currentDuelRef.child('questions').set(chosen);
                await currentDuelRef.child('gameStarted').set(true);
                showAlert("Düello Başlatıldı!");
            } else {
                showAlert("Bu konuya ait soru bulunamadı.");
            }
        });

        function startDuelGame(data) {
            // Düello başlarken final ekranı ve skorları resetleyelim
            duelFinalContainer.style.display='none';
            winnerMessage.textContent = '';

            duelSelectionScreen.style.display = 'none';
            duelGameScreen.style.display = 'flex';

            document.getElementById('duel-player-inviter-photo').src = data.inviter.photo ? data.inviter.photo : "https://via.placeholder.com/80";
            document.getElementById('duel-player-inviter-name').textContent = data.inviter.name;
            document.getElementById('duel-player-invited-photo').src = data.invited.photo ? data.invited.photo : "https://via.placeholder.com/80";
            document.getElementById('duel-player-invited-name').textContent = data.invited.name;

            duelInviterScore = 0;
            duelInvitedScore = 0;
            inviterCorrectCountEl.textContent = "0";
            invitedCorrectCountEl.textContent = "0";

            duelCurrentQuestionIndex = 0;
            if (data.questions) {
                duelQuestions = data.questions;
                loadDuelQuestion();
            }

            listenToResponses();

            // Düello oyunu başladığında arka plan müziğini çal
            duelMusic.currentTime = 0;
            duelMusic.play().then(() => {
                duelMusic.loop = true;
            }).catch(error => {
                console.error("Müzik çalınamadı:", error);
            });
        }

        function loadDuelQuestion() {
    if (duelCurrentQuestionIndex >= 10) {
        endDuelGame();
        return;
    }
    duelQuestionLocked = false;
    const currentQuestion = duelQuestions[duelCurrentQuestionIndex];
    duelQuestionNumber.textContent = `Soru ${duelCurrentQuestionIndex + 1}/10`;
    const progressPercentage = ((duelCurrentQuestionIndex) / 10) * 100;
    duelProgressBarInner.style.width = `${progressPercentage}%`;

    // Soru konteynerini düello oyun ekranından seçiyoruz
    const questionContainer = document.querySelector('#duel-game-screen .question-container');
    questionContainer.innerHTML = '';

    if (currentQuestion.question.startsWith('http')) {
  // Eğer soru resim URL'siyse
  const questionImage = document.createElement('img');
  questionImage.src = currentQuestion.question;
  questionImage.className = 'question-image';
  questionImage.style.display = 'block';
  questionImage.alt = "Soru resmi";
  questionContainer.appendChild(questionImage);

  if (currentQuestion.actualQuestion) {
    const questionTextDiv = document.createElement('div');
    questionTextDiv.className = 'question-text';
    questionTextDiv.textContent = currentQuestion.actualQuestion;
    questionContainer.appendChild(questionTextDiv);
  }
} else {
  // Metin şeklindeki soru için
  const textContainer = document.createElement('div');
  textContainer.className = 'question-text-container';

  const infoText = document.createElement('div');
  infoText.className = 'question-info-text';
  infoText.textContent = currentQuestion.info || '';
  textContainer.appendChild(infoText);

  const divider = document.createElement('div');
  divider.className = 'question-divider';
  textContainer.appendChild(divider);

  const questionText = document.createElement('div');
  questionText.className = 'question-actual-text';
  questionText.textContent = currentQuestion.question; // Artık doğru soru metni burada
  textContainer.appendChild(questionText);

  questionContainer.appendChild(textContainer);
}




    duelOptionsContainer.innerHTML = '';
    currentQuestion.options.forEach((option, idx) => {
        const button = document.createElement('button');
        button.classList.add('option-button');
        button.textContent = option.text;
        button.dataset.correct = option.correct;
        button.dataset.optionIndex = idx;
        button.addEventListener('click', duelSelectOption);
        duelOptionsContainer.appendChild(button);
    });

    resetDuelTimer();
    startDuelTimer();
    currentDuelRef.child('responses').child(duelCurrentQuestionIndex).remove();
}


function resetDuelTimer() {
    clearInterval(duelTimer);
    duelTimeLeft = 45;
    duelTimerElement.textContent = duelTimeLeft;
    duelTimerElement.style.color = '#ff0000';
}

function startDuelTimer() {
    duelTimer = setInterval(() => {
        duelTimeLeft--;
        duelTimerElement.textContent = duelTimeLeft;
        if (duelTimeLeft <= 0 && !duelQuestionLocked) {
            clearInterval(duelTimer);
            duelQuestionLocked = true;
            revealDuelAnswerAfterTimeout();
        }
    }, 1000);
}

function duelSelectOption(e) {
    if (duelQuestionLocked) return;
    const selectedButton = e.target;
    const chosenOptionText = selectedButton.textContent;
    const isCorrect = selectedButton.dataset.correct === 'true';
    const playerId = selectedStudent.studentId;

    duelOptionsContainer.querySelectorAll('.option-button').forEach(b => {
        b.disabled = true;
        if (b !== selectedButton) {
            b.classList.add('option-faded');
        } else {
            b.classList.add('option-chosen');
        }
    });

    currentDuelRef.child('responses').child(duelCurrentQuestionIndex).child(playerId).set({
        chosen: chosenOptionText,
        correct: isCorrect
    });
}

function listenToResponses() {
    currentDuelRef.child('responses').on('value', snap => {
        if (snap.exists()) {
            const data = snap.val();
            currentDuelRef.once('value', dsnap => {
                const ddata = dsnap.val();
                const invId = ddata.inviter.studentId;
                const inId = ddata.invited.studentId;
                const answeredCount = Object.keys(data[duelCurrentQuestionIndex] || {}).length;
                if (answeredCount === 2 && !duelQuestionLocked) {
                    duelQuestionLocked = true;
                    clearInterval(duelTimer);
                    revealDuelAnswerAfterTimeout();
                }
            });
        }
    });
}

        // Yeni +1 Efekti Fonksiyonu
        function showScoreIncrementEffect(scoreElement) {
            const plusOne = document.createElement('div');
            plusOne.classList.add('animated-plus-one');
            plusOne.textContent = '+1';
            document.body.appendChild(plusOne);

            // Get center position
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            // Get the scoreElement's position
            const rect = scoreElement.getBoundingClientRect();
            const targetX = rect.left + rect.width / 2;
            const targetY = rect.top + rect.height / 2;

            // Calculate translation
            const deltaX = targetX - centerX;
            const deltaY = targetY - centerY;

            // Animate
            plusOne.animate([
                { transform: `translate(-50%, -50%) translate(0px, 0px) scale(1)`, opacity: 1 },
                { transform: `translate(-50%, -50%) translate(${deltaX}px, ${deltaY}px) scale(0.5)`, opacity: 0 }
            ], {
                duration: 1000,
                easing: 'ease-out'
            });

            // Remove the element after animation
            setTimeout(() => {
                plusOne.remove();
            }, 1000);
        }

        function revealDuelAnswerAfterTimeout() {
            setTimeout(() => {
                revealDuelAnswer();
            }, 500);
        }

        function revealDuelAnswer() {
            currentDuelRef.child('responses').child(duelCurrentQuestionIndex).once('value').then(resSnap => {
                const responses = resSnap.val() || {};
                currentDuelRef.once('value').then(dSnap => {
                    const ddata = dSnap.val();
                    const invId = ddata.inviter.studentId;
                    const inId = ddata.invited.studentId;

                    const optionButtons = duelOptionsContainer.querySelectorAll('.option-button');
                    optionButtons.forEach(btn => {
                        if (btn.dataset.correct === 'true') {
                            btn.classList.add('correct');
                        } else {
                            btn.classList.add('wrong');
                        }
                    });

                    let inviterOldScore = duelInviterScore;
                    let invitedOldScore = duelInvitedScore;

                    if (responses[invId] && responses[invId].correct) duelInviterScore++;
                    if (responses[inId] && responses[inId].correct) duelInvitedScore++;

                    if (duelInviterScore > inviterOldScore) {
                        inviterCorrectCountEl.textContent = duelInviterScore;
                        inviterCorrectCountEl.classList.add('score-flash');
                        showScoreIncrementEffect(inviterCorrectCountEl);
                        setTimeout(()=>inviterCorrectCountEl.classList.remove('score-flash'),1000);
                    }

                    if (duelInvitedScore > invitedOldScore) {
                        invitedCorrectCountEl.textContent = duelInvitedScore;
                        invitedCorrectCountEl.classList.add('score-flash');
                        showScoreIncrementEffect(invitedCorrectCountEl);
                        setTimeout(()=>invitedCorrectCountEl.classList.remove('score-flash'),1000);
                    }

                    setTimeout(() => {
                        duelCurrentQuestionIndex++;
                        loadDuelQuestion();
                    }, 1500);
                });
            });
        }

function endDuelGame() {
    currentDuelRef.off('value');
    currentDuelRef.child('responses').off('value');
    
    duelQuestionNumber.style.display = 'none';
    document.querySelector('#duel-game-screen .progress-container').style.display = 'none';
    document.querySelector('#duel-game-screen .timer-container').style.display = 'none';
    document.querySelector('#duel-game-screen .question-container').style.display = 'none';
    duelOptionsContainer.style.display = 'none';
    duelFinalContainer.style.display = 'flex';

    currentDuelRef.once('value').then(async (dSnap) => {
        const ddata = dSnap.val();
        let winnerName = '';
        let winnerId = null;
        let loserId = null;
        let winnerClassId = null;
        let loserClassId = null;

        if (duelInviterScore > duelInvitedScore) {
            winnerName = ddata.inviter.name;
            winnerId = ddata.inviter.studentId;
            winnerClassId = ddata.inviter.classId;
            loserId = ddata.invited.studentId;
            loserClassId = ddata.invited.classId;
        } else if (duelInvitedScore > duelInviterScore) {
            winnerName = ddata.invited.name;
            winnerId = ddata.invited.studentId;
            winnerClassId = ddata.invited.classId;
            loserId = ddata.inviter.studentId;
            loserClassId = ddata.inviter.classId;
        }

        // Winner message animation
        const finalMessage = winnerId ? `👑 ${winnerName} 👑` : "🤝 Berabere! 🤝";
        winnerMessage.textContent = finalMessage;

        // Trophy container
        const trophyContainer = document.createElement('div');
        trophyContainer.className = 'trophy-container';
        
        // Add trophies with animation
        if (winnerId) {
            for(let i = 0; i < 6; i++) {
                const trophy = document.createElement('div');
                trophy.className = 'trophy';
                trophy.textContent = '🏆';
                trophy.style.animation = `trophyEntry 0.5s ${i * 0.2}s forwards`;
                trophyContainer.appendChild(trophy);
            }
        }

      // Update scores
if (winnerId && loserId) {
    try {
        await updateDuelScore('GAME_END', {
            winnerId,
            winnerClassId,
            loserId,
            loserClassId
        });

        // Puanları görsel olarak güncelle
        if (selectedStudent.studentId === winnerId || selectedStudent.studentId === loserId) {
            fetchAndDisplayGameCup();
        }
    } catch (error) {
        console.error("Puan güncelleme hatası:", error);
        await showAlert('❌ Puan güncellenirken bir hata oluştu!');
    }
}

        // Remove old trophies if exist
        const oldTrophies = duelFinalContainer.querySelector('.trophy-container');
        if(oldTrophies) oldTrophies.remove();
        
        // Add new trophies
        duelFinalContainer.appendChild(trophyContainer);

        // Handle music
        duelMusic.pause();
        duelMusic.currentTime = 0;

        if (winnerId || finalMessage.includes("Berabere")) {
            winnerMusic.currentTime = 0;
            winnerMusic.play().catch(error => {
                console.error("Kazanan müziği çalınamadı:", error);
            });
        }

        duelEnded = true;
    });
}

        // Fetch and display gameCup for the logged-in student
        function fetchAndDisplayGameCup() {
            database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    document.getElementById('game-cup-score').textContent = snapshot.val();
                } else {
                    // Initialize gameCup to 0
                    database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`).set(0);
                    document.getElementById('game-cup-score').textContent = '0';
                }
            }).catch(error => {
                console.error("gameCup çekilirken hata:", error);
                document.getElementById('game-cup-score').textContent = '0';
            });
        }

        async function loadRanking() {
   const CACHE_DURATION = 3600000; // 1 saat
   const PLAYER_LIMIT = 10; // İlk 10 oyuncu

   // Check cache first
   const cachedData = localStorage.getItem('rankingCache');
   const cachedTimestamp = localStorage.getItem('rankingCacheTimestamp');
   
   if (cachedData && cachedTimestamp) {
       const age = Date.now() - parseInt(cachedTimestamp);
       if (age < CACHE_DURATION) {
           const data = JSON.parse(cachedData);
           displayRankingData(data);
           return;
       }
   }

   rankingTableBody.innerHTML = '';
   
   try {
       const classesSnapshot = await database.ref('classes').once('value');
       let players = [];
       let currentUserRank = 0;
       let totalPlayers = 0;
       let userTrophyCount = 0;

       if (classesSnapshot.exists()) {
           for (const classSnap of Object.values(classesSnapshot.val())) {
               if (classSnap.students) {
                   for (const [studentId, student] of Object.entries(classSnap.students)) {
                       // Sadece gerekli alanları al
                       players.push({
                           id: studentId,
                           name: student.name || 'Anonim',
                           className: classSnap.name,
                           gameCup: student.gameCup || 0,
                           photo: student.photo || 'https://via.placeholder.com/50'
                       });

                       if (studentId === selectedStudent.studentId) {
                           userTrophyCount = student.gameCup || 0;
                       }
                   }
               }
           }

           // Sıralama ve limit uygula
           players.sort((a, b) => b.gameCup - a.gameCup);
           totalPlayers = players.length;
           currentUserRank = players.findIndex(p => p.id === selectedStudent.studentId) + 1;
           players = players.slice(0, PLAYER_LIMIT);

           // Cache'e kaydet
           localStorage.setItem('rankingCache', JSON.stringify(players));
           localStorage.setItem('rankingCacheTimestamp', Date.now().toString());

           displayRankingData(players);
           updateUserStats(currentUserRank, totalPlayers, userTrophyCount);

       } else {
           rankingTableBody.innerHTML = '<tr><td colspan="5">Henüz sıralama yapılmadı.</td></tr>';
       }
   } catch (error) {
       console.error("Sıralama yüklenirken hata:", error);
       rankingTableBody.innerHTML = '<tr><td colspan="5">Sıralama yüklenirken bir hata oluştu.</td></tr>';
   }
}

function displayRankingData(players) {
   rankingTableBody.innerHTML = '';
   const topPlayers = players.slice(0, 5);
   const currentUserRank = players.findIndex(p => p.id === selectedStudent.studentId) + 1;
   const userTrophyCount = players.find(p => p.id === selectedStudent.studentId)?.gameCup || 0;

   topPlayers.forEach((player, index) => {
       const tr = document.createElement('tr');
       
       if (index < 3) {
           tr.classList.add(`top-${index + 1}`);
       }

       // Highlight current user's row
       if (player.id === selectedStudent.studentId) {
           tr.classList.add('current-user-row');
       }

       tr.innerHTML = `
           <td class="rank-column">${index + 1}</td>
           <td><img src="${player.photo}" alt="${player.name}" class="ranking-player-photo" 
               onerror="this.src='https://via.placeholder.com/50'"></td>
           <td class="player-name-column">${player.name}</td>
           <td class="class-name-column">${player.className}</td>
           <td class="trophy-column">
               <div class="trophy-wrapper">
                   <span class="trophy-icon">🏆</span>
                   <span class="trophy-count">${player.gameCup}</span>
               </div>
           </td>
       `;
       
       rankingTableBody.appendChild(tr);
   });

   // Update user stats with animation
   updateUserStats(currentUserRank, players.length, userTrophyCount);
}

function updateUserStats(rank, total, trophies) {
   const rankValue = document.querySelector('#userRankNumber .rank-value');
   const totalValue = document.querySelector('#totalPlayers .total-value');
   const trophyValue = document.querySelector('#userTrophyCount');

   // Add animation classes
   rankValue.classList.add('stat-update');
   totalValue.classList.add('stat-update');
   trophyValue.classList.add('stat-update');

   // Update values
   rankValue.textContent = rank > 0 ? `#${rank}` : '-';
   totalValue.textContent = total;
   trophyValue.textContent = trophies;

   // Remove animation classes after animation completes
   setTimeout(() => {
       rankValue.classList.remove('stat-update');
       totalValue.classList.remove('stat-update');
       trophyValue.classList.remove('stat-update');
   }, 500);
}

    </script>

    <script>
        // Ensure the script runs after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            const kupaSiralamaButton = document.getElementById('kupa-siralama-button');
            const rankingBackButton = document.getElementById('rankingBackButton');
            const rankingPanel = document.getElementById('rankingPanel');

            // Hide the ranking panel initially
            rankingPanel.style.display = 'none';

            // Show the ranking panel when the button is clicked
            if (kupaSiralamaButton) {
                kupaSiralamaButton.addEventListener('click', () => {
                    rankingPanel.style.display = 'flex';
                });
            }

            // Hide the ranking panel when the back button is clicked
            if (rankingBackButton) {
                rankingBackButton.addEventListener('click', () => {
                    rankingPanel.style.display = 'none';
                });
            }
        });












































// Düello Arama butonuna tıklandığında
document.getElementById('findDuelButton').addEventListener('click', () => {
   // Önce mevcut listeyi ve listener'ları temizle
   const availablePlayersList = document.getElementById('availablePlayersList');
   availablePlayersList.innerHTML = '';
   cleanupMatchmakingListeners();
   
   // Matchmaking referansını oluştur
   const matchmakingRef = database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`);
   
   // Bağlantı koptuğunda kaydı otomatik sil
   matchmakingRef.onDisconnect().remove();
   
   // Öğrenciyi matchmaking listesine ekle
   matchmakingRef.set({
       name: selectedStudent.studentName,
       classId: selectedStudent.classId,
       studentId: selectedStudent.studentId,
       timestamp: firebase.database.ServerValue.TIMESTAMP,
       status: 'searching'
   }).then(() => {
       showMatchmakingScreen();
   });
});

// Eşleştirme ekranını göster
function showMatchmakingScreen() {
   const matchmakingScreen = document.getElementById('matchmakingScreen');
   matchmakingScreen.style.display = 'flex';
   
   // Müsait oyuncuları dinle
   listenForAvailablePlayers();
   
   // Düello kaydı (child_added) oluştuğunda matchmakingScreen'i kapat
   listenForDuelCreation();
}

// Müsait oyuncuları dinle
function listenForAvailablePlayers() {
   const currentClass = selectedStudent.classId;
   const matchmakingRef = database.ref(`matchmaking/${currentClass}`);
   const availablePlayersList = document.getElementById('availablePlayersList');
   
   // Oyuncu listesini takip etmek için Set
   const addedPlayers = new Set();
   
   // Yeni oyuncu eklendiğinde
   matchmakingRef.on('child_added', async (childSnapshot) => {
       const player = childSnapshot.val();
       
       // Eğer oyuncu zaten eklenmişse ekleme
       if (addedPlayers.has(player.studentId)) return;
       
       // Kendimizi listelemeyelim
       if (player.studentId !== selectedStudent.studentId) {
           const inDuelSnap = await database.ref(`classes/${player.classId}/students/${player.studentId}/inDuel`).once('value');
           const inDuel = inDuelSnap.exists() ? inDuelSnap.val() : false;
           
           // Eğer inDuel = false ve status='searching' ise listele
           if (!inDuel && player.status === 'searching') {
               const playerItem = await createPlayerItem(player);
               playerItem.setAttribute('data-player-id', player.studentId);
               availablePlayersList.appendChild(playerItem);
               addedPlayers.add(player.studentId);
           }
       }
   });
   
   // Oyuncu kaldırıldığında
   matchmakingRef.on('child_removed', (oldChildSnapshot) => {
       const removedPlayerId = oldChildSnapshot.val().studentId;
       const playerElement = availablePlayersList.querySelector(`[data-player-id="${removedPlayerId}"]`);
       if (playerElement) {
           playerElement.remove();
           addedPlayers.delete(removedPlayerId);
       }
   });
   
   // Oyuncu durumu değiştiğinde
   matchmakingRef.on('child_changed', async (changedChildSnapshot) => {
       const changedPlayer = changedChildSnapshot.val();
       const playerElement = availablePlayersList.querySelector(`[data-player-id="${changedPlayer.studentId}"]`);
       
       if (changedPlayer.studentId !== selectedStudent.studentId) {
           const inDuelSnap = await database.ref(`classes/${changedPlayer.classId}/students/${changedPlayer.studentId}/inDuel`).once('value');
           const inDuel = inDuelSnap.exists() ? inDuelSnap.val() : false;
           
           if (inDuel || changedPlayer.status !== 'searching') {
               // Oyuncu artık müsait değilse listeden kaldır
               if (playerElement) {
                   playerElement.remove();
                   addedPlayers.delete(changedPlayer.studentId);
               }
           }
       }
   });
}

async function createPlayerItem(player) {
   const div = document.createElement('div');
   div.className = 'player-item';
   
   // Fotoğrafı çek
   const photoSnapshot = await database
     .ref(`classes/${player.classId}/students/${player.studentId}/photo`)
     .once('value');
   const photoUrl = photoSnapshot.exists() ? photoSnapshot.val() : 'https://via.placeholder.com/50';
   
   div.innerHTML = `
       <img src="${photoUrl}" alt="${player.name}" class="player-photo">
       <span class="player-name">${player.name} / ${classNameMap[player.classId]}</span>
       <button class="duel-request-button">
           <i class="duel-icon">⚔️</i>
       </button>
   `;
   
   const duelButton = div.querySelector('.duel-request-button');
   duelButton.addEventListener('click', async () => {
       // Davet gönder
       await sendInvitation({
           studentId: player.studentId,
           name: player.name,
           classId: player.classId,
           photo: photoUrl
       });
       
       // Sadece matchmaking kaydını kaldır ve ekranı kapat
       document.getElementById('matchmakingScreen').style.display = 'none';
       database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`).remove();
   });
   
   return div;
}

// Matchmaking dinleyicilerini temizle
function cleanupMatchmakingListeners() {
   const currentClass = selectedStudent.classId;
   const matchmakingRef = database.ref(`matchmaking/${currentClass}`);
   matchmakingRef.off();  // Tüm listener'ları temizle
}

// Aramayı iptal et
document.getElementById('cancelSearchButton').addEventListener('click', () => {
   const matchmakingScreen = document.getElementById('matchmakingScreen');
   matchmakingScreen.style.display = 'none';
   mainScreen.style.display = 'flex';
   
   database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`).remove();
   cleanupMatchmakingListeners();
});

function listenForDuelCreation() {
   // 1) Eğer bu kişi davet EDEN tarafsa
   database.ref('duels')
       .orderByChild('inviter/studentId')
       .equalTo(selectedStudent.studentId)
       .on('child_added', snapshot => {
           const matchmakingScreen = document.getElementById('matchmakingScreen');
           matchmakingScreen.style.display = 'none';
           database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`).remove();
           cleanupMatchmakingListeners();
       });

   // 2) Eğer bu kişi davet ALAN tarafsa
   database.ref('duels')
       .orderByChild('invited/studentId')
       .equalTo(selectedStudent.studentId)
       .on('child_added', snapshot => {
           const matchmakingScreen = document.getElementById('matchmakingScreen');
           matchmakingScreen.style.display = 'none';
           database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`).remove();
           cleanupMatchmakingListeners();
       });
}

// Sayfa kapatıldığında ya da yenilendiğinde
window.addEventListener('beforeunload', () => {
   // Eğer matchmaking'de ise kaydı sil
   if (selectedStudent && selectedStudent.classId && selectedStudent.studentId) {
       database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`).remove();
   }
});


























const CACHE_KEYS = {
    PHOTOS: 'storePhotos',
    CHAMPION: 'championPhotos',
    PURCHASED: 'purchasedPhotos'
};

function getUserSpecificCacheKey(key) {
    return `${key}_${selectedStudent.studentId}`;
}

function saveToCache(key, data) {
    try {
        const userKey = getUserSpecificCacheKey(key);
        localStorage.setItem(userKey, JSON.stringify({
            userId: selectedStudent.studentId,
            data: data,
            timestamp: Date.now()
        }));
    } catch (error) {
        console.error('Cache save error:', error);
    }
}

function getFromCache(key) {
    try {
        const userKey = getUserSpecificCacheKey(key);
        const cached = localStorage.getItem(userKey);
        if (!cached) return null;

        const parsedCache = JSON.parse(cached);
        if (parsedCache.userId !== selectedStudent.studentId) {
            localStorage.removeItem(userKey);
            return null;
        }
        return parsedCache.data;
    } catch (error) {
        console.error('Cache read error:', error);
        return null;
    }
}



// Main photo categories with added cache handling
const photoCategories = {
   acemi: [
       {
           url: 'https://cdn.pixabay.com/photo/2013/07/13/13/14/tiger-160601_1280.png',
           price: 50,
           id: 'photo1'
       },
       {
           url: 'https://cdn.pixabay.com/photo/2016/05/12/23/03/lamb-1388937_1280.png', 
           price: 50,
           id: 'photo2'
       },
       {
           url: 'https://cdn.pixabay.com/photo/2016/08/16/16/39/elephant-1598359_1280.png',
           price: 50,
           id: 'photo3'
       },
       {
           url: 'https://cdn.pixabay.com/photo/2012/04/12/22/04/goldfish-30837_1280.png',
           price: 50,
           id: 'photo103'
       },
       {
           url: 'https://assets.nintendo.com/image/upload/f_auto/q_auto/dpr_1.5/c_scale,w_400/ncom/software/switch/70010000062008/desc/bf8a722d69cb3e3816b77626537d9e1a97b197e75cbbbdb04275d826dd8a03cb',
           price: 50,
           id: 'photo104'
       },
       {
           url: 'https://assets.vogue.com/photos/58920113186d7c1b6493ce40/master/pass/frozen-elsa-lesbian-girlfirend.jpg',
           price: 50,
           id: 'photo105'
       }
   ],
   cesur: [
       {
           url: 'https://media.tenor.com/H_O_BxpiM0UAAAAj/besiktas-logo.gif',
           price: 500,
           id: 'photo4'
       },
       {
           url: 'https://media.tenor.com/Uoxot7sqtkkAAAAM/galatasaray-galatasaray-sk.gif',
           price: 500,
           id: 'photo5'
       },
       {
           url: 'https://steamuserimages-a.akamaihd.net/ugc/915786698278004854/E1D44978A7692A298883D6589A5098B1D55882C0/?imw=5000&imh=5000&ima=fit&impolicy=Letterbox&imcolor=%23000000&letterbox=false',
           price: 500,
           id: 'photo209'
       },
       {
           url: 'https://giffiles.alphacoders.com/988/98813.gif',
           price: 500,
           id: 'photo204'
       },
       {
           url: 'https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExc250NzEycWR6bXR3YWFkZDExa2cxbzd4OWN3bGxmbTJ1Nmt2cWQ2dSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/OPYTbaVn5wTEJmfFCp/giphy.gif',
           price: 500,
           id: 'photo205'
       },
       {
           url: 'https://img1.picmix.com/output/stamp/normal/3/8/7/0/1750783_abb57.gif',
           price: 500,
           id: 'photo206'
       },
       {
           url: 'https://i.pinimg.com/originals/1d/b8/f3/1db8f34ba95f890d60bf529436045039.gif',
           price: 500,
           id: 'photo207'
       },
       {
           url: 'https://i.gifer.com/BAL5.gif',
           price: 500,
           id: 'photo208'
       },
       {
           url: 'https://www.icegif.com/wp-content/uploads/2024/04/roblox-icegif.gif',
           price: 500,
           id: 'photo7'
       },
       {
           url: 'https://www.icegif.com/wp-content/uploads/2024/09/brawl-stars-icegif-11.gif',
           price: 500,
           id: 'photo8'
       },
       {
           url: 'https://i.ibb.co/542sFk3/r123-1.gif',
           price: 500,
           id: 'photo9'
       },
       {
           url: 'https://i.ibb.co/S5yRj84/muslera-1.gif',
           price: 600,
           id: 'photo10'
       }

   ],
   lider: [
       {
           url: 'https://www.icegif.com/wp-content/uploads/2024/04/roblox-icegif.gif',
           price: 500,
           id: 'photo7'
       },
       {
           url: 'https://www.icegif.com/wp-content/uploads/2024/09/brawl-stars-icegif-11.gif',
           price: 500,
           id: 'photo8'
       },
       {
           url: 'https://i.ibb.co/542sFk3/r123-1.gif',
           price: 500,
           id: 'photo9'
       },
       {
           url: 'https://i.ibb.co/S5yRj84/muslera-1.gif',
           price: 600,
           id: 'photo10'
       },
       {
           url: 'https://cdn.pixabay.com/animation/2024/04/27/19/29/19-29-06-468_512.gif',
           price: 2000,
           id: 'photo11'
       }
   ],
   sampiyon: []
};


async function loadChampionPhotos() {
   try {
       // Firebase'den şampiyon fotoğraflarını çek
       const championPhotoRef = database.ref(
           `classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/championPhoto`
       );
       const snapshot = await championPhotoRef.once('value');
       const championPhoto = snapshot.val();

       // Şampiyon butonunu seç
       const championButton = document.querySelector('[data-category="sampiyon"]');
       
       if (championPhoto) {
           // Butonu göster
           championButton.style.display = 'block';
           
           // Fotoğrafları yapılandır
           const photos = Array.isArray(championPhoto) 
               ? championPhoto.map((url, index) => ({
                   url: url,
                   price: 5,
                   id: 'championSpecial' + index
               }))
               : [{
                   url: championPhoto,
                   price: 5,
                   id: 'championSpecial'
               }];

           // photoCategories'e ekle
           photoCategories.sampiyon = photos;
           
           // Cache'e kaydet
           const userCacheKey = `${CACHE_KEYS.CHAMPION}_${selectedStudent.studentId}`;
           localStorage.setItem(userCacheKey, JSON.stringify(photos));
       } else {
           // Şampiyon fotoğrafı yoksa butonu gizle
           championButton.style.display = 'none';
           photoCategories.sampiyon = [];
           
           const userCacheKey = `${CACHE_KEYS.CHAMPION}_${selectedStudent.studentId}`;
           localStorage.setItem(userCacheKey, '[]');
       }
   } catch (error) {
       console.error('Champion photo load error:', error);
       const championButton = document.querySelector('[data-category="sampiyon"]');
       championButton.style.display = 'none';
   }
}

function updateChampionButton(show) {
    const championButton = document.querySelector('[data-category="sampiyon"]');
    if (championButton) {
        championButton.style.display = show ? 'flex' : 'none';
    }
}

function updateProfileIcon() {
    const profileIcon = document.getElementById('profile-icon');
    if (!selectedStudent?.studentId) return;

    const cached = getFromCache('currentUserPhoto');
    if (cached) {
        profileIcon.src = cached;
    }

    database
        .ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/photo`)
        .once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const photoUrl = snapshot.val();
                profileIcon.src = photoUrl;
                saveToCache('currentUserPhoto', photoUrl);
            }
        });
}

document.getElementById('profile-icon').addEventListener('click', async () => {
    document.getElementById('profileChangeOverlay').style.display = 'flex';
    await loadChampionPhotos();
    loadProfilePhotos('acemi');
});

document.querySelectorAll('.category-button').forEach(button => {
    button.addEventListener('click', () => {
        // Tüm butonları soluklaştır
        document.querySelectorAll('.category-button').forEach(b => {
            b.classList.remove('active');
            b.style.opacity = '0.7';
        });
        
        // Tıklanan butonu aktifleştir
        button.classList.add('active');
        button.style.opacity = '1';
        
        loadProfilePhotos(button.dataset.category);
    });
});

async function buyProfilePhoto(photo) {
    // Satın almaya başlamadan önce onay sorusu ekliyoruz
    const confirmed = await showConfirmation("Bu profil fotoğrafını satın almak istediğinizden emin misiniz?");
    if (!confirmed) return;
    
    try {
        const studentRef = database.ref(
            `classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`
        );
        const diamondSnapshot = await studentRef.child('diamond').once('value');
        const currentDiamonds = diamondSnapshot.val() || 0;

        if (currentDiamonds >= photo.price) {
            const updates = {
                diamond: currentDiamonds - photo.price,
                [`purchasedPhotos/${btoa(photo.url)}`]: {
                    url: photo.url,
                    purchaseDate: Date.now()
                }
            };

            await studentRef.update(updates);
            // Elmas miktarını hemen güncelle
            document.getElementById('diamond-value').textContent = currentDiamonds - photo.price;
            
            // Cache güncellemesi
            const purchasedPhotos = getFromCache(CACHE_KEYS.PURCHASED) || {};
            purchasedPhotos[btoa(photo.url)] = {
                url: photo.url,
                purchaseDate: Date.now()
            };
            saveToCache(CACHE_KEYS.PURCHASED, purchasedPhotos);
            
            await showAlert('✨ Profil fotoğrafı başarıyla satın alındı!');
            
            // Mağaza ekranı yeniden yükleniyor; böylece ilgili fotoğrafın kartı "Satın Al" yerine "Kullan" butonu gösterecek
            const activeCategory = document.querySelector('.category-button.active').dataset.category;
            loadProfilePhotos(activeCategory);
        } else {
            await showAlert('💎 Yeterli elmasınız yok!');
        }
    } catch (error) {
        console.error('Satın alma hatası:', error);
        await showAlert('❌ Satın alma işlemi başarısız oldu: ' + error.message);
    }
}


async function useProfilePhoto(photoUrl) {
    try {
        await database
            .ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/photo`)
            .set(photoUrl);

        ['student-photo', 'profile-icon'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.src = photoUrl;
        });

        saveToCache('currentUserPhoto', photoUrl);
        await showAlert('✨ Profil fotoğrafı başarıyla değiştirildi!');
    } catch (error) {
        console.error('Fotoğraf değiştirme hatası:', error);
        await showAlert('❌ Fotoğraf değiştirme işlemi başarısız oldu.');
    }
}

async function loadProfilePhotos(category = 'acemi') {
   const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
   const studentSnapshot = await studentRef.once('value');
   const userData = studentSnapshot.val();
   
   document.getElementById('currentDiamonds').textContent = userData.diamond || 0;

   if (category === 'duel') {
       const duelStore = document.getElementById('duelCreditsStore');
       const container = document.getElementById('profilePhotosContainer');
       duelStore.style.display = 'block';
       container.style.display = 'none';

       // Sınırsız hak kontrolü
       if (userData.unlimitedCreditsUntil && userData.unlimitedCreditsUntil > Date.now()) {
           // Tüm butonları devre dışı bırak
           document.querySelectorAll('.credit-package .buy-button').forEach(button => {
               button.disabled = true;
               button.style.opacity = '0.5';
               button.style.cursor = 'not-allowed';
               button.textContent = 'Sınırsız Hak Aktif';
               button.onclick = null;
           });

           // Stats güncelle
           const creditsStats = document.getElementById('credits-stats');
           const creditsValue = document.getElementById('duel-credits-value');
           const daysLeft = Math.ceil((userData.unlimitedCreditsUntil - Date.now()) / (1000 * 60 * 60 * 24));
           
           creditsStats.classList.add('unlimited');
           creditsValue.innerHTML = `<span class="unlimited-badge">${daysLeft}GÜN</span>`;
       }
       return;
   }

   const container = document.getElementById('profilePhotosContainer');
   container.style.display = 'grid';
   document.getElementById('duelCreditsStore').style.display = 'none';
   container.innerHTML = '';

   try {
       let purchasedPhotos = getFromCache(CACHE_KEYS.PURCHASED);
       
       if (!purchasedPhotos) {
           const purchasedRef = database.ref(
               `classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/purchasedPhotos`
           );
           const purchasedSnapshot = await purchasedRef.once('value');
           purchasedPhotos = purchasedSnapshot.val() || {};
           saveToCache(CACHE_KEYS.PURCHASED, purchasedPhotos);
       }

       if (category === 'sampiyon' && photoCategories.sampiyon.length === 0) {
           container.innerHTML = '<div class="no-champion">Bu kategori sizin için henüz aktif değil</div>';
           return;
       }

       photoCategories[category].forEach((photo, index) => {
           createPhotoCard(photo, purchasedPhotos, category, container, index);
       });
   } catch (error) {
       console.error('Fotoğraf listesi yükleme hatası:', error);
       container.innerHTML = '<div class="error">Fotoğraflar yüklenirken bir hata oluştu</div>';
   }
}

function createPhotoCard(photo, purchasedPhotos, category, container, index) {
    const div = document.createElement('div');
    div.className = 'profile-photo-item';
    div.style.animationDelay = `${index * 0.1}s`;

    const encodedUrl = btoa(photo.url);
    const isPurchased = purchasedPhotos[encodedUrl];

    div.innerHTML = `
        <img src="${photo.url}" class="profile-photo" alt="Avatar">
        <div class="profile-photo-price">
            ${isPurchased 
                ? '<span class="purchased-badge">✓ Satın Alındı</span>'
                : `${photo.price} <span class="diamond-icon">💎</span>`
            }
        </div>
        <button class="profile-photo-button ${isPurchased ? 'use-button' : 'buy-button'}">
            ${isPurchased ? 'Kullan' : 'Satın Al'}
        </button>
    `;

    const button = div.querySelector('.profile-photo-button');
    button.onclick = () => isPurchased 
        ? useProfilePhoto(photo.url) 
        : buyProfilePhoto(photo);

    container.appendChild(div);
}

document.getElementById('profileCloseButton').addEventListener('click', () => {
    document.getElementById('profileChangeOverlay').style.display = 'none';
});









// Kayıt sistemi için gerekli DOM elementleri
const registerButton = document.getElementById('register-button');
const registrationOverlay = document.getElementById('registrationOverlay');
const closeRegistration = document.getElementById('closeRegistration');
const registerClassSelect = document.getElementById('registerClassSelect');
const registerUsername = document.getElementById('registerUsername');
const registerPassword = document.getElementById('registerPassword');
const registerEmail = document.getElementById('registerEmail');
const submitRegistration = document.getElementById('submitRegistration');
const registrationError = document.getElementById('registrationError');
const verificationOverlay = document.getElementById('verificationOverlay');

// Modal açma/kapama olayları
registerButton.addEventListener('click', () => {
    registrationOverlay.style.display = 'flex';
    loadClassesForRegistration();
});

closeRegistration.addEventListener('click', () => {
    registrationOverlay.style.display = 'none';
    resetRegistrationForm();
});

// Sınıf listesini yükleme fonksiyonu
function loadClassesForRegistration() {
    registerClassSelect.innerHTML = '<option value="">Sınıf Seçin</option>';
    database.ref('classes').once('value').then(snapshot => {
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const classId = childSnapshot.key;
                const className = childSnapshot.val().name;
                const option = document.createElement('option');
                option.value = classId;
                option.textContent = className;
                registerClassSelect.appendChild(option);
            });
        }
    }).catch(error => {
        console.error("Sınıf bilgileri yüklenirken hata:", error);
        registrationError.textContent = 'Sınıf bilgileri yüklenemedi';
    });
}

// Form validasyonu için input olayları
[registerClassSelect, registerUsername, registerPassword, registerEmail].forEach(element => {
    element.addEventListener('input', validateRegistrationForm);
});

// Form validasyon fonksiyonu
function validateRegistrationForm() {
    const username = registerUsername.value.trim();
    const password = registerPassword.value;
    const email = registerEmail.value.trim();
    const classId = registerClassSelect.value;
    let isValid = true;
    let errorMessage = '';

    // Tüm alanların doluluğunu kontrol et
    if (!username || !password || !email || !classId) {
        isValid = false;
        errorMessage = 'Tüm alanları doldurun';
    }
    // Kullanıcı adı uzunluk kontrolü
    else if (username.length > 11) {
        isValid = false;
        errorMessage = 'Kullanıcı adı 11 karakterden uzun olamaz';
    }
    // Şifre kontrolü
    else if (password.length < 6) {
        isValid = false;
        errorMessage = 'Şifre en az 6 karakter olmalı';
    }
    else if (!/(?=.*[A-Za-z])(?=.*\d)/.test(password)) {
        isValid = false;
        errorMessage = 'Şifre en az bir harf ve bir rakam içermeli';
    }
    // Email format kontrolü
    else if (!/\S+@\S+\.\S+/.test(email)) {
        isValid = false;
        errorMessage = 'Geçerli bir e-posta adresi girin';
    }

    submitRegistration.disabled = !isValid;
    registrationError.textContent = errorMessage;
    return isValid;
}

// Kullanıcı adı müsaitlik kontrolü
async function isUsernameAvailable(username, classId) {
    try {
        const snapshot = await database.ref(`classes/${classId}/students`)
            .orderByChild('name')
            .equalTo(username)
            .once('value');
        return !snapshot.exists();
    } catch (error) {
        console.error("Kullanıcı adı kontrolünde hata:", error);
        throw error;
    }
}

// Kayıt formu gönderme işlemi
submitRegistration.addEventListener('click', async () => {
    if (!validateRegistrationForm()) return;

    const username = registerUsername.value.trim();
    const password = registerPassword.value;
    const email = registerEmail.value.trim();
    const classId = registerClassSelect.value;

    try {
        // Kullanıcı adı müsaitlik kontrolü
        const usernameAvailable = await isUsernameAvailable(username, classId);
        if (!usernameAvailable) {
            registrationError.textContent = 'Bu kullanıcı adı zaten kullanılıyor';
            return;
        }

        // Firebase Authentication ile kullanıcı oluştur
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // E-posta doğrulama gönder
        await user.sendEmailVerification();

        // Veritabanına kullanıcı bilgilerini kaydet
        await database.ref(`classes/${classId}/students/${user.uid}`).set({
            name: username,
            password: password,
            email: email,
	    duelCredits: 300,
            diamond: 1500,
            photo: "https://cdn.pixabay.com/photo/2025/01/08/21/09/giraffe-9320109_640.jpg",
            gameCup: 0,
            inDuel: false,
            lastDiamondUpdate: firebase.database.ServerValue.TIMESTAMP
        });

        // Kayıt formunu kapat, doğrulama ekranını göster
        registrationOverlay.style.display = 'none';
        verificationOverlay.style.display = 'flex';
        
        // 5 saniye sonra doğrulama ekranını kapat
        setTimeout(() => {
            verificationOverlay.style.display = 'none';
        }, 5000);

        resetRegistrationForm();

    } catch (error) {
        console.error("Kayıt işleminde hata:", error);
        registrationError.textContent = error.message;
    }
});

// Form sıfırlama fonksiyonu
function resetRegistrationForm() {
    registerUsername.value = '';
    registerPassword.value = '';
    registerEmail.value = '';
    registerClassSelect.value = '';
    registrationError.textContent = '';
    submitRegistration.disabled = true;
}

// E-posta doğrulama durumu kontrolü
auth.onAuthStateChanged((user) => {
    if (user && !user.emailVerified) {
        user.reload().then(() => {
            if (user.emailVerified) {
                verificationOverlay.style.display = 'none';
            }
        });
    }
});









document.querySelectorAll('.category-button').forEach(button => {
    button.addEventListener('click', () => {
        // Aktif kategoriyi güncelle
        document.querySelectorAll('.category-button').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        
        // Doğru içeriği göster
        const duelStore = document.getElementById('duelCreditsStore');
        const photosContainer = document.getElementById('profilePhotosContainer');
        
        if (button.dataset.category === 'duel') {
            duelStore.style.display = 'block';
            photosContainer.style.display = 'none';
        } else {
            duelStore.style.display = 'none';
            photosContainer.style.display = 'grid';
            loadProfilePhotos(button.dataset.category);
        }
    });
});

// Düello kredisi satın alma fonksiyonu
async function purchaseCredits(amount, cost) {
    // Satın almaya başlamadan önce onay soruyoruz
    const confirmed = await showConfirmation("Bu düello biletini satın almak istediğinizden emin misiniz?");
    if (!confirmed) return;
    
    try {
        const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
        const snapshot = await studentRef.once('value');
        const userData = snapshot.val();
        const currentDiamonds = userData.diamond || 0;
        const currentCredits = userData.duelCredits || 0;

        if (currentDiamonds < cost) {
            await showAlert('Yeterli elmasınız yok!');
            return;
        }

        await studentRef.update({
            diamond: currentDiamonds - cost,
            duelCredits: currentCredits + amount
        });

        // Ana ekrandaki değerleri hemen güncelleyelim
        document.getElementById('currentDiamonds').textContent = currentDiamonds - cost;
        document.getElementById('duel-credits-value').textContent = currentCredits + amount;
        
        await showAlert('Düello hakkı satın alma başarılı!');
        
    } catch (error) {
        console.error('Satın alma hatası:', error);
        await showAlert('Satın alma işlemi başarısız oldu!');
    }
}


async function purchaseUnlimited(cost) {
    // Satın almaya başlamadan önce kullanıcıdan onay alalım.
    const confirmed = await showConfirmation("Bu ürünü satın almak istediğinizden emin misiniz?");
    if (!confirmed) {
        return;
    }
    
    try {
        const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
        const snapshot = await studentRef.once('value');
        const userData = snapshot.val();
        const currentDiamonds = userData.diamond || 0;

        if (currentDiamonds < cost) {
            await showAlert('Yeterli elmasınız yok!');
            return;
        }

        const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
        // Yeni sürenin bitiş tarihini hesaplıyoruz.
        const newUnlimitedUntil = Date.now() + thirtyDaysInMs;
        
        await studentRef.update({
            diamond: currentDiamonds - cost,
            unlimitedCreditsUntil: newUnlimitedUntil
        });

        document.getElementById('currentDiamonds').textContent = currentDiamonds - cost;
        const creditsStats = document.getElementById('credits-stats');
        const creditsValue = document.getElementById('duel-credits-value');
       
        creditsStats.classList.add('unlimited');
        // Yeni süreye göre kaç gün kalacağını hesaplayıp görüntülüyoruz.
        creditsValue.innerHTML = `<span class="unlimited-badge">${Math.ceil((newUnlimitedUntil - Date.now())/(1000*60*60*24))}GÜN</span>`;

        // Tüm düello paketi butonlarını devre dışı bırakıyoruz.
        const allPackageButtons = document.querySelectorAll('.credit-package .buy-button');
        allPackageButtons.forEach(button => {
            button.disabled = true;
            button.style.opacity = '0.5';
            button.style.cursor = 'not-allowed';
            button.textContent = 'Sınırsız Hak Aktif';
            button.onclick = null;
        });

        await showAlert('✨ Sınırsız düello hakkı aktifleştirildi!');
       
    } catch (error) {let chosen = shuffleArray(allQuestions).slice(0, 10);
        console.error('Satın alma hatası:', error);
        await showAlert('Satın alma işlemi başarısız oldu!');
    }
}









    </script>
    </body>
    
</html>
