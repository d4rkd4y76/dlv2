<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Åžampiyonlar DÃ¼ellosu</title>
    <!-- Comfortaa Font -->
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS KodlarÄ± */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comfortaa', cursive;
        }

        body {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: backgroundPulse 10s infinite alternate;
        }

        @keyframes backgroundPulse {
            from {
                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            }
            to {
                background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            }
        }

        .container, .game-container, .student-selection-container, .single-player-game-container, .duel-selection-container, .duel-game-container {
            background: white;
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 900px;
            text-align: left;
            transform: scale(0.95);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.5s forwards;
        }

.logout-button {
    background-color: #dc3545; /* KÄ±rmÄ±zÄ± renk */
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 10px; /* KÃ¶ÅŸeleri yuvarla */
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
    font-size: 1.1em;
    margin-top: 20px; /* Ãœstten boÅŸluk */
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.logout-button:hover {
    background-color: #c82333; /* Hover sÄ±rasÄ±nda biraz daha koyu kÄ±rmÄ±zÄ± */
    transform: scale(1.05);
    box-shadow: 0 7px 20px rgba(0,0,0,0.2);
}


select {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    border: 2px solid #ff8a00;
    border-radius: 12px;
    padding: 12px;
    font-size: 1.1em;
    color: #333;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease-in-out;
}

.friends-button {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: white;
    padding: 18px;
    border: none;
    border-radius: 12px;
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.friends-button:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, #4f46e5, #4338ca);
}

.friends-container {
    display: none;
    flex-direction: column;
    gap: 25px;
    padding: 30px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
}

.search-section {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.search-box {
    display: flex;
    gap: 10px;
}

.search-box input {
    flex: 1;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1em;
}

#search-button {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0 20px;
    cursor: pointer;
    transition: background 0.3s;
}

.search-results, .friends-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.friend-card {
    display: flex;
    align-items: center;
    padding: 15px;
    background: #f3f4f6;
    border-radius: 10px;
    gap: 15px;
}

.player-item {
    display: flex;
    align-items: center;
    gap: 15px;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.player-photo {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ff8a00;
}

.player-name {
    flex: 1;
    font-size: 1em;
    font-weight: bold;
    color: #333;
}

.davet-et-button, .oyunda-button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-size: 0.9em;
}

.davet-et-button {
    background-color: #17a2b8;
    color: white;
}

.davet-et-button:hover {
    background-color: #138496;
}

.oyunda-button {
    background-color: #f59e0b;
    color: white;
    cursor: not-allowed;
    opacity: 0.7;
}

.oyunda-button:hover {
    background-color: #d97706;
    opacity: 0.7;
}


.friend-photo {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}

.friend-info {
    flex: 1;
}

.friend-name {
    font-weight: bold;
    color: #111827;
}

.friend-class {
    color: #6b7280;
    font-size: 0.9em;
}

.add-friend-button {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.add-friend-button:hover {
    background: #059669;
    transform: scale(1.05);
}

.friend-status {
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.9em;
}

.status-offline {
    background: #e5e7eb;
    color: #374151;
}

.status-online {
    background: #dcfce7;
    color: #166534;
}



.status-in-game {
    background: #fee2e2;
    color: #991b1b;
}

/* Hover ve odaklanma efekti */
select:hover, select:focus {
    background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
    border-color: #f7786b;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    outline: none;
}

/* MenÃ¼ seÃ§enekleri */
option {
    background-color: white;
    color: #333;
    padding: 10px;
    font-size: 1em;
}

        @keyframes fadeInUp {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

#main-screen {
    display: flex;
    flex-direction: column; /* Ä°Ã§eriÄŸi dikey hizalar */
    align-items: center; /* Yatayda ortalar */
    justify-content: center; /* Dikeyde ortalar */
    gap: 20px; /* Elemanlar arasÄ±ndaki boÅŸluk */
    position: relative; /* Efektler iÃ§in gerekli */
    padding: 30px;
    width: 80%; /* GeniÅŸlik (ekranÄ±n %80'i) */
    max-width: 900px; /* Maksimum geniÅŸlik */
    min-height: 300px; /* Minimum yÃ¼kseklik */
    background: linear-gradient(135deg, #ffffff, #f1f1f1); /* Arka plan gradyanÄ± */
    border: 5px solid transparent;
    border-radius: 20px; /* KÃ¶ÅŸe yuvarlama */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* YumuÅŸak gÃ¶lge */
    overflow: hidden; /* TaÅŸmalarÄ± gizler */
    z-index: 1; /* DiÄŸer elemanlarla Ã§akÄ±ÅŸmayÄ± Ã¶nler */
}

/* Hareketli Ä±ÅŸÄ±k efekti */
#main-screen::before {
    content: '';
    position: absolute;
    top: -20%;
    left: -150%;
    width: 300%;
    height: 200%;
    background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.4) 50%, rgba(255, 255, 255, 0) 100%);
    animation: lightMove 5s infinite linear; /* Hareketli Ä±ÅŸÄ±k efekti */
    z-index: 0;
    pointer-events: none; /* EtkileÅŸimden kaÃ§Ä±nÄ±r */
}

/* Ã‡erÃ§eve parlamasÄ± */
@keyframes glowingBorder {
    0% {
        box-shadow: 0 0 5px #ff8a00, 0 0 10px #ff8a00;
    }
    50% {
        box-shadow: 0 0 15px #fbc2eb, 0 0 20px #fbc2eb;
    }
    100% {
        box-shadow: 0 0 5px #a6c1ee, 0 0 10px #a6c1ee;
    }
}

@keyframes lightMove {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(100%);
    }
}

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .student-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40%;
            animation: bounceIn 1s;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .student-photo {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #ff8a00;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }

        .student-photo:hover {
            transform: rotate(360deg);
        }

        .student-name {
            font-size: 1em;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px #ff8a00;
        }

        .student-cup {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
            animation: popIn 0.5s;
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

.game-cup-image {
    width: 40px;
    height: 40px;
    margin-bottom: 5px;
    transform-origin: center;
    animation: trophyBounce 2s infinite;
}

@keyframes trophyGlow {
    from {
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }
    to {
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
    }
}

@keyframes trophyBounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

.trophy-container {
    background: linear-gradient(135deg, #ffd700, #ffa500);
    border-radius: 15px;
    padding: 5px;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    margin: 15px 0;
    animation: trophyGlow 2s infinite alternate;
}

.trophy-inner {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

        @keyframes rotateCup {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

.game-cup-score {
    font-size: 1.5em;
    font-weight: bold;
    background: linear-gradient(45deg, #ffd700, #ff8c00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
}

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 55%;
            align-items: flex-start;
            animation: slideButtons 0.7s ease forwards;
        }

        @keyframes slideButtons {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

.buttons {
    display: flex; /* Flexbox dÃ¼zeni */
    flex-direction: column; /* ButonlarÄ± dikey hizalar */
    align-items: stretch; /* ButonlarÄ± Ã§erÃ§eveye tam yayar */
    justify-content: center; /* Butonlar arasÄ±nda eÅŸit hizalama */
    gap: 20px; /* Butonlar arasÄ±nda dikey boÅŸluk */
    padding: 10px; /* Ã‡erÃ§eve iÃ§i boÅŸluk */
    width: 100%; /* Ã‡erÃ§eve geniÅŸliÄŸi */
    max-width: 900px; /* Maksimum geniÅŸlik */
    margin: 0 auto; /* Ortalamak iÃ§in */
    box-sizing: border-box; /* Padding ve border dahil */
}

.buttons button {
    width: 100%; /* Butonlar Ã§erÃ§eveye tam sÄ±ÄŸar */
    padding: 18px; /* Ä°Ã§erik boÅŸluÄŸu */
    border: none;
    border-radius: 12px; /* KÃ¶ÅŸeleri yuvarlar */
    font-size: 1.1em; /* YazÄ± boyutu */
    color: white;
    cursor: pointer;
    transition: transform 0.2s, opacity 0.2s, box-shadow 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.offline-button {
    background-color: #808080;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: not-allowed;
    opacity: 0.7;
    font-size: 0.9em;
}

.student-diamond {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 10px;
    animation: diamondGlow 2s infinite alternate;
}

.diamond-count {
    font-size: 1.5em;
    font-weight: bold;
    color: #1e90ff;
    text-shadow: 0 0 3px #1e90ff;
    animation: diamondPulse 2.5s infinite alternate;
}

@keyframes diamondGlow {
    from {
        filter: drop-shadow(0 0 2px #1e90ff);
    }
    to {
        filter: drop-shadow(0 0 8px #1e90ff);
    }
}

@keyframes diamondPulse {
    from {
        transform: scale(1);
    }
    to {
        transform: scale(1.1);
    }
}

.buttons button::before {
    content: '';
    position: absolute;
    width: 200%;
    height: 200%;
    background: rgba(255, 255, 255, 0.2);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(45deg);
    transition: all 0.5s;
}

.buttons button:hover::before {
    width: 0%;
    height: 0%;
    opacity: 0;
}

.buttons button:hover {
    transform: scale(1.05);
    opacity: 0.9;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.single-player {
    background-color: #ff6f61;
}


.friend-added-button {
    background-color: #808080;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: not-allowed;
    opacity: 0.7;
    font-size: 0.9em;
}

.add-friend-button {
    background-color: #28a745;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-size: 0.9em;
}

.add-friend-button:hover {
    background-color: #218838;
    transform: scale(1.05);
}

.kupa-siralama-button {
    background-color: #f7cac9;
    color: black !important;
    background-image: linear-gradient(135deg, #edf500, #8ff514);
    box-shadow: 0 0 15px rgba(247, 202, 201, 0.7);
    position: relative;
    overflow: hidden;
}

.kupa-siralama-button::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: rgba(247, 202, 201, 0.2);
    transform: rotate(45deg);
    animation: shine 3s infinite;
}


        @keyframes shine {
            0% {
                transform: rotate(45deg) translate(-100%, -100%);
            }
            100% {
                transform: rotate(45deg) translate(100%, 100%);
            }
        }

        .game-container, .student-selection-container, .single-player-game-container, .duel-selection-container, .duel-game-container {
            display: none;
            flex-direction: column;
            gap: 25px;
            animation: fadeIn 0.5s forwards;
        }

        .table-section {
            background-color: #fff3e0;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            text-align: left;
        }

        .table-section h3 {
            margin-bottom: 15px;
            color: #ff8a00;
            font-size: 1.5em;
            border-bottom: 2px solid #ff8a00;
            padding-bottom: 5px;
        }

        .table-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .table-section select, .table-section input {
            width: 100%;
            padding: 14px 20px;
            margin-bottom: 20px;
            border: 2px solid #ff8a00;
            border-radius: 8px;
            font-size: 1.2em;
            color: #333;
            background-color: #fff;
            transition: border-color 0.3s;
        }

        .table-section select:focus, .table-section input:focus {
            border-color: #f7786b;
            outline: none;
        }

        .back-button, .start-game-button, .login-button, .duel-start-button, .ranking-back-button, .close-ranking-button {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            font-size: 1.1em;
            margin-top: 25px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .back-button, .ranking-back-button, .close-ranking-button {
            background-color: #555;
            color: white;
            width: 100%;
            max-width: 220px;
        }

        .back-button:hover, .ranking-back-button:hover, .close-ranking-button:hover {
            background-color: #333;
            transform: scale(1.05);
        }

        .start-game-button, .duel-start-button {
            background-color: #28a745;
            color: white;
            opacity: 0.7;
            cursor: not-allowed;
            width: 100%;
            max-width: 220px;
        }

        .start-game-button.active, .duel-start-button.active {
            opacity: 1;
            cursor: pointer;
        }

        .start-game-button:hover.active, .duel-start-button:hover.active {
            transform: scale(1.05);
        }

        .login-button {
            background-color: #007BFF;
            color: white;
            opacity: 0.7;
            cursor: not-allowed;
            width: 100%;
            max-width: 220px;
            transition: opacity 0.3s;
        }

        .login-button.active {
            opacity: 1;
            cursor: pointer;
        }

        .login-button:hover.active {
            transform: scale(1.05);
        }

        .error {
            color: red;
            margin-top: 15px;
            text-align: center;
            font-size: 1.1em;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

.single-player-game-container, .duel-game-container {
    display: none; /* Bu konteyner baÅŸlangÄ±Ã§ta gÃ¶rÃ¼nmez */
    flex-direction: column; /* Ä°Ã§erikleri dikey olarak hizalar */
    gap: 25px; /* Ä°Ã§erikler arasÄ±ndaki boÅŸluk 25 piksel */
    width: 100%; /* Konteyner geniÅŸliÄŸi ekranÄ±n tamamÄ±nÄ± kaplar */
    max-width: none; /* GeniÅŸlik sÄ±nÄ±rÄ± yok */
    justify-content: center; /* Ä°Ã§erikleri dikeyde ortalar */
    align-items: center; /* Ä°Ã§erikleri yatayda ortalar */
    padding: 30px; /* Kenar boÅŸluklarÄ± (Ã§erÃ§evenin iÃ§indeki iÃ§eriklerin etrafÄ±ndaki boÅŸluk) */
    animation: fadeIn 0.5s forwards; /* GÃ¶rÃ¼nÃ¼r hale geldiÄŸinde fadeIn animasyonu oynar */
}


        .question-number {
            margin-bottom: 15px;
            font-size: 1.0em;
            color: #555;
            font-weight: bold;
        }

        .progress-container {
            width: 100%;
            max-width: 900px;
            margin-bottom: 1px;
        }

        .progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            height: 25px;
        }

        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background-color: #28a745;
            transition: width 0.4s ease;
        }

        .timer-container {
            margin-bottom: 1px;
        }

        .timer {
            font-size: 1.0em;
            color: #ff0000;
            font-weight: bold;
            animation: pulseTimer 1.5s infinite;
        }

        @keyframes pulseTimer {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .question-container {
    display: flex;
    flex-direction: column; /* Dikey hizalama */
    align-items: center; /* Yatayda ortalama */
    justify-content: center; /* Dikeyde ortalama */
    width: 100%; /* Ã‡erÃ§evenin geniÅŸliÄŸi */
    max-width: 700px; /* Maksimum geniÅŸlik azaltÄ±ldÄ± */
    text-align: center; /* Metni ortala */
    min-height: 300px; /* Ã‡erÃ§eve yÃ¼ksekliÄŸi azaltÄ±ldÄ± */
    padding: 15px; /* Daha az boÅŸluk */
    border: 2px solid #ff8a00; /* Ã‡erÃ§eve kalÄ±nlÄ±ÄŸÄ± azaltÄ±ldÄ± */
    border-radius: 10px; /* KÃ¶ÅŸe yuvarlama kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */
    background-color: #fffbea;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* GÃ¶lge kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */
    overflow: hidden; /* Ã‡erÃ§eve dÄ±ÅŸÄ±na taÅŸmalarÄ± gizle */
}

        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .question-image {
    max-width: 100%; /* Resmin geniÅŸliÄŸi Ã§erÃ§eveye sÄ±ÄŸacak ÅŸekilde */
    max-height: 60%; /* Resmin yÃ¼ksekliÄŸini sÄ±nÄ±rla */
    object-fit: contain; /* Resmin orantÄ±lÄ± ÅŸekilde sÄ±ÄŸmasÄ±nÄ± saÄŸla */
    margin: 0 auto; /* Resmi yatayda ortala */
    display: block; /* Blok element olarak davranÄ±r */
}

        @keyframes fadeInImage {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .question-text {
    font-size: 1.1em; /* Soru metni boyutunu ayarla */
    font-weight: bold;
    margin-bottom: 10px; /* Resim ile metin arasÄ±nda boÅŸluk */
    word-wrap: break-word; /* Uzun kelimeleri kÄ±r */
    text-align: center; /* Metni ortala */
    max-width: 100%; /* Ã‡erÃ§eve sÄ±nÄ±rlarÄ± iÃ§inde kalmasÄ±nÄ± saÄŸla */
}

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .options-container {
            display: flex;
            gap: 20px;
            flex-direction: row;
            justify-content: center;
            width: 100%;
            max-width: 900px;
            flex-wrap: wrap; 
            animation: fadeInOptions 0.5s;
        }

        @keyframes fadeInOptions {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .option-button {
            padding: 10px 15px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s, opacity 0.3s;
            flex: 1 1 30%;
            min-width: 160px;
            max-width: 350px;
            font-size: 1.0em;
            margin: 3px 2;
            white-space: normal;
            word-wrap: break-word;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .option-button::after {
            content: '';
            position: absolute;
            width: 300%;
            height: 300%;
            background: rgba(255, 255, 255, 0.2);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            transition: all 0.5s;
        }

        .option-button:hover::after {
            width: 0%;
            height: 0%;
            opacity: 0;
        }

        .option-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
            opacity: 0.95;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .option-button.correct {
            background-color: #28a745 !important;
            animation: pulseCorrect 0.5s;
        }

        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .option-button.wrong {
            background-color: #dc3545 !important;
            animation: shakeWrong 0.5s;
        }

        @keyframes shakeWrong {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .option-chosen {
            border: 4px solid #ff8a00;
            box-shadow: 0 0 15px rgba(255,138,0,0.5);
        }

        .option-faded {
            opacity: 0.5;
        }

        .score-container {
            font-size: 2em;
            color: #333;
            text-align: center;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            animation: fadeInScore 0.5s;
        }

        @keyframes fadeInScore {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

.score-message {
    font-size: 1.1em; /* YazÄ± boyutunu Ã§erÃ§eveye uygun olacak ÅŸekilde ayarlayÄ±n */
    font-weight: bold;
    margin-top: 25px;
    animation: glow 1.5s infinite alternate;
    text-align: center; /* Metni ortala */
    max-width: 90%; /* Ã‡erÃ§evenin geniÅŸliÄŸine uygun olacak ÅŸekilde sÄ±nÄ±rla */
    white-space: normal; /* Alt satÄ±ra geÃ§mesini saÄŸla */
    word-wrap: break-word; /* Uzun kelimeleri kÄ±rarak alt satÄ±ra geÃ§ir */
    overflow: visible; /* Ã‡erÃ§eve dÄ±ÅŸÄ±na taÅŸmayÄ± engelle */
    margin: 0 auto; /* Yatayda ortala */
    line-height: 1.2; /* SatÄ±rlar arasÄ±ndaki mesafeyi ayarla */
}

        .score-message.blue {
            color: #007BFF;
        }

        .score-message.green {
            color: #28a745;
        }

        .score-message.purple {
            color: #6f42c1;
            text-shadow: 0 0 15px #6f42c1, 0 0 25px #6f42c1, 0 0 35px #6f42c1;
            animation: glowMukemmel 1.5s infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
            }
            to {
                text-shadow: 0 0 25px rgba(0, 123, 255, 1);
            }
        }

        @keyframes glowMukemmel {
            from {
                text-shadow: 0 0 15px rgba(111, 66, 193, 0.5);
            }
            to {
                text-shadow: 0 0 25px rgba(111, 66, 193, 1), 0 0 35px rgba(111, 66, 193, 0.7);
            }
        }

        .final-image {
            width: 220px;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeInImage 1s;
        }

        /* Yeni Eklenen Stil: End Game Button (Geri DÃ¶n) */
        .end-game-button {
            background-color: #007BFF; /* Mavi renk */
            color: white;
            padding: 8px 17px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 0.8em;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .end-game-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.2);
        }

        /* Yeni +1 Efekti */
        .animated-plus-one {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8em;
            color: #28a745;
            pointer-events: none;
            z-index: 1000;
            opacity: 1;
            animation: plusOneMove 1s forwards;
        }

        @keyframes plusOneMove {
            0% {
                opacity:1;
                transform: translate(-50%, -50%) translate(0px, 0px) scale(1);
            }
            100% {
                opacity:0;
                transform: translate(-50%, -50%) translate(300px, -300px) scale(0.5);
            }
        }

        /* "Oyunda" Butonu Ä°Ã§in Ek Stil */
        .oyunda-button {
            background-color: #f59e0b; /* Turuncu renk */
            border: none;
            border-radius: 6px;
            color: white;
            padding: 8px 14px;
            font-size: 1em;
            cursor: not-allowed;
            opacity: 0.7;
            transition: background-color 0.3s;
        }

        .oyunda-button:hover {
            background-color: #d97706;
            opacity: 0.7; /* Hover etkisini kaldÄ±rmak iÃ§in */
            transform: none;
        }

        /* Alert, Prompt, Invitation Modals */
        .alert-overlay, .prompt-overlay, .invitation-overlay {
            position: fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items:center;
            justify-content:center;
            z-index:1000000;
            animation: fadeInModal 0.3s;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .alert-content, .prompt-content, .invitation-content {
            background:#fff;
            padding:25px;
            border-radius:15px;
            width:90%;
            max-width:350px;
            box-shadow:0 10px 25px rgba(0,0,0,0.3);
            display:flex;
            flex-direction: column;
            gap:20px;
            animation: slideDownModal 0.3s;
        }

        @keyframes slideDownModal {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-message, .prompt-message, .invitation-message {
            font-size:1.2em;
            color:#333;
            text-align: center;
        }

        .alert-ok-button, .prompt-ok-button, .prompt-cancel-button, .invitation-accept-button, .invitation-decline-button {
            background-color: #007BFF;
            color:white;
            border:none;
            border-radius:8px;
            padding:12px 25px;
            cursor:pointer;
            transition: background-color 0.3s;
            font-size:1em;
            font-weight: bold;
        }

        .alert-ok-button:hover, .prompt-ok-button:hover, .prompt-cancel-button:hover, .invitation-accept-button:hover, .invitation-decline-button:hover {
            background-color: #0056b3;
        }

        .prompt-input {
            width:100%;
            padding:12px;
            border:2px solid #ff8a00;
            border-radius:8px;
            font-size:1.1em;
            transition: border-color 0.3s;
        }

        .prompt-input:focus {
            border-color: #f7786b;
            outline: none;
        }

        .prompt-buttons, .invitation-buttons {
            display:flex;
            justify-content: space-between;
            gap: 10px;
        }

        .prompt-cancel-button, .invitation-decline-button {
            background-color:#dc3545;
        }

        .prompt-cancel-button:hover, .invitation-decline-button:hover {
            background-color:#c82333;
        }

        /* DÃ¼ello SeÃ§im EkranÄ± */
.duel-selection-container {
    display: none;
    flex-direction: column;
    gap: 25px;
    width: 100%;
    max-width: 900px;
    background: white;
    padding: 30px 40px;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    margin: auto;
    position: relative;
    z-index: 1000;
}

        /* Ä°ki oyuncuyu eÅŸit orantÄ±da yerleÅŸtirmek iÃ§in space-evenly kullandÄ±k */
.duel-bottom-info {
    display: flex;
    justify-content: space-evenly; /* Kartlar arasÄ±nda eÅŸit boÅŸluk */
    align-items: center; /* KartlarÄ± yatayda ortala */
    width: 100%; /* GeniÅŸlik tÃ¼m alanÄ± kaplasÄ±n */
    padding: 10px 0; /* Ãœst ve alt boÅŸluk */
}


.duel-player-info {
    display: flex;
    flex-direction: column; /* Resim ve ismi dikey hizalar */
    align-items: center; /* Yatayda ortalar */
    justify-content: center; /* Dikeyde ortalar */
    text-align: center; /* YazÄ±yÄ± ortala */
    gap: 10px; /* Resim ile isim arasÄ±ndaki boÅŸluk */
    width: 100%; /* KartÄ±n geniÅŸliÄŸi */
}

.duel-player-photo {
    width: 80px; /* Resim geniÅŸliÄŸi */
    height: 80px; /* Resim yÃ¼ksekliÄŸi */
    border-radius: 50%; /* Yuvarlak resim */
    object-fit: cover; /* Resmi Ã§erÃ§eveye sÄ±ÄŸdÄ±r */
    border: 3px solid #ff8a00; /* Ã‡erÃ§eve rengi */
    margin-bottom: 5px; /* Resim ile isim arasÄ±ndaki boÅŸluk */
}


.duel-player-photo:hover {
    transform: rotate(360deg);
}

.duel-player-name {
    font-size: 1em; /* YazÄ± boyutu */
    font-weight: bold; /* YazÄ± kalÄ±nlÄ±ÄŸÄ± */
    color: #333; /* YazÄ± rengi */
    text-align: center; /* YazÄ±yÄ± ortala */
    white-space: normal; /* YazÄ±nÄ±n satÄ±r kaydÄ±rmasÄ±nÄ± etkinleÅŸtir */
    word-wrap: break-word; /* Uzun kelimeleri kaydÄ±r */
    overflow-wrap: break-word; /* Modern tarayÄ±cÄ± desteÄŸi */
    max-width: 100%; /* Ã‡erÃ§eve sÄ±nÄ±rÄ±nda kal */
    line-height: 1.2; /* SatÄ±rlar arasÄ± boÅŸluÄŸu azalt */
}



        .duel-controls {
            display:flex;
            flex-direction: column;
            gap:15px;
            align-items:center;
            justify-content:center;
            margin-top:30px;
        }

        .duel-start-button {
            display:inline-block;
            margin:0 auto;
            background-color: #28a745;
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            cursor: not-allowed;
            opacity: 0.7;
            transition: background-color 0.3s, transform 0.3s, opacity 0.3s;
            font-size:1.1em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .duel-start-button.active {
            cursor: pointer;
            opacity: 1;
        }

        .duel-start-button:hover.active {
            transform: scale(1.05);
            background-color: #218838;
        }

        .duel-game-container {
            display: none;
            flex-direction: column;
            gap: 5px;
            width: 100%;
            max-width: none;
            justify-content: center;
            align-items: center;
            padding: 30px;
            animation: fadeIn 0.5s forwards;
        }

        .players-info-row {
            display: flex;
            width: 100%;
            max-width: 900px;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            animation: slideInPlayers 0.5s forwards;
        }

        @keyframes slideInPlayers {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .duel-player-score {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
            overflow:hidden;
            position: relative;
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .duel-player-score img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #ff8a00;
            object-fit: cover;
            margin-bottom: 10px;
        }

.duel-player-score .duel-player-name {
    font-size: 0.8em; /* YazÄ± boyutunu biraz kÃ¼Ã§Ã¼ltebilirsiniz */
    font-weight: bold;
    color: #333;
    white-space: normal; /* Uzun metinlerin satÄ±r atlamasÄ±na izin verir */
    word-wrap: break-word; /* Uzun kelimelerin uygun yerlerde kÄ±rÄ±lmasÄ±nÄ± saÄŸlar */
    text-align: center; /* Metni ortalar */
    overflow: hidden; /* Ã‡erÃ§evenin dÄ±ÅŸÄ±na taÅŸmayÄ± engeller */
    text-shadow: 1px 1px #ff8a00;
    max-width: 150px; /* Ã‡erÃ§evenin geniÅŸliÄŸine gÃ¶re uyarlanÄ±r */
    display: -webkit-box; /* Ã‡ok satÄ±rlÄ± metni sÄ±nÄ±rlamak iÃ§in */
    -webkit-line-clamp: 2; /* Maksimum 2 satÄ±r gÃ¶ster */
    -webkit-box-orient: vertical;
}

        .duel-player-correct-count {
            font-size: 1.5em;
            margin-top: 8px;
            color: #28a745;
            font-weight: bold;
            transition: transform 0.3s ease;
            animation: bounceCount 0.6s;
        }

        @keyframes bounceCount {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

.winner-message {
    font-size: 1.5em; /* YazÄ± boyutu baÅŸlangÄ±Ã§ deÄŸeri */
    font-weight: bold; /* YazÄ± kalÄ±nlÄ±ÄŸÄ± */
    color: #11b819; /* YazÄ± rengi */
    text-align: center; /* YazÄ±yÄ± ortala */
    animation: glowMukemmel 1.5s infinite alternate; /* Animasyon */
    margin-bottom: 25px; /* Alt boÅŸluk */
    text-shadow: 3px 4px #8cd900; /* YazÄ± gÃ¶lgesi */
    word-wrap: break-word; /* Uzun kelimeleri kaydÄ±r */
    overflow-wrap: break-word; /* Modern tarayÄ±cÄ±lar iÃ§in kelime kaydÄ±rma */
    white-space: normal; /* SatÄ±r kaydÄ±rmayÄ± etkinleÅŸtir */
    padding: 10px; /* Ã‡erÃ§eve kenar boÅŸluÄŸu */
    line-height: 1.2; /* SatÄ±r aralÄ±ÄŸÄ±nÄ± sÄ±kÄ±laÅŸtÄ±r */
}

        .score-flash {
            animation: scoreFlash 0.8s ease;
        }

        @keyframes scoreFlash {
            0% {transform: scale(1) rotate(0deg); color:#28a745;}
            30% {transform: scale(1.5) rotate(10deg); color:#28a745;}
            60% {transform: scale(1.3) rotate(-10deg); color:#28a745;}
            100% {transform: scale(1) rotate(0deg); color:#28a745;}
        }

        /* Oyundakiler Modal */
        .players-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.6);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:1000000;
            animation: fadeInModal 0.3s;
        }

        .players-content {
            background:#fff;
            padding:30px;
            border-radius:15px;
            width:90%;
            max-width:450px;
            box-shadow:0 10px 25px rgba(0,0,0,0.3);
            display:flex;
            flex-direction:column;
            gap:25px;
            animation: slideDownModal 0.3s;
        }

        .players-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .players-header h3 {
            margin:0;
            font-size:1.8em;
            color:#ff8a00;
            text-shadow: 1px 1px #f7786b;
        }

        .players-close {
            background: none;
            border:none;
            font-size:1.5em;
            cursor:pointer;
            color:#ff6f61;
            transition: color 0.3s;
        }

        .players-close:hover {
            color:#e63946;
        }

        .players-list {
            list-style:none;
            padding:0;
            margin:0;
            display:flex;
            flex-direction:column;
            gap:15px;
        }

        .players-list li {
            display:flex;
            align-items:center;
            gap:15px;
            background:#f0f0f0;
            padding:12px;
            border-radius:8px;
            justify-content: space-between;
            transition: background-color 0.3s;
        }

        .players-list li:hover {
            background-color: #e0e0e0;
        }

        .players-list img {
            width:50px;
            height:50px;
            border-radius:50%;
            object-fit:cover;
            border:3px solid #ff8a00;
        }

        .players-list .player-name {
            font-size:1.1em;
            color:#333;
            flex:1;
            text-shadow: 1px 1px #ff8a00;
        }

        /* Yeni Eklenen Stil: Ranking Panel (Yan Panel) */
        .ranking-panel {
            position: fixed;
            top: 0;
            right: -100%; /* BaÅŸlangÄ±Ã§ta gÃ¶rÃ¼nmez */
            width: 450px;
            max-width: 90%;
            height: 100%;
            background-color: #fffbea;
            box-shadow: -3px 0 10px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 1000000;
            display: flex;
            flex-direction: column;
            padding: 25px;
            overflow-y: auto;
            animation: slideInPanel 0.3s forwards;
        }

        @keyframes slideInPanel {
            from { right: -100%; }
            to { right: 0; }
        }

        .ranking-panel.open {
            right: 0; /* AÃ§Ä±ldÄ±ÄŸÄ±nda gÃ¶rÃ¼nÃ¼r */
        }

        .ranking-panel h2 {
            font-size: 2.2em;
            color: #ff8a00;
            margin-bottom: 25px;
            text-align: center;
            position: relative;
            text-shadow: 1px 1px #f7786b;
        }

        /* Ranking Panel Ä°Ã§in Geri DÃ¶n Butonu */
        .ranking-back-button {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            background-color: #555;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            font-size: 1.1em;
            margin-top: 30px;
            align-self: center;
            width: 100%;
            max-width: 220px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .ranking-back-button:hover {
            background-color: #333;
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.3);
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .ranking-table th, .ranking-table td {
            border: 2px solid #ff8a00;
            padding: 15px;
            text-align: center;
            font-size: 1.1em;
            color: #333;
        }

        .ranking-table th {
            background-color: #ffe5d9;
            color: #ff8a00;
            font-weight: bold;
            text-shadow: 1px 1px #f7786b;
        }

        .ranking-table tr:nth-child(even) {
            background-color: #fff3e0;
        }

        .ranking-table tr:hover {
            background-color: #ffe5d9;
        }

        .ranking-player-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #ff8a00;
        }

        /* Top 3 Ã¶zel stiller */
        .ranking-table tr.top-1 {
            background-color: #FFD700 !important; /* AltÄ±n */
            animation: pulse 2s infinite;
        }

        .ranking-table tr.top-2 {
            background-color: #C0C0C0 !important; /* GÃ¼mÃ¼ÅŸ */
            animation: pulse 2s infinite;
        }

        .ranking-table tr.top-3 {
            background-color: #CD7F32 !important; /* Bronz */
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(0,0,0,0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 25px rgba(0,0,0,0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(0,0,0,0.3);
            }
        }
    
/* Crazy Animated Ranking Table */
.ranking-table-container {
    max-height: 80%;
    overflow-y: auto;
    border-radius: 20px;
    background: linear-gradient(145deg, #4e54c8, #8f94fb);
    padding: 20px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
    border: 3px solid rgba(255, 255, 255, 0.2);
    animation: pulseBackground 5s infinite alternate;
}

@keyframes pulseBackground {
    0% {
        background: linear-gradient(145deg, #4e54c8, #8f94fb);
    }
    50% {
        background: linear-gradient(145deg, #e055fd, #8a54f5);
    }
    100% {
        background: linear-gradient(145deg, #4e54c8, #8f94fb);
    }
}

.ranking-table {
    width: 100%;
    border-collapse: collapse;
    margin: 0 auto;
    font-size: 1rem;
    background: #ffffff;
    border-radius: 10px;
    overflow: hidden;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

.ranking-table th {
    background: linear-gradient(135deg, #ff9a9e, #fad0c4);
    color: #000;
    font-weight: bold;
    padding: 20px;
    text-align: center;
    text-transform: uppercase;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    position: relative;
}

.ranking-table th::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0));
    opacity: 0.7;
    pointer-events: none;
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(100%);
    }
}

.ranking-table td {
    padding: 15px;
    text-align: center;
    background: linear-gradient(135deg, #f6f7f8, #e2e2e2);
    color: #333;
    border: none;
    position: relative;
    transition: all 0.5s ease-in-out;
}

.ranking-table tr:hover td {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    color: #ffffff;
    transform: scale(1.05) rotateX(10deg);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    cursor: pointer;
}

.ranking-table tr.top-1 td {
    background: linear-gradient(135deg, #f4d03f, #16a085);
    color: black;
    font-weight: bold;
    animation: rainbowShine 5s infinite alternate;
}

.ranking-table tr.top-2 td {
    background: linear-gradient(135deg, #silver, #d1d8e0);
    color: black;
    font-weight: bold;
    animation: rainbowShine 5s infinite alternate;
}

.ranking-table tr.top-3 td {
    background: linear-gradient(135deg, #cd7f32, #8b4513);
    color: black;
    font-weight: bold;
    animation: rainbowShine 5s infinite alternate;
}

@keyframes rainbowShine {
    0% {
        filter: brightness(1);
    }
    50% {
        filter: brightness(1.5);
    }
    100% {
        filter: brightness(1);
    }
}

@media (max-width: 768px) {
    .ranking-table {
        font-size: 0.8rem;
    }

    .ranking-table th, .ranking-table td {
        padding: 10px;
    }
}


/* Enhanced Top 3 Styling */
.ranking-table tr.top-1 td {
    background: linear-gradient(145deg, #FFD700, #FFA500);
    color: white;
    font-weight: bold;
    animation: glowGold 3s infinite alternate;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
}

.ranking-table tr.top-2 td {
    background: linear-gradient(145deg, #C0C0C0, #A9A9A9);
    color: white;
    font-weight: bold;
    animation: glowSilver 3s infinite alternate;
    box-shadow: 0 4px 15px rgba(192, 192, 192, 0.5);
}

.ranking-table tr.top-3 td {
    background: linear-gradient(145deg, #CD7F32, #8B4513);
    color: white;
    font-weight: bold;
    animation: glowBronze 3s infinite alternate;
    box-shadow: 0 4px 15px rgba(205, 127, 50, 0.5);
}

@keyframes glowGold {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.5) hue-rotate(10deg); }
    100% { filter: brightness(1); }
}

@keyframes glowSilver {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.5) hue-rotate(10deg); }
    100% { filter: brightness(1); }
}

@keyframes glowBronze {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.5) hue-rotate(10deg); }
    100% { filter: brightness(1); }
}


/* Removing Glow from Top 3 */
.ranking-table tr.top-1 td,
.ranking-table tr.top-2 td,
.ranking-table tr.top-3 td {
    animation: none;
}

/* Removing Shimmer Effect from Header */
.ranking-table th::after {
    animation: none;
    background: none;
}

</style>
</head>
<body>
    <!-- Oyundakiler Modal -->
    <div class="players-overlay" id="playersOverlay">
        <div class="players-content">
            <div class="players-header">
                <h3>Oyundakiler</h3>
                <button class="players-close" id="playersCloseButton">âœ–</button>
            </div>
            <ul class="players-list" id="playersList"></ul>
        </div>
    </div>

    <!-- Ã–ÄŸrenci SeÃ§imi EkranÄ± -->
    <div class="container student-selection-container" id="student-selection-screen">
        <h2>Ã–ÄŸrenci SeÃ§imi</h2>
        <div class="table-section">
            <h3>Ã–ÄŸrenci SeÃ§me</h3>
            <label for="selection-class-select">SÄ±nÄ±fÄ± SeÃ§:</label>
            <select id="selection-class-select">
                <option value="">SeÃ§iniz</option>
            </select>

            <label for="selection-name-select">Ã–ÄŸrenciyi SeÃ§:</label>
            <select id="selection-name-select">
                <option value="">SeÃ§iniz</option>
            </select>

            <label for="student-password-input">Åžifre Giriniz:</label>
            <input type="password" id="student-password-input" placeholder="Åžifre" disabled>
        </div>
        <button class="login-button" id="login-button" disabled>GiriÅŸ</button>
        
            </button>
        <div class="error" id="student-selection-error"></div>
    </div>

    <!-- Ana Ekran -->
    <div class="container" id="main-screen" style="display: none;">
        <div class="student-info">
            <img src="" alt="Ã–ÄŸrenci FotoÄŸrafÄ±" class="student-photo" id="student-photo" style="display: none;">
            <div class="student-name" id="student-name"></div>
<div class="student-cup">
    <div class="trophy-container">
        <div class="trophy-inner">
            <img src="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExMnk0M3A2MWR2aTJxenhoMjJ2dmRybXFzNjRlam9oNGlpM3p2eW0zayZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/wX7I4l8SfFyG8rqhsd/giphy.webp" alt="Game Cup" class="game-cup-image">
            <span class="game-cup-score" id="game-cup-score">0</span>
        </div>
    </div>
</div>
<div class="student-diamond">
    <span class="diamond-count">ðŸ’Ž = <span id="diamond-value">0</span></span>
</div>
        </div>
        <div class="buttons">
            <button class="single-player">Tek KiÅŸilik Oyun</button>
	    <button class="friends-button" id="friends-button">
               ðŸ‘¥ ArkadaÅŸlar
            </button>
            <!-- Yeni Eklenen "Kupa SÄ±ralamasÄ±" Butonu -->
            <button class="kupa-siralama-button" id="kupa-siralama-button">
                ðŸ† Kupa SÄ±ralamasÄ±
            </button>
	    <button class="logout-button" id="logout-button">Ã‡Ä±kÄ±ÅŸ Yap</button>

        </div>
    </div>

<!-- ArkadaÅŸlar EkranÄ± -->
<div class="friends-container" id="friends-screen" style="display: none;">
    <h2>ArkadaÅŸlar</h2>
    
    <!-- Arama BÃ¶lÃ¼mÃ¼ -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" id="friend-search" placeholder="ArkadaÅŸ Ara...">
            <button id="search-button">ðŸ” Ara</button>
        </div>
        <div class="search-results" id="search-results">
            <!-- Arama sonuÃ§larÄ± buraya gelecek -->
        </div>
    </div>

    <!-- ArkadaÅŸ Listesi -->
    <div class="friends-list-section">
        <h3>ArkadaÅŸ Listem</h3>
        <ul class="players-list" id="friends-list">
            <!-- ArkadaÅŸ listesi buraya gelecek -->
        </ul>
    </div>

    <button class="back-button">Geri DÃ¶n</button>
</div>


    <!-- Ranking Panel (Yan Panel - Yeni Eklendi) -->
    <div class="ranking-panel" id="rankingPanel" style="display: none;">
        <h2>Kupa SÄ±ralamasÄ±</h2>
        <div class="ranking-table-container">
            <table class="ranking-table" id="ranking-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>FotoÄŸraf</th>
                        <th>Ä°sim</th>
                        <th>SÄ±nÄ±f</th>
                        <th>Kupa Skoru</th>
                    </tr>
                </thead>
                <tbody id="ranking-table-body">
                    <!-- SÄ±ralama verileri buraya eklenecek -->
                </tbody>
            </table>
        </div>
        <button class="ranking-back-button" id="rankingBackButton">Geri DÃ¶n</button>
    </div>

    <!-- Tek KiÅŸilik Oyun EkranÄ± -->
    <div class="game-container" id="single-player-screen">
        <h2>Tek KiÅŸilik Oyun</h2>
        <div class="table-section">
            <h3>Konu Belirleme</h3>
            <label for="class-select">SÄ±nÄ±f SeÃ§:</label>
            <select id="class-select">
                <option value="">SeÃ§iniz</option>
            </select>

            <label for="subject-select">Ders SeÃ§:</label>
            <select id="subject-select">
                <option value="">SeÃ§iniz</option>
            </select>

            <label for="topic-select">Konu SeÃ§:</label>
            <select id="topic-select">
                <option value="">SeÃ§iniz</option>
            </select>
        </div>
        <button class="start-game-button" id="start-game-button" disabled>Oyuna BaÅŸla</button>
        <button class="back-button">Geri DÃ¶n</button>
    </div>

    <!-- Tek KiÅŸilik Oyun Sorular EkranÄ± -->
    <div class="single-player-game-container" id="single-player-game-screen">
        <div class="progress-container">
            <div class="question-number" id="question-number">Soru 1/10</div>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progress-bar-inner"></div>
            </div>
        </div>
        <div class="timer-container">
            <div class="timer" id="timer">45</div>
        </div>
        <div class="question-container">
            <img src="" alt="Soru Resmi" class="question-image" id="question-image" style="display: none;">
            <div class="question-text" id="question-text">Soru metni burada olacak.</div>
        </div>
        <div class="options-container" id="options-container"></div>
        <div class="score-container" id="score-container">
            <span id="score"></span>
            <div class="score-message" id="score-message"></div>
            <img id="score-image" class="final-image" style="display:none;" alt="SonuÃ§ Resmi">
            <!-- "Geri DÃ¶n" butonu -->
            <button class="end-game-button" id="final-back-button">Geri DÃ¶n</button>
        </div>
    </div>

    <!-- DÃ¼ello SeÃ§im EkranÄ± -->
    <div class="duel-selection-container" id="duel-selection-screen">
        <h2>Ortak SeÃ§im EkranÄ±</h2>
        <div class="table-section">
            <h3>Konu Belirleme</h3>
            <label for="duel-class-select">SÄ±nÄ±f SeÃ§:</label>
            <select id="duel-class-select">
                <option value="">SeÃ§iniz</option>
            </select>

            <label for="duel-subject-select">Ders SeÃ§:</label>
            <select id="duel-subject-select">
                <option value="">SeÃ§iniz</option>
            </select>

            <label for="duel-topic-select">Konu SeÃ§:</label>
            <select id="duel-topic-select">
                <option value="">SeÃ§iniz</option>
            </select>
        </div>
        <div class="duel-controls">
            <button class="duel-start-button" id="duel-start-button" disabled>DÃ¼elloya BaÅŸla</button>
        </div>

        <div class="duel-bottom-info">
            <div class="duel-player-info" id="duel-inviter-info">
                <img src="" class="duel-player-photo" id="duel-inviter-photo">
                <div class="duel-player-name" id="duel-inviter-name"></div>
            </div>
            <div class="duel-player-info" id="duel-invited-info">
                <img src="" class="duel-player-photo" id="duel-invited-photo">
                <div class="duel-player-name" id="duel-invited-name"></div>
            </div>
        </div>
    </div>

    <!-- DÃ¼ello Oyun EkranÄ± -->
    <div class="duel-game-container" id="duel-game-screen">
        <div class="progress-container">
            <div class="question-number" id="duel-question-number">Soru 1/10</div>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="duel-progress-bar-inner"></div>
            </div>
        </div>
        <div class="timer-container">
            <div class="timer" id="duel-timer">45</div>
        </div>
        <div class="question-container">
            <img src="" alt="Soru Resmi" class="question-image" id="duel-question-image" style="display: none;">
            <div class="question-text" id="duel-question-text">Soru metni burada olacak.</div>
        </div>
        <div class="options-container" id="duel-options-container"></div>

        <div class="players-info-row">
            <div class="duel-player-score" id="duel-player-inviter-score">
                <img id="duel-player-inviter-photo" src="">
                <div class="duel-player-name" id="duel-player-inviter-name"></div>
                <div class="duel-player-correct-count" id="inviter-correct-count">0</div>
            </div>
            <div class="duel-player-score" id="duel-player-invited-score">
                <img id="duel-player-invited-photo" src="">
                <div class="duel-player-name" id="duel-player-invited-name"></div>
                <div class="duel-player-correct-count" id="invited-correct-count">0</div>
            </div>
        </div>

        <div class="score-container" id="duel-final-container">
            <div class="winner-message" id="winner-message"></div>
            <button class="end-game-button" id="duel-final-back-button">Oyunu SonlandÄ±r</button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-content">
            <div class="alert-message" id="alertMessage"></div>
            <button class="alert-ok-button" id="alertOkButton">Tamam</button>
        </div>
    </div>

    <!-- Prompt Modal -->
    <div class="prompt-overlay" id="promptOverlay">
        <div class="prompt-content">
            <div class="prompt-message" id="promptMessage"></div>
            <input type="text" class="prompt-input" id="promptInput">
            <div class="prompt-buttons">
                <button class="prompt-cancel-button" id="promptCancelButton">Ä°ptal</button>
                <button class="prompt-ok-button" id="promptOkButton">Tamam</button>
            </div>
        </div>
    </div>

    <!-- Davet ModalÄ± -->
    <div class="invitation-overlay" id="invitationOverlay">
        <div class="invitation-content">
            <div class="invitation-message" id="invitationMessage"></div>
            <div class="invitation-buttons">
                <button class="invitation-decline-button" id="invitationDeclineButton">Reddet</button>
                <button class="invitation-accept-button" id="invitationAcceptButton">Kabul Et</button>
            </div>
        </div>
    </div>

    <!-- Arka Plan MÃ¼ziÄŸi iÃ§in Audio Elementi -->
    <audio id="duelBackgroundMusic" src="https://github.com/d4rkd4y76/OYUN-MZK/raw/refs/heads/main/dllo%20mz.mp3" preload="auto"></audio>
    <!-- Kazanan EkranÄ± iÃ§in Yeni Audio Elementi -->
    <audio id="winnerMusic" src="https://github.com/d4rkd4y76/OYUN-MZK/raw/refs/heads/main/win%20mz.mp3" preload="auto"></audio>
    <!-- Tek KiÅŸilik Oyun MÃ¼ziÄŸi iÃ§in Yeni Audio Elementi -->
    <audio id="singlePlayerQuestionMusic" src="https://github.com/d4rkd4y76/OYUN-MZK/raw/refs/heads/main/oyun%20tek%20mz.mp3" preload="auto"></audio>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        // JavaScript KodlarÄ±

        // Audio Elementlerini SeÃ§me
        const duelMusic = document.getElementById('duelBackgroundMusic');
        const winnerMusic = document.getElementById('winnerMusic');
        const singlePlayerQuestionMusic = document.getElementById('singlePlayerQuestionMusic');

        // "Oyunu SonlandÄ±r" butonuna eklenen event listener
document.getElementById('duel-final-back-button').addEventListener('click', async () => {
    await showAlert('ðŸ† Kupa verileriniz gÃ¼ncellendi.');
    if (currentDuelRef) {
        try {
            await currentDuelRef.remove();
            currentDuelRef = null;
            isInviter = false;
            duelGameStarted = false;
            window.location.reload();
        } catch (error) {
            console.error("DÃ¼ello referansÄ± kaldÄ±rÄ±lÄ±rken hata:", error);
            await showAlert('DÃ¼ello referansÄ± kaldÄ±rÄ±lÄ±rken hata oluÅŸtu.');
        }
    } else {
        window.location.reload();
    }
});


        window.addEventListener('beforeunload', () => {
            if (selectedStudent && selectedStudent.studentId) {
                database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).set(false)
                .then(() => console.log("inDuel set to false"))
                .catch(err => console.error("Failed to update inDuel status:", err));

                // EÄŸer bir dÃ¼ello referansÄ± varsa, dÃ¼elloyu kaldÄ±r ve diÄŸer oyuncunun inDuel durumunu false yap
                if (currentDuelRef) {
                    currentDuelRef.once('value').then(async (snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            const inviterRef = database.ref(`classes/${data.inviter.classId}/students/${data.inviter.studentId}/inDuel`);
                            const invitedRef = database.ref(`classes/${data.invited.classId}/students/${data.invited.studentId}/inDuel`);
                            try {
                                await inviterRef.set(false);
                                await invitedRef.set(false);
                                await currentDuelRef.remove();
                            } catch (error) {
                                console.error("DÃ¼ello referansÄ± kaldÄ±rÄ±lÄ±rken hata:", error);
                            }
                        }
                    });
                }
            }
        });

        // LÃ¼tfen kendi firebaseConfig deÄŸerlerinizi girin
        const firebaseConfig = {
  apiKey: "AIzaSyAV8LLng3Cx6-116U6WcEFVn7XqOq2l3Sc",
  authDomain: "duellomatik.firebaseapp.com",
  databaseURL: "https://duellomatik-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "duellomatik",
  storageBucket: "duellomatik.firebasestorage.app",
  messagingSenderId: "274662566652",
  appId: "1:274662566652:web:c097e7052aba00a6b04579",
  measurementId: "G-4HXFJJ0WLR"
};
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // DiÄŸer deÄŸiÅŸkenler
        let classNameMap = {};
        let duelEnded = false; // Eklendi

        const playersOverlay = document.getElementById('playersOverlay');
        const playersCloseButton = document.getElementById('playersCloseButton');
        const playersList = document.getElementById('playersList');
        const invitationOverlay = document.getElementById('invitationOverlay');
        const invitationMessage = document.getElementById('invitationMessage');

        playersCloseButton.addEventListener('click', () => {
            playersOverlay.style.display = 'none';
        });

        let loggedinPlayerRef = null;
        let selectedStudent = {
            classId: '',
            studentId: '',
            studentName: ''
        };

        const studentPhoto = document.getElementById('student-photo');
        const studentName = document.getElementById('student-name');

        async function addLoggedInPlayer(student) {
            const newRef = database.ref('loggedinPlayers').push();
            await newRef.set({
                name: student.studentName,
                photo: (studentPhoto.src && studentPhoto.src !== "") ? studentPhoto.src : "",
                classId: student.classId,
                studentId: student.studentId
            });
            newRef.onDisconnect().remove();
            loggedinPlayerRef = newRef;
        }

 async function showLoggedInPlayers() {
    playersList.innerHTML = '';
    const snapshot = await database.ref('loggedinPlayers').once('value');
    let playersArr = [];

    if (snapshot.exists()) {
        snapshot.forEach(child => {
            const player = child.val();
            playersArr.push({ ...player, key: child.key });
        });

        // SÄ±nÄ±f adÄ±na gÃ¶re sÄ±rala (aynÄ± sÄ±nÄ±ftakiler Ã¶nce)
        const sameClassPlayers = playersArr.filter(p => p.classId === selectedStudent.classId && p.studentId !== selectedStudent.studentId);
        const otherClassPlayers = playersArr.filter(p => p.classId !== selectedStudent.classId);
        playersArr = [...sameClassPlayers, ...otherClassPlayers];

        for (const player of playersArr) {
            let photoURL = "https://via.placeholder.com/50";
            try {
                const photoSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/photo`).once('value');
                if (photoSnapshot.exists()) {
                    photoURL = photoSnapshot.val();
                }
            } catch (e) {
                console.error('FotoÄŸraf alÄ±namadÄ±:', e);
            }

            // "inDuel" durumu
            let inDuel = false;
            try {
                const inDuelSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/inDuel`).once('value');
                if (inDuelSnapshot.exists()) {
                    inDuel = inDuelSnapshot.val();
                }
            } catch (e) {
                console.error('inDuel durumu alÄ±namadÄ±:', e);
            }

            const playerData = {
                name: player.name,
                classId: player.classId,
                className: classNameMap[player.classId] ? classNameMap[player.classId] : player.classId,
                photo: photoURL,
                inDuel: inDuel,
                studentId: player.studentId
            };

            const li = createFriendCard(playerData);
            playersList.appendChild(li);
        }
    } else {
        const li = document.createElement('li');
        li.textContent = "Åžu an oyunda kimse yok.";
        playersList.appendChild(li);
    }
    playersOverlay.style.display = 'flex';
}


        const studentSelectionScreen = document.getElementById('student-selection-screen');
        const mainScreen = document.getElementById('main-screen');
        const singlePlayerScreen = document.getElementById('single-player-screen');
        const singlePlayerGameScreen = document.getElementById('single-player-game-screen');
        const duelSelectionScreen = document.getElementById('duel-selection-screen');
        const duelGameScreen = document.getElementById('duel-game-screen');
        const rankingPanel = document.getElementById('rankingPanel'); // Ranking Panel ID

        const loginButton = document.getElementById('login-button');
        const singlePlayerButton = document.querySelector('.single-player');
        const backButtons = document.querySelectorAll('.back-button');
        const startGameButton = document.getElementById('start-game-button');
        const finalBackButton = document.getElementById('final-back-button');

        const selectionClassSelect = document.getElementById('selection-class-select');
        const selectionNameSelect = document.getElementById('selection-name-select');

        const classSelect = document.getElementById('class-select');
        const subjectSelect = document.getElementById('subject-select');
        const topicSelect = document.getElementById('topic-select');

        const studentPasswordInput = document.getElementById('student-password-input');
        const studentSelectionError = document.getElementById('student-selection-error');

        let gameQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        const questionNumber = document.getElementById('question-number');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const questionImage = document.getElementById('question-image');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const scoreContainer = document.getElementById('score-container');
        const scoreDisplay = document.getElementById('score');
        const scoreMessage = document.getElementById('score-message');
        const scoreImage = document.getElementById('score-image');
        const timerElement = document.getElementById('timer');

        const duelClassSelect = document.getElementById('duel-class-select');
        const duelSubjectSelect = document.getElementById('duel-subject-select');
        const duelTopicSelect = document.getElementById('duel-topic-select');
        const duelStartButton = document.getElementById('duel-start-button');

        const duelInviterPhoto = document.getElementById('duel-inviter-photo');
        const duelInviterName = document.getElementById('duel-inviter-name');
        const duelInvitedPhoto = document.getElementById('duel-invited-photo');
        const duelInvitedName = document.getElementById('duel-invited-name');

        const duelQuestionNumber = document.getElementById('duel-question-number');
        const duelProgressBarInner = document.getElementById('duel-progress-bar-inner');
        const duelTimerElement = document.getElementById('duel-timer');
        const duelQuestionImage = document.getElementById('duel-question-image');
        const duelQuestionText = document.getElementById('duel-question-text');
        const duelOptionsContainer = document.getElementById('duel-options-container');

        const inviterCorrectCountEl = document.getElementById('inviter-correct-count');
        const invitedCorrectCountEl = document.getElementById('invited-correct-count');

        const duelFinalContainer = document.getElementById('duel-final-container');
        const winnerMessage = document.getElementById('winner-message');

        // Ranking Panel Elements
        const kupaSiralamaButton = document.getElementById('kupa-siralama-button');
        const rankingTableBody = document.getElementById('ranking-table-body');
        const rankingBackButton = document.getElementById('rankingBackButton');

        let timer;
        let timeLeft = 45;

        let duelTimer;
        let duelTimeLeft = 45;

        let currentDuelRef = null;
        let isInviter = false;
        let currentInvitation = null;

        let duelQuestions = [];
        let duelCurrentQuestionIndex = 0;
        let duelInviterScore = 0;
        let duelInvitedScore = 0;
        let duelClassId = "";
        let duelSubjectId = "";
        let duelTopicId = "";
        let duelQuestionLocked = false;
        let duelGameStarted = false;

window.onload = () => {
    const storedStudent = localStorage.getItem('selectedStudent');
    if (storedStudent) {
        selectedStudent = JSON.parse(storedStudent);
        mainScreen.style.display = 'flex';
        studentSelectionScreen.style.display = 'none';
        studentSelectionError.textContent = '';
        studentPasswordInput.value = '';

        database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/photo`).once('value').then(photoSnapshot => {
            if (photoSnapshot.exists()) {
                const photoURL = photoSnapshot.val();
                studentPhoto.src = photoURL;
                studentPhoto.style.display = 'block';
            } else {
                studentPhoto.style.display = 'none';
            }
        }).catch(error => {
            console.error("FotoÄŸraf Ã§ekilirken hata:", error);
            studentPhoto.style.display = 'none';
        });

        studentName.textContent = selectedStudent.studentName;
        addLoggedInPlayer(selectedStudent);
        startInvitationListener(selectedStudent.studentId);
        fetchAndDisplayGameCup();
        onMainScreenLoad(); // Elmas sistemini baÅŸlat
    } else {
        studentSelectionScreen.style.display = 'flex';
    }
    fetchClassesForSelection();
    fetchChampionData();
};


        async function fetchAllClasses() {
            const snapshot = await database.ref('classes').once('value');
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const classId = childSnapshot.key;
                    const className = childSnapshot.val().name;
                    classNameMap[classId] = className;
                });
            }
        }
        fetchAllClasses();

        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("KullanÄ±cÄ± oturum aÃ§tÄ±:", user);
            } else {
                console.log("KullanÄ±cÄ± oturum aÃ§madÄ±.");
            }
        });

loginButton.addEventListener('click', async () => {
    selectedStudent.classId = selectionClassSelect.value;
    selectedStudent.studentId = selectionNameSelect.value;
    selectedStudent.studentName = selectionNameSelect.options[selectionNameSelect.selectedIndex].text;
    const enteredPassword = studentPasswordInput.value.trim();

    if (selectedStudent.classId && selectedStudent.studentId) {
        if (enteredPassword === "") {
            studentSelectionError.textContent = 'LÃ¼tfen ÅŸifrenizi giriniz.';
            return;
        }

        database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/password`).once('value').then(async snapshot => {
            if (snapshot.exists()) {
                const correctPassword = snapshot.val();
                if (enteredPassword === correctPassword) {
                    studentSelectionScreen.style.display = 'none';
                    mainScreen.style.display = 'flex';
                    studentSelectionError.textContent = '';
                    studentPasswordInput.value = '';

                    database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/photo`).once('value').then(photoSnapshot => {
                        if (photoSnapshot.exists()) {
                            const photoURL = photoSnapshot.val();
                            studentPhoto.src = photoURL;
                            studentPhoto.style.display = 'block';
                        } else {
                            studentPhoto.style.display = 'none';
                        }
                    }).catch(error => {
                        console.error("FotoÄŸraf Ã§ekilirken hata:", error);
                        studentPhoto.style.display = 'none';
                    });

                    studentName.textContent = selectedStudent.studentName;
                    await addLoggedInPlayer(selectedStudent);
                    startInvitationListener(selectedStudent.studentId);
                    fetchAndDisplayGameCup();
                    onMainScreenLoad(); // Elmas sistemini baÅŸlat

                    localStorage.setItem('selectedStudent', JSON.stringify(selectedStudent));
                } else {
                    studentSelectionError.textContent = 'YanlÄ±ÅŸ ÅŸifre. LÃ¼tfen tekrar deneyiniz.';
                }
            } else {
                studentSelectionError.textContent = 'Bu Ã¶ÄŸrenci iÃ§in ÅŸifre tanÄ±mlanmamÄ±ÅŸ.';
            }
        }).catch(error => {
            console.error("Åžifre kontrol hata:", error);
            studentSelectionError.textContent = 'Åžifre kontrol edilirken hata oluÅŸtu.';
        });
    }
});


const studentsRef = database.ref('classes/2-D/students');
studentsRef.once('value').then(snapshot => {
  if (snapshot.exists()) {
    snapshot.forEach(childSnapshot => {
      const studentRef = childSnapshot.ref;
      studentRef.child('diamond').set(0);
      studentRef.child('lastDiamondUpdate').set(firebase.database.ServerValue.TIMESTAMP);
    });
  }
});

// Elmas sayÄ±sÄ±nÄ± gÃ¼ncelleme fonksiyonu
async function updateDiamondCount() {
    if (!selectedStudent?.studentId) return;
    
    const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
    const snapshot = await studentRef.once('value');
    const userData = snapshot.val();
    
    const currentTime = Date.now();
    const lastUpdate = userData.lastDiamondUpdate || currentTime;
    const hoursPassed = Math.floor((currentTime - lastUpdate) / (1000 * 60 * 60));
    
    if (hoursPassed > 0) {
        let newDiamonds = (userData.diamond || 0) + hoursPassed;
        if (newDiamonds > 30) newDiamonds = 30;
        
        await studentRef.update({
            diamond: newDiamonds,
            lastDiamondUpdate: currentTime
        });
        
        document.getElementById('diamond-value').textContent = newDiamonds;
    } else {
        document.getElementById('diamond-value').textContent = userData.diamond || 0;
    }
}

// Ana ekrana gelindiÄŸinde elmas sayÄ±sÄ±nÄ± gÃ¼ncelle
function onMainScreenLoad() {
    updateDiamondCount();
    // Her saat baÅŸÄ± kontrol et
    setInterval(updateDiamondCount, 1000 * 60 * 60);
}

// Ana deÄŸiÅŸkenler
const friendsButton = document.querySelector('.friends-button');
const friendsScreen = document.getElementById('friends-screen');
const friendSearchInput = document.getElementById('friend-search');
const searchButton = document.getElementById('search-button');
const searchResults = document.getElementById('search-results');
const friendsList = document.getElementById('friends-list');

// ArkadaÅŸlar butonuna tÄ±klama olayÄ±
friendsButton.addEventListener('click', () => {
    mainScreen.style.display = 'none';
    friendsScreen.style.display = 'flex';
    loadFriendsList(); // ArkadaÅŸ listesini yÃ¼kle
});

// Geri dÃ¶n butonu iÃ§in olay dinleyici
friendsScreen.querySelector('.back-button').addEventListener('click', () => {
    friendsScreen.style.display = 'none';
    mainScreen.style.display = 'flex';
});

// ArkadaÅŸ arama iÅŸlevi
searchButton.addEventListener('click', searchFriends);
friendSearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchFriends();
    }
});

async function searchFriends() {
    const searchTerm = friendSearchInput.value.toLowerCase().trim();
    if (!searchTerm) return;
    
    searchResults.innerHTML = '<div class="loading">AranÄ±yor...</div>';
    
    try {
        const snapshot = await database.ref('classes').once('value');
        const results = [];
        
        snapshot.forEach(classSnapshot => {
            const className = classSnapshot.val().name;
            const students = classSnapshot.child('students').val();
            
            if (students) {
                Object.entries(students).forEach(([studentId, studentData]) => {
                    if (studentData.name?.toLowerCase().includes(searchTerm) && 
                        studentId !== selectedStudent.studentId) {
                        results.push({
                            studentId,
                            classId: classSnapshot.key,
                            className,
                            ...studentData
                        });
                    }
                });
            }
        });
        
        displaySearchResults(results);
    } catch (error) {
        searchResults.innerHTML = '<div class="error">Arama hatasÄ± oluÅŸtu</div>';
    }
}

async function displaySearchResults(results) {
    searchResults.innerHTML = '';
    if (!results.length) {
        searchResults.innerHTML = '<div class="no-results">SonuÃ§ bulunamadÄ±</div>';
        return;
    }

    for (const student of results) {
        const friendshipRef = database.ref(`friendships/${selectedStudent.studentId}/${student.studentId}`);
        const isFriend = (await friendshipRef.once('value')).exists();
        
        const inDuelRef = database.ref(`classes/${student.classId}/students/${student.studentId}/inDuel`);
        const inDuel = (await inDuelRef.once('value')).val();

        const li = document.createElement('li');
        li.className = 'player-item';

        const photo = student.photo || 'https://via.placeholder.com/50';
        const className = classNameMap[student.classId] || student.classId;

        li.innerHTML = `
            <img src="${photo}" alt="${student.name}" class="player-photo">
            <span class="player-name">${student.name} / (${className})</span>
            ${inDuel ? 
                '<button class="oyunda-button" disabled>Oyunda</button>' :
                isFriend ? 
                    '<button class="davet-et-button">Davet Et</button>' : 
                    '<button class="add-friend-button">+ ArkadaÅŸ Ekle</button>'
            }
        `;

        const button = li.querySelector('button');
        if (!inDuel) {
            if (isFriend) {
                button.onclick = () => sendInvitation({...student, classId: student.classId});
            } else {
                button.onclick = () => addFriend({
                    id: student.studentId,
                    name: student.name,
                    classId: student.classId,
                    className,
                    photo: student.photo
                });
            }
        }

        searchResults.appendChild(li);
    }
}

async function addFriend(student) {
    try {
        const currentFriendsRef = database.ref(`friendships/${selectedStudent.studentId}`);
        const snapshot = await currentFriendsRef.once('value');
        if (snapshot.numChildren() >= 10) {
            showAlert('En fazla 10 arkadaÅŸ ekleyebilirsiniz!');
            return;
        }

        const friendshipData = {
            friendId: student.id,
            friendName: student.name,
            friendClassId: student.classId,
            friendClassName: student.className,
            friendPhoto: student.photo || null,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        await Promise.all([
            database.ref(`friendships/${selectedStudent.studentId}/${student.id}`).set(friendshipData),
            database.ref(`friendships/${student.id}/${selectedStudent.studentId}`).set({
                friendId: selectedStudent.studentId,
                friendName: selectedStudent.studentName,
                friendClassId: selectedStudent.classId,
                friendClassName: classNameMap[selectedStudent.classId],
                friendPhoto: studentPhoto.src || null,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            })
        ]);

        showAlert('ArkadaÅŸ baÅŸarÄ±yla eklendi!');
        loadFriendsList();
        searchFriends();
    } catch (error) {
        showAlert('ArkadaÅŸ eklenirken hata oluÅŸtu');
    }
}

async function checkIfFriend(friendId) {
    const snapshot = await database.ref(`friendships/${selectedStudent.studentId}/${friendId}`).once('value');
    return snapshot.exists();
}

async function addFriend(student) {
    try {
        // Ã–nce mevcut arkadaÅŸ sayÄ±sÄ±nÄ± kontrol et
        const currentFriendsRef = database.ref(`friendships/${selectedStudent.studentId}`);
        const snapshot = await currentFriendsRef.once('value');
        const currentFriendsCount = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;

        if (currentFriendsCount >= 10) {
            showAlert('En fazla 10 arkadaÅŸ ekleyebilirsiniz!');
            return;
        }

        // ArkadaÅŸ zaten ekli mi kontrol et
        const existingFriendRef = database.ref(`friendships/${selectedStudent.studentId}/${student.id}`);
        const existingFriend = await existingFriendRef.once('value');
        
        if (existingFriend.exists()) {
            showAlert('Bu kiÅŸi zaten arkadaÅŸ listenizde!');
            return;
        }

        const friendshipRef = database.ref(`friendships/${selectedStudent.studentId}/${student.id}`);
        await friendshipRef.set({
            friendId: student.id,
            friendName: student.name,
            friendClassId: student.classId,
            friendClassName: classNameMap[student.classId] || student.classId,
            friendPhoto: student.photo || null,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        showAlert('ArkadaÅŸ baÅŸarÄ±yla eklendi!');
        loadFriendsList(); // Listeyi yenile

    } catch (error) {
        console.error('ArkadaÅŸ ekleme hatasÄ±:', error);
        showAlert('ArkadaÅŸ eklenirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
    }
}

async function loadFriendsList() {
    try {
        friendsList.innerHTML = '<div class="loading">YÃ¼kleniyor...</div>';

        const friendshipsRef = database.ref(`friendships/${selectedStudent.studentId}`);
        const snapshot = await friendshipsRef.once('value');

        if (!snapshot.exists()) {
            friendsList.innerHTML = '<div class="no-friends">HenÃ¼z arkadaÅŸÄ±nÄ±z yok</div>';
            return;
        }

        friendsList.innerHTML = '';
        const friends = [];

        snapshot.forEach(childSnapshot => {
            const friendData = childSnapshot.val();
            friends.push({
                studentId: friendData.friendId,
                name: friendData.friendName,
                classId: friendData.friendClassId,
                className: friendData.friendClassName,
                photo: friendData.friendPhoto,
                inDuel: false,
                isOnline: false
            });
        });

        for (const friend of friends) {
            // inDuel durumunu kontrol et
            const inDuelRef = database.ref(`classes/${friend.classId}/students/${friend.studentId}/inDuel`);
            const inDuelSnapshot = await inDuelRef.once('value');
            friend.inDuel = inDuelSnapshot.val() || false;

            // Online durumunu kontrol et
            const loggedInRef = database.ref('loggedinPlayers').orderByChild('studentId').equalTo(friend.studentId);
            const loggedInSnapshot = await loggedInRef.once('value');
            friend.isOnline = loggedInSnapshot.exists();

            const li = document.createElement('li');
            li.className = 'player-item';

            let buttonClass = 'davet-et-button';
            let buttonText = 'Davet Et';
            let isDisabled = false;

            if (friend.inDuel) {
                buttonClass = 'oyunda-button';
                buttonText = 'Oyunda';
                isDisabled = true;
            } else if (!friend.isOnline) {
                buttonClass = 'offline-button';
                buttonText = 'Ã‡evrimdÄ±ÅŸÄ±';
                isDisabled = true;
            }

            li.innerHTML = `
                <img src="${friend.photo || 'https://via.placeholder.com/50'}" alt="${friend.name}" class="player-photo">
                <span class="player-name">${friend.name} / (${friend.className})</span>
                <button class="${buttonClass}" ${isDisabled ? 'disabled' : ''}>${buttonText}</button>
            `;

            if (!isDisabled) {
                const davetButton = li.querySelector('.davet-et-button');
                davetButton.onclick = () => sendInvitation(friend);
            }

            friendsList.appendChild(li);
        }

    } catch (error) {
        console.error('ArkadaÅŸ listesi yÃ¼kleme hatasÄ±:', error);
        friendsList.innerHTML = '<div class="error">Liste yÃ¼klenirken bir hata oluÅŸtu</div>';
    }
}

function updateFriendStatus(friendId, statusDiv) {
    database.ref(`loggedinPlayers`).orderByChild('studentId').equalTo(friendId).once('value', snapshot => {
        if (snapshot.exists()) {
            // ArkadaÅŸ online
            database.ref(`classes/${selectedStudent.classId}/students/${friendId}/inDuel`).once('value', duelSnapshot => {
                if (duelSnapshot.exists() && duelSnapshot.val() === true) {
                    statusDiv.textContent = 'Oyunda';
                    statusDiv.className = 'friend-status status-in-game';
                } else {
                    statusDiv.textContent = 'Aktif';
                    statusDiv.className = 'friend-status status-online';
                }
            });
        } else {
            // ArkadaÅŸ offline
            statusDiv.textContent = 'Aktif DeÄŸil';
            statusDiv.className = 'friend-status status-offline';
        }
    });
}

function listenToFriendStatus(friendId, statusDiv, inviteButton) {
    const loggedInRef = database.ref('loggedinPlayers').orderByChild('studentId').equalTo(friendId);
    const inDuelRef = database.ref(`classes/${selectedStudent.classId}/students/${friendId}/inDuel`);

    loggedInRef.on('value', snapshot => {
        const isOnline = snapshot.exists();
        
        if (isOnline) {
            inDuelRef.on('value', duelSnapshot => {
                const isInDuel = duelSnapshot.exists() && duelSnapshot.val() === true;
                
                if (isInDuel) {
                    statusDiv.textContent = 'Oyunda';
                    statusDiv.className = 'friend-status status-in-game';
                    inviteButton.style.display = 'none';
                } else {
                    statusDiv.textContent = 'Aktif';
                    statusDiv.className = 'friend-status status-online';
                    inviteButton.style.display = 'block';
                }
            });
        } else {
            statusDiv.textContent = 'Aktif DeÄŸil';
            statusDiv.className = 'friend-status status-offline';
            inviteButton.style.display = 'none';
        }
    });

    // Temizlik iÅŸlevi
    return () => {
        loggedInRef.off();
        inDuelRef.off();
    };
}

// Sayfa yÃ¼klendiÄŸinde arkadaÅŸ listesini yÃ¼kle
window.addEventListener('load', () => {
    if (selectedStudent && selectedStudent.studentId) {
        loadFriendsList();
    }
});

        backButtons.forEach(backButton => {
            backButton.addEventListener('click', () => {
                const currentScreen = backButton.parentElement;
                if(currentScreen.id === 'duel-selection-screen' && currentDuelRef) {
                    // DÃ¼ello referansÄ±nÄ± kaldÄ±r ve sayfayÄ± yenile
                    currentDuelRef.remove().then(() => {
                        // Her iki oyuncunun inDuel durumunu false yap
                        currentDuelRef.once('value').then(async (snapshot) => {
                            if (snapshot.exists()) {
                                const data = snapshot.val();
                                const inviterRef = database.ref(`classes/${data.inviter.classId}/students/${data.inviter.studentId}/inDuel`);
                                const invitedRef = database.ref(`classes/${data.invited.classId}/students/${data.invited.studentId}/inDuel`);
                                try {
                                    await inviterRef.set(false);
                                    await invitedRef.set(false);
                                } catch (error) {
                                    console.error("inDuel gÃ¼ncellenirken hata:", error);
                                }
                            }
                        });
                        currentDuelRef = null;
                        isInviter = false;
                        duelGameStarted = false;
                        window.location.reload();
                    }).catch(error => {
                        console.error("DÃ¼ello referansÄ± kaldÄ±rÄ±lÄ±rken hata:", error);
                        showAlert('DÃ¼ello referansÄ± kaldÄ±rÄ±lÄ±rken hata oluÅŸtu.');
                    });
                } else {
                    currentScreen.style.display = 'none';
                    mainScreen.style.display = 'flex';
                    resetGameScreens();
                }
            });
        });

        singlePlayerButton.addEventListener('click', () => {
            mainScreen.style.display = 'none';
            singlePlayerScreen.style.display = 'flex';
        });

        startGameButton.addEventListener('click', () => {
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            const selectedTopic = topicSelect.value;

            if (selectedClass && selectedSubject && selectedTopic) {
                fetchQuestions(selectedClass, selectedSubject, selectedTopic);
            } else {
                showAlert('LÃ¼tfen tÃ¼m alanlarÄ± doldurunuz.');
            }
        });


        async function handlePasswordUpdate(classId, studentId) {
            const newPassword = await showPrompt('Yeni ÅŸifreyi giriniz:');
            if (newPassword !== null) {
                if (newPassword.trim() !== "") {
                    database.ref(`classes/${classId}/students/${studentId}/password`).set(newPassword.trim()).then(() => {
                        showAlert('Åžifre oluÅŸturuldu/gÃ¼ncellendi.');
                    }).catch(error => {
                        console.error("Åžifre gÃ¼ncellenirken hata:", error);
                        showAlert('Åžifre gÃ¼ncellerken hata oluÅŸtu.');
                    });
                } else {
                    showAlert('Åžifre boÅŸ olamaz.');
                }
            }
        }

        function fetchStudents(classId, studentNameSelectElement) {
            studentNameSelectElement.innerHTML = '<option value="">SeÃ§iniz</option>';
            if (classId === "") return;

            database.ref(`classes/${classId}/students`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const studentId = childSnapshot.key;
                        const studentName = childSnapshot.val().name;

                        const option = document.createElement('option');
                        option.value = studentId;
                        option.textContent = studentName;
                        studentNameSelectElement.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Bu sÄ±nÄ±fa ait Ã¶ÄŸrenci yok";
                    studentNameSelectElement.appendChild(option);
                }
            }).catch(error => {
                console.error("Ã–ÄŸrenci Ã§ekme hata:", error);
            });
        }

        function fetchChampionData() {
            database.ref('championData/headings').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const classId = childSnapshot.key;
                        const className = childSnapshot.val().name ? childSnapshot.val().name : 'No name';
                        const option = document.createElement('option');
                        option.value = classId;
                        option.textContent = className;
                        classSelect.appendChild(option);
                    });
                } else {
                    console.warn("championData/headings boÅŸ.");
                }
            }).catch(error => {
                console.error("SÄ±nÄ±f bilgileri hata:", error);
            });
        }

        function fetchLessons(classId, subjectSelectElement) {
            subjectSelectElement.innerHTML = '<option value="">SeÃ§iniz</option>';
            if (subjectSelectElement.id === 'duel-subject-select') {
                duelTopicSelect.innerHTML = '<option value="">SeÃ§iniz</option>';
            } else {
                topicSelect.innerHTML = '<option value="">SeÃ§iniz</option>';
            }

            if (classId === "") return;

            database.ref(`championData/headings/${classId}/lessons`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const lessonId = childSnapshot.key;
                        const lessonName = childSnapshot.val().name ? childSnapshot.val().name : 'No name';

                        const option = document.createElement('option');
                        option.value = lessonId;
                        option.textContent = lessonName;
                        subjectSelectElement.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Bu sÄ±nÄ±fa ait ders yok";
                    subjectSelectElement.appendChild(option);
                }
            }).catch(error => {
                console.error("Ders bilgileri hata:", error);
            });
        }

        function fetchTopics(classId, lessonId, topicSelectElement) {
            topicSelectElement.innerHTML = '<option value="">SeÃ§iniz</option>';

            if (lessonId === "") return;

            database.ref(`championData/headings/${classId}/lessons/${lessonId}/topics`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const topicId = childSnapshot.key;
                        const topicName = childSnapshot.val().name ? childSnapshot.val().name : 'No name';

                        const option = document.createElement('option');
                        option.value = topicId;
                        option.textContent = topicName;
                        topicSelectElement.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Bu derse ait konu yok";
                    topicSelectElement.appendChild(option);
                }
            }).catch(error => {
                console.error("Konu bilgileri hata:", error);
            });
        }

        const singlePlayerSelects = singlePlayerScreen.querySelectorAll('select');
        singlePlayerSelects.forEach(select => {
            select.addEventListener('change', checkSinglePlayerSelections);
        });

        function checkSinglePlayerSelections() {
            let allSelected = true;
            singlePlayerSelects.forEach(select => {
                if (select.value === "") {
                    allSelected = false;
                }
            });

            if (allSelected) {
                startGameButton.classList.add('active');
                startGameButton.disabled = false;
            } else {
                startGameButton.classList.remove('active');
                startGameButton.disabled = true;
            }
        }

        selectionClassSelect.addEventListener('change', () => {
            const selectedClass = selectionClassSelect.value;
            if (selectedClass === "") {
                selectionNameSelect.innerHTML = '<option value="">SeÃ§iniz</option>';
                checkLoginButtonState();
                return;
            }
            fetchStudents(selectedClass, selectionNameSelect);
            checkLoginButtonState();
        });

        selectionNameSelect.addEventListener('change', () => {
            checkLoginButtonState();
        });

        function checkLoginButtonState() {
            if (selectionClassSelect.value !== "" && selectionNameSelect.value !== "") {
                loginButton.classList.add('active');
                loginButton.disabled = false;
                studentPasswordInput.disabled = false;
            } else {
                loginButton.classList.remove('active');
                loginButton.disabled = true;
                studentPasswordInput.disabled = true;
                studentPasswordInput.value = '';
            }
        }

        classSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            fetchLessons(selectedClass, subjectSelect);
        });

        subjectSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            const selectedLesson = subjectSelect.value;
            fetchTopics(selectedClass, selectedLesson, topicSelect);
        });

        function resetGameScreens() {
            // Tek KiÅŸilik Oyun EkranÄ±
            singlePlayerSelects.forEach(select => {
                select.value = "";
            });
            startGameButton.classList.remove('active');
            startGameButton.disabled = true;

            scoreContainer.style.display = 'none';
            scoreDisplay.textContent = '';
            scoreMessage.textContent = '';
            scoreMessage.className = 'score-message';
            scoreImage.style.display = 'none';

            // DÃ¼ello Oyun EkranÄ±
            duelQuestionNumber.textContent = 'Soru 1/10';
            duelProgressBarInner.style.width = '0%';
            duelTimerElement.textContent = '45';
            duelTimerElement.style.color = '#ff0000';

            // Yeni eklenen sÄ±fÄ±rlamalar
            gameQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            clearInterval(timer);

            // Tek KiÅŸilik Oyun MÃ¼ziÄŸini Durdur
            singlePlayerQuestionMusic.pause();
            singlePlayerQuestionMusic.currentTime = 0;

            // DÃ¼ello Oyun MÃ¼ziÄŸini Durdur
            duelMusic.pause();
            duelMusic.currentTime = 0;
        }

// "Ã‡Ä±kÄ±ÅŸ Yap" Butonunu SeÃ§me
const logoutButton = document.getElementById('logout-button');

// "Ã‡Ä±kÄ±ÅŸ Yap" Butonuna Event Listener Ekleme
logoutButton.addEventListener('click', async () => {
    try {
        // Ã–nce seÃ§ili Ã¶ÄŸrencinin inDuel durumunu false yap
        if (selectedStudent && selectedStudent.classId && selectedStudent.studentId) {
            await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).set(false);
        }

        // DÃ¼ello referansÄ±nÄ± temizle
        if (currentDuelRef) {
            await currentDuelRef.remove();
            currentDuelRef = null;
        }

        // localStorage'Ä± temizle
        localStorage.removeItem('selectedStudent');

        // Loggedin player'Ä± kaldÄ±r
        if (loggedinPlayerRef) {
            await loggedinPlayerRef.remove();
            console.log("KullanÄ±cÄ± Firebase'den baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±.");
        }

        // SayfayÄ± yenile
        window.location.reload();

    } catch (error) {
        console.error("Ã‡Ä±kÄ±ÅŸ yaparken hata oluÅŸtu:", error);
        showAlert('Ã‡Ä±kÄ±ÅŸ yaparken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
    }
});


        function fetchQuestions(classId, subjectId, topicId) {
            const questionsRef = database.ref(`championData/headings/${classId}/lessons/${subjectId}/topics/${topicId}/questions`);
            questionsRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const allQuestions = [];
                    snapshot.forEach(childSnapshot => {
                        const questionData = childSnapshot.val();
                        allQuestions.push(questionData);
                    });

                    if (allQuestions.length < 10) {
                        showAlert('Bu konuya ait yeterli soru yok.');
                        return;
                    }

                    gameQuestions = shuffleArray(allQuestions).slice(0, 10);
                    currentQuestionIndex = 0;
                    score = 0;

                    singlePlayerScreen.style.display = 'none';
                    singlePlayerGameScreen.style.display = 'flex';
                    scoreContainer.style.display = 'none';
                    displayCurrentQuestion();

                    // Tek KiÅŸilik Oyun MÃ¼ziÄŸini BaÅŸlat
                    singlePlayerQuestionMusic.currentTime = 0;
                    singlePlayerQuestionMusic.play().catch(error => {
                        console.error("Tek KiÅŸilik Oyun MÃ¼ziÄŸi Ã‡alÄ±namadÄ±:", error);
                    });
                } else {
                    showAlert('Bu konuya ait soru bulunamadÄ±.');
                }
            }).catch(error => {
                console.error("Sorular Ã§ekme hata:", error);
                showAlert('Sorular Ã§ekilirken hata oluÅŸtu.');
            });
        }

        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function displayCurrentQuestion() {
            if (currentQuestionIndex >= gameQuestions.length) {
                endGame();
                return;
            }

            const currentQuestion = gameQuestions[currentQuestionIndex];
            questionNumber.textContent = `Soru ${currentQuestionIndex + 1}/10`;
            const progressPercentage = ((currentQuestionIndex) / 10) * 100;
            progressBarInner.style.width = `${progressPercentage}%`;

            if (currentQuestion.question.startsWith('http')) {
                questionImage.src = currentQuestion.question;
                questionImage.style.display = 'block';
                questionText.textContent = '';
            } else {
                questionImage.style.display = 'none';
                questionText.textContent = currentQuestion.question;
            }

            const options = [
                { text: currentQuestion.correct, correct: true },
                { text: currentQuestion.wrong1, correct: false },
                { text: currentQuestion.wrong2, correct: false }
            ];
            const shuffledOptions = shuffleArray(options);

            optionsContainer.innerHTML = '';
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.classList.add('option-button');
                button.textContent = option.text;
                button.dataset.correct = option.correct;
                button.addEventListener('click', selectOption);
                optionsContainer.appendChild(button);
            });

            // GÃ¶rÃ¼nÃ¼rlÃ¼k ayarlarÄ±
            questionNumber.style.display = 'block';
            document.querySelector('.progress-container').style.display = 'block';
            document.querySelector('.timer-container').style.display = 'block';
            document.querySelector('.question-container').style.display = 'flex';
            optionsContainer.style.display = 'flex';

            // Timer'Ä± sÄ±fÄ±rla ve baÅŸlat
            resetTimer();
            startTimer();
        }

        function selectOption(e) {
            const selectedButton = e.target;
            const isCorrect = selectedButton.dataset.correct === 'true';

            document.querySelectorAll('.option-button').forEach(button => {
                button.disabled = true;
                if (button !== selectedButton) {
                    button.classList.add('option-faded');
                } else {
                    button.classList.add('option-chosen');
                }
            });

            if (isCorrect) {
                selectedButton.classList.add('correct');
                score++;
            } else {
                selectedButton.classList.add('wrong');
                document.querySelectorAll('.option-button').forEach(button => {
                    if (button.dataset.correct === 'true') {
                        button.classList.add('correct');
                    }
                });
            }

            clearInterval(timer);

            setTimeout(() => {
                proceedToNextQuestion();
            }, 1000);
        }

        function proceedToNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < 10) {
                displayCurrentQuestion();
            } else {
                endGame();
            }
        }

        function endGame() {
            questionNumber.style.display = 'none';
            document.querySelector('.progress-container').style.display = 'none';
            document.querySelector('.timer-container').style.display = 'none';
            document.querySelector('.question-container').style.display = 'none';
            optionsContainer.style.display = 'none';

            scoreContainer.style.display = 'flex';
            scoreDisplay.textContent = `DoÄŸru SayÄ±sÄ±: ${score}/10`;

            let message = '';
            let messageClass = '';
            let imageUrl = '';
            scoreMessage.style.display = 'block';

            if (score === 10) {
                message = 'ÅžAHANE';
                messageClass = 'purple';
                imageUrl = 'https://i.giphy.com/YX8IKLsJJXagt5rZMV.webp';
            } else if (score >= 8 && score <= 9) {
                message = 'Gayet Ä°yi';
                messageClass = 'green';
                imageUrl = 'https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHAxM2E0cGY1bmJxcXdvbDYxYXBrZjRncXV0dzJwMXZ4bzJ1bWxzNSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/AFmZwgpOXOqWwtcVve/giphy.webp';
            } else if (score >= 6 && score <= 7) {
                message = 'Daha iyisi olabilir.';
                messageClass = 'green';
                imageUrl = 'https://cdn.pixabay.com/photo/2019/10/28/14/35/emoticon-4584554_960_720.png';
            } else if (score >= 3 && score <= 5) {
                message = 'Kendini GeliÅŸtirmen Gerek.';
                messageClass = 'blue';
                imageUrl = 'https://cdn.pixabay.com/photo/2019/10/28/14/35/emoticon-4584554_960_720.png';
            } else {
                message = 'BaÅŸarÄ±sÄ±z SonuÃ§';
                messageClass = 'red';
                imageUrl = 'https://media.tenor.com/rPTWl04F5igAAAAM/byuntear-emoji.gif';
            }

            scoreMessage.textContent = message;
            if (messageClass !== '') {
                scoreMessage.classList.add(messageClass);
            } else {
                scoreMessage.textContent = '';
            }

            scoreImage.src = imageUrl;
            scoreImage.style.display = 'block';

            // MÃ¼zik Ã§alma iÅŸlemi burada
            if (score > 9) { // Ã–rneÄŸin, belirli bir baÅŸarÄ± dÃ¼zeyinde mÃ¼zik Ã§alÄ±nÄ±r
                winnerMusic.currentTime = 0;
                winnerMusic.play().catch(error => {
                    console.error("Kazanan mÃ¼ziÄŸi Ã§alÄ±namadÄ±:", error);
                });
            }
        }

        // "Geri DÃ¶n" butonu iÃ§in event listener
        finalBackButton.addEventListener('click', () => {
            // MÃ¼zikleri durdur
            stopAllMusic();

            // EkranlarÄ± sÄ±fÄ±rla ve ana ekrana dÃ¶n
            singlePlayerGameScreen.style.display = 'none';
            mainScreen.style.display = 'flex';
            resetGameScreens();
        });

        // TÃ¼m mÃ¼zikleri durdurma fonksiyonu
        function stopAllMusic() {
            if (!duelMusic.paused) {
                duelMusic.pause();
                duelMusic.currentTime = 0;
            }
            if (!winnerMusic.paused) {
                winnerMusic.pause();
                winnerMusic.currentTime = 0;
            }
            if (!singlePlayerQuestionMusic.paused) {
                singlePlayerQuestionMusic.pause();
                singlePlayerQuestionMusic.currentTime = 0;
            }
        }

        // Kupa SÄ±ralamasÄ± Butonuna Event Listener (Yan Panel AÃ§ma)
        kupaSiralamaButton.addEventListener('click', () => {
            rankingPanel.classList.add('open');
            loadRanking(); // SÄ±ralamayÄ± yÃ¼kle
        });

        // Ranking Back Button Event Listener (Yan Panel Kapatma)
        rankingBackButton.addEventListener('click', () => {
            rankingPanel.classList.remove('open');
        });

        // Bu event listener, dÃ¼ello oyununun sonunda "Oyunu SonlandÄ±r" butonunu Ã¶zel iÅŸlevle deÄŸiÅŸtirir.
        // "Oyunu SonlandÄ±r" butonunun iÅŸlevi, Ã¶nce uyarÄ±yÄ± gÃ¶sterir, ardÄ±ndan eski iÅŸlevini sÃ¼rdÃ¼rÃ¼r.
        // AyrÄ±ca, kazanan ekranÄ±nda mÃ¼ziÄŸin Ã§almasÄ±nÄ± saÄŸlar.
        // (Bu kÄ±sÄ±m artÄ±k dÃ¼ello bitiÅŸte kazanan ekranÄ±nda mÃ¼zik Ã§aldÄ±ÄŸÄ± iÃ§in kaldÄ±rÄ±ldÄ±)

        function resetTimer() {
            clearInterval(timer);
            timeLeft = 45;
            timerElement.textContent = timeLeft;
            timerElement.style.color = '#ff0000';
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    markQuestionAsWrong();
                    setTimeout(() => {
                        proceedToNextQuestion();
                    }, 1000);
                }
            }, 1000);
        }

        function markQuestionAsWrong() {
            document.querySelectorAll('.option-button').forEach(button => {
                if (button.dataset.correct === 'true') {
                    button.classList.add('correct');
                } else {
                    button.classList.add('wrong');
                }
                button.disabled = true;
            });
        }

        function fetchClassesForSelection() {
            database.ref('classes').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const classId = childSnapshot.key;
                        const className = childSnapshot.val().name ? childSnapshot.val().name : classId; // SÄ±nÄ±f adÄ±nÄ± alÄ±yoruz

                        console.log(`Class ID: ${classId}, Class Name: ${className}`);

                        // SÄ±nÄ±f adÄ± mevcut olduÄŸu iÃ§in doÄŸrudan ekleyebiliriz
                        const option = document.createElement('option');
                        option.value = classId;
                        option.textContent = className;
                        selectionClassSelect.appendChild(option);
                    });
                } else {
                    console.warn("SeÃ§im iÃ§in sÄ±nÄ±f yok.");
                }
            }).catch(error => {
                console.error("SeÃ§im iÃ§in sÄ±nÄ±f Ã§ekme hata:", error);
            });
        }

        // Alert fonksiyonu
        const alertOverlay = document.getElementById('alertOverlay');
        const alertMessage = document.getElementById('alertMessage');
        const alertOkButton = document.getElementById('alertOkButton');

        function showAlert(message) {
            alertMessage.textContent = message; // Sabit mesaj iÃ§in textContent kullanÄ±ldÄ±
            alertOverlay.style.display = 'flex';
            return new Promise(resolve => {
                alertOkButton.onclick = () => {
                    alertOverlay.style.display = 'none';
                    resolve();
                };
            });
        }

        // Prompt fonksiyonu
        const promptOverlay = document.getElementById('promptOverlay');
        const promptMessage = document.getElementById('promptMessage');
        const promptInput = document.getElementById('promptInput');
        const promptCancelButton = document.getElementById('promptCancelButton');
        const promptOkButton = document.getElementById('promptOkButton');

        function showPrompt(message) {
            promptMessage.textContent = message;
            promptInput.value = '';
            promptOverlay.style.display = 'flex';

            return new Promise(resolve => {
                promptOkButton.onclick = () => {
                    const val = promptInput.value;
                    promptOverlay.style.display = 'none';
                    resolve(val);
                };

                promptCancelButton.onclick = () => {
                    promptOverlay.style.display = 'none';
                    resolve(null);
                };
            });
        }

        // Davet Etme ve Dinleme
        async function sendInvitation(player) {
            try {
                const inDuelSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/inDuel`).once('value');
                const isInDuel = inDuelSnapshot.exists() ? inDuelSnapshot.val() : false;

                if (isInDuel) {
                    showAlert(`${player.name} zaten bir dÃ¼elloda!`);
                    return;
                }

                const invitationRef = database.ref(`invitations/${player.studentId}`);
                invitationRef.set({
                    invitedByName: selectedStudent.studentName,
                    invitedByClassId: selectedStudent.classId,
                    invitedByStudentId: selectedStudent.studentId,
                    invitedByPhoto: studentPhoto.src ? studentPhoto.src : ""
                }).then(() => {
                    showAlert(`${player.name} davet edildi!`);
                }).catch(error => {
                    console.error("Davet gÃ¶nderme hatasÄ±:", error);
                    showAlert('Davet gÃ¶nderilirken bir hata oluÅŸtu.');
                });
            } catch (error) {
                console.error("DÃ¼ello kontrolÃ¼ hata:", error);
                showAlert('DÃ¼ello durumu kontrol edilirken hata oluÅŸtu.');
            }
        }

        function startInvitationListener(studentId) {
            // Davetleri dinle
            database.ref(`invitations/${studentId}`).on('value', snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    currentInvitation = { ...data };
                    showInvitationModal(data);
                } else {
                    if (invitationOverlay.style.display === 'flex' && !currentInvitation) {
                        invitationOverlay.style.display = 'none';
                    }
                    currentInvitation = null;
                }
            });

            // DÃ¼ellolarÄ± dinle
            database.ref('duels').orderByChild('inviter/studentId').equalTo(studentId).on('child_added', snapshot => {
                if (currentDuelRef == null) {
                    currentDuelRef = snapshot.ref;
                    isInviter = true;
                    switchToDuelScreen(snapshot.key);
                }
            });

            database.ref('duels').orderByChild('invited/studentId').equalTo(studentId).on('child_added', snapshot => {
                if (currentDuelRef == null) {
                    currentDuelRef = snapshot.ref;
                    isInviter = false;
                    switchToDuelScreen(snapshot.key);
                }
            });

            // DÃ¼ello referansÄ± silindiÄŸinde (Ã¶rneÄŸin, bir oyuncu baÄŸlantÄ±sÄ±nÄ± kestiÄŸinde)
            database.ref('duels').on('child_removed', snapshot => {
                if (currentDuelRef && snapshot.key === currentDuelRef.key && !duelEnded) { // duelEnded kontrolÃ¼ eklendi
                    showAlert('Rakibin baÄŸlantÄ±sÄ± kesildi. Tekrar giriÅŸ yapÄ±nÄ±z.')
                        .then(() => {
                            window.location.reload();
                        });
                }
            });
        }

        function showInvitationModal(data) {
            invitationMessage.textContent = `${data.invitedByName} (${classNameMap[data.invitedByClassId] ? classNameMap[data.invitedByClassId] : data.invitedByClassId}) seni dÃ¼elloya davet ediyor.`;
            invitationOverlay.style.display = 'flex';
        }

        const invitationDeclineButton = document.getElementById('invitationDeclineButton');
        const invitationAcceptButton = document.getElementById('invitationAcceptButton');

        invitationDeclineButton.addEventListener('click', () => {
            if (currentInvitation && selectedStudent.studentId) {
                database.ref(`invitations/${selectedStudent.studentId}`).remove();
                invitationOverlay.style.display = 'none';
                currentInvitation = null;
            }
        });

        invitationAcceptButton.addEventListener('click', async () => {
            if (currentInvitation && selectedStudent.studentId) {
                try {
                    const inDuelSnap = await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).once('value');
                    const isInDuel = inDuelSnap.exists() ? inDuelSnap.val() : false;

                    if (isInDuel) {
                        showAlert(`Zaten bir dÃ¼ellodasÄ±n!`);
                        invitationOverlay.style.display = 'none';
                        currentInvitation = null;
                        return;
                    }

                    // Yeni: "Oyundakiler" ekranÄ±nÄ± kapat
                    playersOverlay.style.display = 'none';

                    invitationOverlay.style.display = 'none';
                    await createDuelSession(currentInvitation.invitedByStudentId, currentInvitation.invitedByClassId, currentInvitation.invitedByName, currentInvitation.invitedByPhoto);
                    await database.ref(`invitations/${selectedStudent.studentId}`).remove();
                } catch (error) {
                    console.error("DÃ¼ello baÅŸlatÄ±lÄ±rken hata:", error);
                    showAlert('DÃ¼ello baÅŸlatÄ±lÄ±rken bir hata oluÅŸtu.');
                }
            }
        });

async function createDuelSession(inviterId, inviterClassId, inviterName, inviterPhoto) {
    const duelRef = database.ref('duels').push();
    
    // Her iki oyuncunun inDuel durumunu izleyen referanslarÄ± oluÅŸtur
    const inviterInDuelRef = database.ref(`classes/${inviterClassId}/students/${inviterId}/inDuel`);
    const invitedInDuelRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`);
    
    // BaÄŸlantÄ± kesildiÄŸinde inDuel durumlarÄ±nÄ± false yap
    inviterInDuelRef.onDisconnect().set(false);
    invitedInDuelRef.onDisconnect().set(false);

    await duelRef.set({
        inviter: {
            classId: inviterClassId,
            studentId: inviterId,
            name: inviterName,
            photo: inviterPhoto
        },
        invited: {
            classId: selectedStudent.classId,
            studentId: selectedStudent.studentId,
            name: selectedStudent.studentName,
            photo: (studentPhoto.src && studentPhoto.src !== "") ? studentPhoto.src : ""
        },
        selections: {
            class: "",
            subject: "",
            topic: ""
        },
        gameStarted: false,
        questions: []
    });

    // Ä°ki oyuncunun da inDuel durumunu true yap
    await inviterInDuelRef.set(true);
    await invitedInDuelRef.set(true);

    // BaÄŸlantÄ± kesildiÄŸinde dÃ¼elloyu sil
    duelRef.onDisconnect().remove();

    currentDuelRef = duelRef;
    isInviter = true;
    switchToDuelScreen(duelRef.key);
}

function switchToDuelScreen(duelKey) {
    // TÃ¼m ekranlarÄ± gizle
    mainScreen.style.display = 'none';
    singlePlayerScreen.style.display = 'none';
    singlePlayerGameScreen.style.display = 'none';
    friendsScreen.style.display = 'none';
    rankingPanel.classList.remove('open');
    playersOverlay.style.display = 'none';
    
    // DÃ¼ello ekranÄ±nÄ±n container'Ä±nÄ± dÃ¼zenle
    document.body.style.display = 'flex';
    document.body.style.justifyContent = 'center';
    document.body.style.alignItems = 'center';
    document.body.style.minHeight = '100vh';
    
    // DÃ¼ello ekranÄ±nÄ± gÃ¶ster
    duelSelectionScreen.style.display = 'flex';
    duelSelectionScreen.style.flexDirection = 'column';
    duelSelectionScreen.style.width = '100%';
    duelSelectionScreen.style.maxWidth = '900px';
    duelSelectionScreen.style.background = 'white';
    duelSelectionScreen.style.padding = '30px 40px';
    duelSelectionScreen.style.borderRadius = '20px';
    duelSelectionScreen.style.boxShadow = '0 15px 35px rgba(0, 0, 0, 0.2)';

    // Container sÄ±nÄ±fÄ±nÄ±n Ã¶zelliklerini ekle
    duelSelectionScreen.classList.add('container');

    // DÃ¼ello referansÄ±nÄ± al
    const duelRef = database.ref(`duels/${duelKey}`);
    
    // DÃ¼ello verilerini tutacak deÄŸiÅŸkenler
    let inviterId, inviterClassId, invitedId, invitedClassId;
    
    // Ä°lk veriyi bir kez Ã§ek ve deÄŸiÅŸkenleri sakla
    duelRef.once('value').then(initialSnap => {
        if (initialSnap.exists()) {
            const initialData = initialSnap.val();
            inviterId = initialData.inviter.studentId;
            inviterClassId = initialData.inviter.classId;
            invitedId = initialData.invited.studentId;
            invitedClassId = initialData.invited.classId;
        }
    });

    duelRef.onDisconnect().remove();

    // SÄ±nÄ±flarÄ± yÃ¼kle
    database.ref('championData/headings').once('value').then(snapshot => {
        duelClassSelect.innerHTML = '<option value="">SeÃ§iniz</option>';
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const classId = childSnapshot.key;
                const className = childSnapshot.val().name || 'No name';
                const option = document.createElement('option');
                option.value = classId;
                option.textContent = className;
                duelClassSelect.appendChild(option);
            });
        }
    }).catch(error => {
        console.error("SÄ±nÄ±f verileri yÃ¼klenirken hata:", error);
        showAlert('SÄ±nÄ±f verileri yÃ¼klenirken bir hata oluÅŸtu.');
    });

    duelRef.on('value', async (snap) => {
        if (snap.exists()) {
            const data = snap.val();
            duelInviterPhoto.src = data.inviter.photo || "https://via.placeholder.com/80";
            duelInviterName.textContent = data.inviter.name;
            duelInvitedPhoto.src = data.invited.photo || "https://via.placeholder.com/80";
            duelInvitedName.textContent = data.invited.name;

            // DÃ¼ello ayarlarÄ±nÄ± gÃ¼ncelle
            duelClassSelect.value = data.selections.class || "";
            duelSubjectSelect.value = data.selections.subject || "";
            duelTopicSelect.value = data.selections.topic || "";

            if (data.gameStarted && !duelGameStarted) {
                duelGameStarted = true;
                duelEnded = false;
                startDuelGame(data);
            }

            if (!isInviter) {
                duelClassSelect.disabled = true;
                duelSubjectSelect.disabled = true;
                duelTopicSelect.disabled = true;
                duelStartButton.disabled = true;
            } else {
                checkDuelSelections();
            }
        } else {
            if (!duelEnded) {
                try {
                    const currentPlayerId = selectedStudent.studentId;
                    
                    // BaÄŸlantÄ±sÄ± kopan oyuncuyu tespit et ve puanlarÄ± gÃ¼ncelle
                    if (currentPlayerId === inviterId) {
                        // Davet eden Ã§Ä±ktÄ±ysa misafir kazanÄ±r
                        await database.ref(`classes/${inviterClassId}/students/${inviterId}/gameCup`).transaction(current => (current || 0) + 6);
                        await database.ref(`classes/${invitedClassId}/students/${invitedId}/gameCup`).transaction(current => Math.max((current || 0) - 2, 0));
                        await showAlert('Rakibiniz ayrÄ±ldÄ±! KAZANDINIZ. (+6 ðŸ†)');
                    } else {
                        // Misafir Ã§Ä±ktÄ±ysa davet eden kazanÄ±r
                        await database.ref(`classes/${invitedClassId}/students/${invitedId}/gameCup`).transaction(current => (current || 0) + 3);
                        await database.ref(`classes/${inviterClassId}/students/${inviterId}/gameCup`).transaction(current => Math.max((current || 0) - 1, 0));
                        await showAlert('Rakibiniz ayrÄ±ldÄ±! KAZANDINIZ. (+6 ðŸ†)');
                    }

                    // inDuel durumlarÄ±nÄ± gÃ¼ncelle
                    await database.ref(`classes/${inviterClassId}/students/${inviterId}/inDuel`).set(false);
                    await database.ref(`classes/${invitedClassId}/students/${invitedId}/inDuel`).set(false);

                    // SayfayÄ± yenile
                    window.location.reload();

                } catch (error) {
                    console.error("Oyun sonlandÄ±rma hatasÄ±:", error);
                    await showAlert('Oyun sonlandÄ±rÄ±lÄ±rken bir hata oluÅŸtu');
                    window.location.reload();
                }
            }
        }
    });

    // MÃ¼zik baÅŸlatma
    const hiddenPlayButton = document.createElement('button');
    hiddenPlayButton.style.display = 'none';
    hiddenPlayButton.id = 'hiddenPlayButton';
    duelSelectionScreen.appendChild(hiddenPlayButton);

    hiddenPlayButton.addEventListener('click', () => {
        duelMusic.play().then(() => {
            duelMusic.loop = true;
        }).catch(error => {
            console.error("MÃ¼zik Ã§alÄ±namadÄ±:", error);
        });
    });

    setTimeout(() => {
        hiddenPlayButton.click();
    }, 1000);
}  

      function resetDuelGameState() {
            duelQuestionNumber.textContent = 'Soru 1/10';
            duelProgressBarInner.style.width = '0%';
            duelTimerElement.textContent = '45';
            duelTimerElement.style.color = '#ff0000';
            inviterCorrectCountEl.textContent = "0";
            invitedCorrectCountEl.textContent = "0";

            duelQuestions = [];
            duelCurrentQuestionIndex = 0;
            duelInviterScore = 0;
            duelInvitedScore = 0;
            clearInterval(duelTimer);
            duelQuestionLocked = false;
            duelGameStarted = false;
            duelEnded = true; // Duel bittiÄŸinde bayraÄŸÄ± ayarla

            // DÃ¼ello Oyun MÃ¼ziÄŸini Durdur
            duelMusic.pause();
            duelMusic.currentTime = 0;
        }

        duelClassSelect.addEventListener('change', () => {
            if (isInviter) {
                fetchLessons(duelClassSelect.value, duelSubjectSelect);
                updateDuelSelection('class', duelClassSelect.value);
            }
        });

        duelSubjectSelect.addEventListener('change', () => {
            if (isInviter) {
                fetchTopics(duelClassSelect.value, duelSubjectSelect.value, duelTopicSelect);
                updateDuelSelection('subject', duelSubjectSelect.value);
            }
        });

        duelTopicSelect.addEventListener('change', () => {
            if (isInviter) {
                updateDuelSelection('topic', duelTopicSelect.value);
            }
        });

        function updateDuelSelection(field, value) {
            currentDuelRef.child('selections').child(field).set(value);
            checkDuelSelections();
        }

        function checkDuelSelections() {
            if (isInviter) {
                const c = duelClassSelect.value;
                const s = duelSubjectSelect.value;
                const t = duelTopicSelect.value;
                if (c !== "" && s !== "" && t !== "") {
                    duelStartButton.classList.add('active');
                    duelStartButton.disabled = false;
                } else {
                    duelStartButton.classList.remove('active');
                    duelStartButton.disabled = true;
                }
            }
        }

        duelStartButton.addEventListener('click', async () => {
            duelClassId = duelClassSelect.value;
            duelSubjectId = duelSubjectSelect.value;
            duelTopicId = duelTopicSelect.value;

            const questionsRef = database.ref(`championData/headings/${duelClassId}/lessons/${duelSubjectId}/topics/${duelTopicId}/questions`);
            const snapshot = await questionsRef.once('value');
            if (snapshot.exists()) {
                const allQuestions = [];
                snapshot.forEach(cs => {
                    allQuestions.push(cs.val());
                });
                if (allQuestions.length < 10) {
                    showAlert('Bu konuya ait yeterli soru yok.');
                    return;
                }
                let chosen = shuffleArray(allQuestions).slice(0,10);
                chosen = chosen.map(q => {
                    let options = [
                        { text: q.correct, correct: true },
                        { text: q.wrong1, correct: false },
                        { text: q.wrong2, correct: false }
                    ];
                    let shuffled = shuffleArray(options);
                    return {
                        question: q.question,
                        options: shuffled
                    };
                });
                await currentDuelRef.child('questions').set(chosen);
                await currentDuelRef.child('gameStarted').set(true);
                showAlert("DÃ¼ello BaÅŸlatÄ±ldÄ±!");
            } else {
                showAlert("Bu konuya ait soru bulunamadÄ±.");
            }
        });

        function startDuelGame(data) {
            // DÃ¼ello baÅŸlarken final ekranÄ± ve skorlarÄ± resetleyelim
            duelFinalContainer.style.display='none';
            winnerMessage.textContent = '';

            duelSelectionScreen.style.display = 'none';
            duelGameScreen.style.display = 'flex';

            document.getElementById('duel-player-inviter-photo').src = data.inviter.photo ? data.inviter.photo : "https://via.placeholder.com/80";
            document.getElementById('duel-player-inviter-name').textContent = data.inviter.name;
            document.getElementById('duel-player-invited-photo').src = data.invited.photo ? data.invited.photo : "https://via.placeholder.com/80";
            document.getElementById('duel-player-invited-name').textContent = data.invited.name;

            duelInviterScore = 0;
            duelInvitedScore = 0;
            inviterCorrectCountEl.textContent = "0";
            invitedCorrectCountEl.textContent = "0";

            duelCurrentQuestionIndex = 0;
            if (data.questions) {
                duelQuestions = data.questions;
                loadDuelQuestion();
            }

            listenToResponses();

            // DÃ¼ello oyunu baÅŸladÄ±ÄŸÄ±nda arka plan mÃ¼ziÄŸini Ã§al
            duelMusic.currentTime = 0;
            duelMusic.play().then(() => {
                duelMusic.loop = true;
            }).catch(error => {
                console.error("MÃ¼zik Ã§alÄ±namadÄ±:", error);
            });
        }

        function loadDuelQuestion() {
            if (duelCurrentQuestionIndex >= 10) {
                endDuelGame();
                return;
            }
            duelQuestionLocked = false;
            const currentQuestion = duelQuestions[duelCurrentQuestionIndex];
            duelQuestionNumber.textContent = `Soru ${duelCurrentQuestionIndex + 1}/10`;
            const progressPercentage = ((duelCurrentQuestionIndex) / 10) * 100;
            duelProgressBarInner.style.width = `${progressPercentage}%`;

            if (currentQuestion.question.startsWith('http')) {
                duelQuestionImage.src = currentQuestion.question;
                duelQuestionImage.style.display = 'block';
                duelQuestionText.textContent = '';
            } else {
                duelQuestionImage.style.display = 'none';
                duelQuestionText.textContent = currentQuestion.question;
            }

            duelOptionsContainer.innerHTML = '';
            currentQuestion.options.forEach((option, idx) => {
                const button = document.createElement('button');
                button.classList.add('option-button');
                button.textContent = option.text;
                button.dataset.correct = option.correct;
                button.dataset.optionIndex = idx;
                button.addEventListener('click', duelSelectOption);
                duelOptionsContainer.appendChild(button);
            });

            resetDuelTimer();
            startDuelTimer();
            currentDuelRef.child('responses').child(duelCurrentQuestionIndex).remove();
        }

        function resetDuelTimer() {
            clearInterval(duelTimer);
            duelTimeLeft = 45;
            duelTimerElement.textContent = duelTimeLeft;
            duelTimerElement.style.color = '#ff0000';
        }

        function startDuelTimer() {
            duelTimer = setInterval(() => {
                duelTimeLeft--;
                duelTimerElement.textContent = duelTimeLeft;

                if (duelTimeLeft <= 0 && !duelQuestionLocked) {
                    clearInterval(duelTimer);
                    duelQuestionLocked = true;
                    revealDuelAnswerAfterTimeout();
                }
            }, 1000);
        }

        function duelSelectOption(e) {
            if (duelQuestionLocked) return;
            const selectedButton = e.target;
            const chosenOptionText = selectedButton.textContent;
            const isCorrect = selectedButton.dataset.correct === 'true';
            const playerId = selectedStudent.studentId;

            duelOptionsContainer.querySelectorAll('.option-button').forEach(b => {
                b.disabled = true;
                if (b !== selectedButton) {
                    b.classList.add('option-faded');
                } else {
                    b.classList.add('option-chosen');
                }
            });

            currentDuelRef.child('responses').child(duelCurrentQuestionIndex).child(playerId).set({
                chosen: chosenOptionText,
                correct: isCorrect
            });
        }

        function listenToResponses() {
            currentDuelRef.child('responses').on('value', snap => {
                if (snap.exists()) {
                    const data = snap.val();
                    currentDuelRef.once('value', dsnap => {
                        const ddata = dsnap.val();
                        const invId = ddata.inviter.studentId;
                        const inId = ddata.invited.studentId;

                        const answeredCount = Object.keys(data[duelCurrentQuestionIndex] || {}).length;
                        if (answeredCount === 2 && !duelQuestionLocked) {
                            duelQuestionLocked = true;
                            clearInterval(duelTimer);
                            revealDuelAnswerAfterTimeout();
                        }
                    });
                }
            });
        }

        // Yeni +1 Efekti Fonksiyonu
        function showScoreIncrementEffect(scoreElement) {
            const plusOne = document.createElement('div');
            plusOne.classList.add('animated-plus-one');
            plusOne.textContent = '+1';
            document.body.appendChild(plusOne);

            // Get center position
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            // Get the scoreElement's position
            const rect = scoreElement.getBoundingClientRect();
            const targetX = rect.left + rect.width / 2;
            const targetY = rect.top + rect.height / 2;

            // Calculate translation
            const deltaX = targetX - centerX;
            const deltaY = targetY - centerY;

            // Animate
            plusOne.animate([
                { transform: `translate(-50%, -50%) translate(0px, 0px) scale(1)`, opacity: 1 },
                { transform: `translate(-50%, -50%) translate(${deltaX}px, ${deltaY}px) scale(0.5)`, opacity: 0 }
            ], {
                duration: 1000,
                easing: 'ease-out'
            });

            // Remove the element after animation
            setTimeout(() => {
                plusOne.remove();
            }, 1000);
        }

        function revealDuelAnswerAfterTimeout() {
            setTimeout(() => {
                revealDuelAnswer();
            }, 500);
        }

        function revealDuelAnswer() {
            currentDuelRef.child('responses').child(duelCurrentQuestionIndex).once('value').then(resSnap => {
                const responses = resSnap.val() || {};
                currentDuelRef.once('value').then(dSnap => {
                    const ddata = dSnap.val();
                    const invId = ddata.inviter.studentId;
                    const inId = ddata.invited.studentId;

                    const optionButtons = duelOptionsContainer.querySelectorAll('.option-button');
                    optionButtons.forEach(btn => {
                        if (btn.dataset.correct === 'true') {
                            btn.classList.add('correct');
                        } else {
                            btn.classList.add('wrong');
                        }
                    });

                    let inviterOldScore = duelInviterScore;
                    let invitedOldScore = duelInvitedScore;

                    if (responses[invId] && responses[invId].correct) duelInviterScore++;
                    if (responses[inId] && responses[inId].correct) duelInvitedScore++;

                    if (duelInviterScore > inviterOldScore) {
                        inviterCorrectCountEl.textContent = duelInviterScore;
                        inviterCorrectCountEl.classList.add('score-flash');
                        showScoreIncrementEffect(inviterCorrectCountEl);
                        setTimeout(()=>inviterCorrectCountEl.classList.remove('score-flash'),1000);
                    }

                    if (duelInvitedScore > invitedOldScore) {
                        invitedCorrectCountEl.textContent = duelInvitedScore;
                        invitedCorrectCountEl.classList.add('score-flash');
                        showScoreIncrementEffect(invitedCorrectCountEl);
                        setTimeout(()=>invitedCorrectCountEl.classList.remove('score-flash'),1000);
                    }

                    setTimeout(() => {
                        duelCurrentQuestionIndex++;
                        loadDuelQuestion();
                    }, 1500);
                });
            });
        }

function endDuelGame() {
    currentDuelRef.off('value');
    currentDuelRef.child('responses').off('value');

    let message = '';
    let winnerId = null;
    let loserId = null;
    let winnerClassId = null;
    let loserClassId = null;

    currentDuelRef.once('value').then(async (dSnap) => {
        const ddata = dSnap.val();

        if (duelInviterScore > duelInvitedScore) {
            message = `Kazanan: ${ddata.inviter.name}`;
            winnerId = ddata.inviter.studentId;
            winnerClassId = ddata.inviter.classId;
            loserId = ddata.invited.studentId;
            loserClassId = ddata.invited.classId;
        } else if (duelInvitedScore > duelInviterScore) {
            message = `Kazanan: ${ddata.invited.name}`;
            winnerId = ddata.invited.studentId;
            winnerClassId = ddata.invited.classId;
            loserId = ddata.inviter.studentId;
            loserClassId = ddata.inviter.classId;
        } else {
            message = "Berabere KaldÄ±nÄ±z!";
        }

        if (winnerId && loserId) {
            // KazananÄ±n puanÄ±nÄ± +6, kaybedenin puanÄ±nÄ± -2
            const winnerRef = database.ref(`classes/${winnerClassId}/students/${winnerId}/gameCup`);
            await winnerRef.transaction(current => {
                return (current || 0) + 3;
            });

            const loserRef = database.ref(`classes/${loserClassId}/students/${loserId}/gameCup`);
            await loserRef.transaction(current => {
                return Math.max((current || 0) - 1, 0);
            });

            if (selectedStudent.studentId === winnerId || selectedStudent.studentId === loserId) {
                fetchAndDisplayGameCup();
            }
        }

        duelQuestionNumber.style.display = 'none';
        document.querySelector('#duel-game-screen .progress-container').style.display = 'none';
        document.querySelector('#duel-game-screen .timer-container').style.display = 'none';
        document.querySelector('#duel-game-screen .question-container').style.display = 'none';
        duelOptionsContainer.style.display = 'none';

        winnerMessage.textContent = message;
        duelFinalContainer.style.display = 'flex';

        if (message.startsWith('Kazanan') || message === "Berabere KaldÄ±nÄ±z!") {
            winnerMusic.currentTime = 0;
            winnerMusic.play().catch(error => {
                console.error("Kazanan mÃ¼ziÄŸi Ã§alÄ±namadÄ±:", error);
            });
        }

        duelMusic.pause();
        duelMusic.currentTime = 0;

        duelEnded = true;
    });
}

        // Fetch and display gameCup for the logged-in student
        function fetchAndDisplayGameCup() {
            database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    document.getElementById('game-cup-score').textContent = snapshot.val();
                } else {
                    // Initialize gameCup to 0
                    database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`).set(0);
                    document.getElementById('game-cup-score').textContent = '0';
                }
            }).catch(error => {
                console.error("gameCup Ã§ekilirken hata:", error);
                document.getElementById('game-cup-score').textContent = '0';
            });
        }

        async function loadRanking() {
            rankingTableBody.innerHTML = ''; // Temizle

            // TÃ¼m Ã¶ÄŸrencileri Ã§ek ve sÄ±ralama yap
            const snapshot = await database.ref('classes').once('value');
            let players = [];

            if (snapshot.exists()) {
                snapshot.forEach(classSnapshot => {
                    const classId = classSnapshot.key;
                    const className = classSnapshot.val().name ? classSnapshot.val().name : classId;
                    const studentsSnapshot = classSnapshot.child('students');
                    if (studentsSnapshot.exists()) {
                        studentsSnapshot.forEach(studentSnapshot => {
                            const studentId = studentSnapshot.key;
                            const studentData = studentSnapshot.val();
                            const gameCup = studentData.gameCup || 0;
                            const photo = studentData.photo || 'https://via.placeholder.com/50';
                            players.push({
                                name: studentData.name || 'Anonim',
                                className: className,
                                gameCup: gameCup,
                                photo: photo
                            });
                        });
                    }
                });

                // Oyun kupasÄ±na gÃ¶re sÄ±rala (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
                players.sort((a, b) => b.gameCup - a.gameCup);

                // Ä°lk 25 oyuncuyu al
                const topPlayers = players.slice(0, 25);

                topPlayers.forEach((player, index) => {
                    const tr = document.createElement('tr');
                    // Rank
                    const rankTd = document.createElement('td');
                    rankTd.textContent = index + 1;
                    tr.appendChild(rankTd);

                    // FotoÄŸraf
                    const photoTd = document.createElement('td');
                    const img = document.createElement('img');
                    img.src = player.photo;
                    img.alt = `${player.name} FotoÄŸrafÄ±`;
                    img.className = 'ranking-player-photo';
                    photoTd.appendChild(img);
                    tr.appendChild(photoTd);

                    // Ä°sim
                    const nameTd = document.createElement('td');
                    nameTd.textContent = player.name;
                    tr.appendChild(nameTd);

                    // SÄ±nÄ±f
                    const classTd = document.createElement('td');
                    classTd.textContent = player.className;
                    tr.appendChild(classTd);

                    // Kupa Skoru
                    const scoreTd = document.createElement('td');
                    scoreTd.textContent = player.gameCup;
                    tr.appendChild(scoreTd);

                    // Top 3 iÃ§in Ã¶zel sÄ±nÄ±flar ekle
                    if (index === 0) {
                        tr.classList.add('top-1');
                    } else if (index === 1) {
                        tr.classList.add('top-2');
                    } else if (index === 2) {
                        tr.classList.add('top-3');
                    }

                    rankingTableBody.appendChild(tr);
                });
            } else {
                rankingTableBody.innerHTML = '<tr><td colspan="5">HenÃ¼z sÄ±ralama yapÄ±lmadÄ±.</td></tr>';
            }
        }
    </script>

    <script>
        // Ensure the script runs after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            const kupaSiralamaButton = document.getElementById('kupa-siralama-button');
            const rankingBackButton = document.getElementById('rankingBackButton');
            const rankingPanel = document.getElementById('rankingPanel');

            // Hide the ranking panel initially
            rankingPanel.style.display = 'none';

            // Show the ranking panel when the button is clicked
            if (kupaSiralamaButton) {
                kupaSiralamaButton.addEventListener('click', () => {
                    rankingPanel.style.display = 'flex';
                });
            }

            // Hide the ranking panel when the back button is clicked
            if (rankingBackButton) {
                rankingBackButton.addEventListener('click', () => {
                    rankingPanel.style.display = 'none';
                });
            }
        });
    </script>
    </body>
    
</html>
